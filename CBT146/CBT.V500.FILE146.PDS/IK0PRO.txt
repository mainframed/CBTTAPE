*COPY                                                 IK0PRO
         TITLE 'SERVER Routine - performs Server mode functions'
SERVER   ENTER
         LA    0,SRVKFIN                                       @SC86295
         L     1,=A(SRVKCMD)                                   @SC87012
         BAL   14,LOOPS      Set up command loop               @SC86295
         KCALL INTINI,1,E=SRVXIT Initialize for server         @SC87300
         OI    FL2,SRV               Server is on
         MVI   ERRNUM,ERRNOE No errors yet                     @SC86156
         BAL   8,SRVLUP      Set state table                   @SC86135
* Server mode Rpack interpret input table                      @SC86135
         DC    AL1(AS),AL3(SRVREC)  Micro wants to send a file @SC86135
         DC    AL1(AC),AL3(SRVHST)  A host command             @SC86171
         DC    AL1(AI),AL3(0)       Micro sent parms           @SC86135
         DC    AL1(AG),AL3(SRVGEN)  A generic command          @SC86135
         DC    AL1(AK),AL3(SRVKRM)  A KERMIT command           @SC86158
         DC    AL1(AR),AL3(SRVSND)  Micro wants to get a file  @SC86135
         DC    AL1(00),AL3(SRVILL)  Error routine              @SC86355
SRVLUP   MVI   SEQ,0         Reset packet number               @SC86135
         OI    FL1,NAK0              Resend NAK during retry
         MVC   SRVTIM,TIMOUT Save time-out limit               @SC86355
         MVI   TIMOUT,120    Set to 2 minutes                  @SC86355
         MVC   LIMTRY,F5     Error loop 5 times for command    @SC86355
         MVC   OLDERR,ERRNUM Save for STATUS                   @SC86158
         BAL   9,INPUT       Read a packet and interpret       @SC86295
         MVC   TIMOUT,SRVTIM Restore timeout setting           @SC86355
         KCALL SPARSET       Set up for exchange               @SC86152
         KCALL SPAR          Interpret I packet from other
         KCALL RPAR          Reply to the I packet
         BAL   2,SENDACKL            Send an ACK, length set
         MVI   ERRNUM,ERRNOE OK                                @SC86158
         B     SRVLUP        Loop again no matter what
*
SRVREC   MVC   TIMOUT,SRVTIM Restore timeout setting           @SC86355
         XC    SCANPTR,SCANPTR                                 @SC86295
         LA    0,FFRCF                                         @SC86295
         KCALL FSPEC,FILNAM  Get filespec                      @SC86295
         KCALL INTINI,3,E=SRVXIT                               @SC87300
         KCALL RECEIV        Get the file
         B     SRVLUP                End of file protocol
*
SRVSND   MVC   TIMOUT,SRVTIM Restore timeout setting           @SC86355
         BAL   9,DECODEN     Decode the file name              @SC86295
         ICM   0,B'1111',WBUFL       decoded name length
         BNP   SRVIPS                                          @SC86158
         L     1,WBUF                Decoded data
SRVSNT   STM   0,1,SCANPTR                                     @SC86295
         LA    0,FFSND                                         @SC86295
         KCALL FSPEC,IFILE,E=SRVERP   Get filespec             @SC86295
         XC    SCANPTR,SCANPTR                                 @SC86295
         LA    0,FFSND+FFRCF                                   @SC86295
         KCALL FSPEC,JFSPEC,E=SRVERP  Get filespec             @SC86295
SRVSNC   KCALL SEND
         B     SRVLUP                Go around again
*
SRVGEN   MVC   TIMOUT,SRVTIM Restore timeout setting           @SC86355
         BAL   9,DECODEN     Decode the command                @SC86295
         ICM   0,15,WBUFL    Decoded command length            @SC86158
         BNP   SRVIPS                                          @SC86158
         MVI   ERRNUM,ERRNOE OK so far                         @SC86171
         BCTR  0,0           Remove command from data length   @SC86158
         L     1,WBUF        Decoded data                      @SC86158
         IC    4,0(1)                                          @SC86158
         BAL   2,CLKP        Dispatch on command               @SC86158
         DC    AL1(AC),AL3(SRVCWD)  cwd                        @SC86158
         DC    AL1(AD),AL3(SRVDIR)  directory                  @SC86158
         DC    AL1(AE),AL3(SRVDEL)  erase                      @SC86158
         DC    AL1(AF),AL3(SRVFIN)  finish                     @SC86158
         DC    AL1(AH),AL3(SRVHLP)  help                       @SC86158
         DC    AL1(AK),AL3(SRVCPY)  copy                       @SC86158
         DC    AL1(AL),AL3(SRVFIN)  bye                        @SC86158
         DC    AL1(AR),AL3(SRVREN)  rename                     @SC86158
         DC    AL1(AT),AL3(SRVTYP)  type                       @SC86158
         DC    AL1(AU),AL3(SRVQDS)  space                      @SC86158
         DC    AL1(00),AL3(SRVERS)  Unknown command            @SC86158
*
SRVILL   MVC   TIMOUT,SRVTIM Restore timeout setting           @SC86355
SRVERS   MVI   ERRNUM,ERRUSC Unknown Server command            @SC86156
SRVERP   KCALL SUPFNC,5                                        @SC86158
         KCALL ERPACK        Send an error packet              @SC86158
         L     0,IOERC       I/O error count                   @SC86158
         CL    0,F5          Lots of consecutive errors?       @SC86158
         BL    SRVLUP        Not yet, OK                       @SC86158
         B     SRVXIT        Yes, give up now                  @SC86158
*
SRVIPS   MVI   ERRNUM,ERRIPS Invalid syntax                    @SC86158
         B     SRVERP                                          @SC86158
*
SRVHST   MVC   TIMOUT,SRVTIM Restore timeout setting           @SC86355
         BAL   9,DECODEN     Get command for host              @SC86171
         BAL   9,SRVGPRW     To EBCDIC, start interception     @SC86295
         B     LUPHST        Do it                             @SC86295
*
SRVKRM   MVC   TIMOUT,SRVTIM Restore timeout setting           @SC86355
         BAL   9,DECODEN     Get command for Kermit            @SC86295
         BAL   9,SRVGPRW     To EBCDIC, start interception     @SC86295
         B     LUPTOK        Parse command                     @SC87012
*
SRVKF0   MVI   ERRNUM,ERRNOE No errors                         @SC86295
SRVKFIN  MVC   OLDERR,ERRNUM Save error code                   @SC86295
         KCALL SUPFNC,2      Clean up after interception       @SC86295
SRVKFTX  LM    4,5,TXTPTR                                      @SC86158
         SR    5,4           Any?                              @SC86158
         LA    2,SRVLUP      Return adr                        @SC86158
         BNP   SENDACK       No, just ACK command              @SC86158
         LA    3,1023(5)     Round up                          @SC86158
         SRA   3,10          Convert to kbytes                 @SC86158
         ST    3,KBYTES                                        @SC86158
         OI    FL4,SFM+TXT                                     @SC86158
         KCALL SEND          Send all                          @SC86158
         CLI   ERRNUM,ERRNOE Problem with SEND?                @SC86295
         BNE   SRVLUP        Yes, remember that                @SC86295
         MVC   ERRNUM,OLDERR No, use code from commands        @SC86295
         B     SRVLUP        Get another command               @SC86158
*
SRVTYP   OI    FL4,TXT       Send disk file to remote display  @SC86158
         BAL   9,SRVGSTR     Get file-spec                     @SC86295
          B    SRVERP        None, error                       @SC86158
         B     SRVSNT                                          @SC86158
*
*        Send remote help message to other system              @SC86158
SRVHLP   LA    4,RMHTXT      Where to copy HELP TEXT from      @SC86158
         LA    5,RMHTXTZ     End of text                       @SC86158
         STM   4,5,TXTPTR                                      @SC86158
         B     SRVKFTX                                         @SC86158
*
SRVDIR   BAL   3,SRVUTL                                        @SC86295
         DC    AL1(13,4+1)   Wild matches                      @SC86295
*
SRVDEL   BAL   3,SRVUTL                                        @SC86295
         DC    AL1(14,0+1)   No wild matches                   @SC86295
*
SRVREN   BAL   3,SRVUTL                                        @SC86295
         DC    AL1(15,4+2)   Wild matches                      @SC86295
*
SRVCPY   BAL   3,SRVUTL                                        @SC86295
         DC    AL1(16,0+2)   No wild matches                   @SC86295
*
SRVCWD   BAL   9,SRVGSTR     Get operand                       @SC86295
          B    SRVERP                                          @SC86158
         BAL   9,SRVGPRM     Convert to plist                  @SC86295
         MVI   ERRNUM,ERRFNF In case of error                  @SC86158
         KCALL CWDSET,E=SRVERP                                 @SC86158
         B     SRVKF0        No errors                         @SC86295
*
SRVQDS   BAL   9,SRVGSTR     Extract letter                    @SC86295
          LA   0,0           None, use default                 @SC86158
         BAL   9,SRVGPRM                                       @SC86295
         B     LUPSPA                                          @SC86295
* Generate command PLIST: R3-> parms                           @SC86158
SRVUTL   LA    2,FILNAM      1st or only filespec              @SC86295
         LH    4,0(3)                                          @SC86295
         N     4,F3          Get number of names               @SC86295
SRVUTLP  XC    SCANPTR,SCANPTR                                 @SC86295
         BAL   9,SRVGSTR     Extract file-spec                 @SC86295
          B    SRVUT1        None, check if wildcard allowed   @SC86158
         STM   0,1,SCANPTR                                     @SC86295
SRVUT1   LA    0,FFUTL                                         @SC86295
         TM    1(3),4        Test flag                         @SC86295
         BZ    *+8                                             @SC86295
         LA    0,FFUTL+FFWLD Wild match if part omitted        @SC86295
         KCALL FSPEC,(2),E=SRVERP  Get filespec into command   @SC86295
         LR    0,6           Length remaining                  @SC86158
         LR    1,7           Next field                        @SC86158
         LA    2,IFILE       2nd ptr                           @SC86158
         BCT   4,SRVUTLP     Loop over file-specs              @SC86158
         KCALL SUPFNC,1      Start interception                @SC86158
         CLC   0(1,3),SRVDIR+4                                 @SC86158
         BE    SRVUT6        Don't issue STATE if DIR cmd      @SC86158
         MVI   ERRNUM,ERRFNF Assume not found                  @SC86158
         OPENF T,FILNAM,E=SRVERP                               @SC86295
SRVUT6   LA    1,FILNAM      1st or only filespec              @SC86295
         LA    2,IFILE       Possible 2nd                      @SC86295
         XR    0,0                                             @SC86295
         IC    0,0(3)                                          @SC86295
         KCALL DISKIO                                          @SC86295
         CLI   ERRNUM,ERRNOE Problem?                          @SC86295
         BNE   SRVERP        Yes, too bad                      @SC86295
         B     SRVKFIN                                         @SC86295
* Get substring from Generic command                           @SC86158
* R0= no. of chars left in packet excluding substr count byte  @SC86158
* R1-> one before count byte                                   @SC86158
SRVGSTR  MVI   ERRNUM,ERRMOP Assume missing operand            @SC86158
         BCTR  0,0           Remove operand length field       @SC86158
         LA    7,1(1)        ditto                             @SC86158
         LTR   6,0           If no operands                    @SC86158
         BNPR  9              then return error                @SC86295
         UNCHR 0,1(1)        Operand size                      @SC86158
         BZR   9             Error if zero length field        @SC86295
         BM    SRVIPS        Really bad                        @SC86158
         LA    1,2(1)        Location of operand               @SC86158
         AR    7,0           Get ptr to next field             @SC86158
         SR    6,0           Length remaining                  @SC86158
         BM    SRVIPS        Inconsistant                      @SC86158
         B     4(9)                                            @SC86295
* Set up copy
SRVGPRW  ICM   0,15,WBUFL                                      @SC86171
         BNP   SRVIPS        No text                           @SC86171
         L     1,WBUF        Ptr to text                       @SC86171
* Copy parameter at (R1), length in R0 and set up interception @SC86158
SRVGPRM  LTR   15,0          Any chars?                        @SC86171
         BNP   SRVGPS        No                                @SC86171
         BCTR  15,0          Yes, translate                    @SC86171
         EX    15,TRATOE                                       @SC86171
         EX    15,TRUPCAS                                      @SC86171
SRVGPS   STM   0,1,SCANPTR   Save string ptrs                  @SC86158
         KCALL SUPFNC,1      Start intercepting                @SC86158
         BR    9                                               @SC86295
*
SRVFIN   MVI   WRRD,0                Just write (no read) when ending
         MVC   S1HND,SVHND   Always use requested handshake    @SC87343
         BAL   2,SENDACK             Send an ACK
         L     1,WBUF        Ptr to decoded data               @SC86190
         CLI   0(1),AL                                         @SC86190
         BNE   SRVNOLOG      Skip logging out                  @SC86295
         CLOSF LOGPTR        Close debug-log                   @SC86135
         KCALL SUPFNC,8      Log out                           @SC86295
SRVNOLOG DS    0H            (or fall through just in case)    @SC86295
         MVC   ERRNUM,OLDERR Copy back error number            @SC86171
SRVXIT   NI    FL2,255-SRV   Turn off SERVER mode              @SC86158
         KCALL INTINI,0      Clear interrupt trapping
         RET
*
RMHTXT   DC    C'Kermit-&KSYS. Server handles the following:'  @SC86268
         DC    X'1515'                                         @SC86158
         DC C'Function          Standard command',X'15'        @SC86158
         DC C'--------          ----------------',X'1515'      @SC86158
         DC C'Send a file       SEND file',X'15'               @SC86158
         DC C'Retrieve a file   GET file',X'15'                @SC86158
         DC C'Log off system    BYE or LOGOUT',X'15'           @SC86158
         DC C'Exit from server  FINISH',X'15'                  @SC86158
         DC C'Issue Kermit cmd  REMOTE KERMIT cmd',X'15'       @SC86158
         DC C'Issue system cmd  REMOTE HOST Â¢CP| cmd',X'15'    @SC86268
         DC C'List directory    REMOTE DIRECTORY file',X'15'   @SC86158
         DC C'Type a file       REMOTE TYPE file',X'15'        @SC86158
         DC C'Copy a file       REMOTE COPY f1 f2',X'15'       @SC86158
         DC C'Rename a file     REMOTE RENAME f1 f2',X'15'     @SC86158
         DC C'Erase a file      REMOTE DELETE file',X'15'      @SC86158
         DC C'Change disk area  REMOTE CWD area',X'15'         @SC86158
         DC C'Show disk space   REMOTE SPACE area',X'15'       @SC86158
RMHTXTZ  EQU   *                                               @SC86158
         LOCALS ,                                              @SC86295
RETADR   DS    A             Return adr if no more TAKE stuff  @SC86295
CMDPTR   DS    A             Adr of command table              @SC86295
TAKLEV   DS    F             Take file level                   @SC86121
TAKTAB   DS    (TAKMAX)F     Tickets for I/O                   @SC86295
SRVTIM   DS    X             Saved timeout limit               @SC86355
SERVER   EXIT
         TITLE 'SEND Routine - sends a file'
* Send file(s) and set ERRNUM appropriately
* Entry: filespec pattern in IFILE
SEND     ENTER
         XC    TOUTOT(LSTATS),TOUTOT Clear statistics          @SC86295
         KCALL SUPFNC,10                                       @SC86295
         ST    15,SECTOT     Save start time                   @SC86295
         TM    FL4,SFM                                         @SC86295
         BO    *+10          From memory: keep old file list   @SC86295
         XC    NSENT,NSENT           Number of files sent
         MVI   SNFLG,FIRST   Haven't started yet               @SC86295
         XC    FDATE,FDATE   Clear file date                   @SC86295
         LA    0,30          Tune up after 30 packets          @SC86345
         STH   0,SNPKCT                                        @SC86345
         MVI   REASON,0      Not rejected yet                  @SC86316
         MVI   SEQ,0         Reset packet number               @SC86135
       NXTFSET IFILE,E=SNDNON Init for NXTFST call             @SC87012
         BAL   8,SNDNXT      Set state table                   @SC86135
* Send mode Rpack interpret input table                        @SC86135
SNDNST   DC    AL1(AY),AL3(0)        Micro ACK'd               @SC86295
         DC    AL1(00),AL3(SNDABR)   Error routine             @SC86135
SNDNXT   CLI   CXZ,AZ
         BE    SNDBRK        Stop file group send
         MVI   FRECF,C'F'    Just in case                      @SC86151
         TM    FL4,SFM                                         @SC86158
         BO    SNDNOW        Just sending from memory          @SC86158
         NXTF  E=SNDNON      Get next/first file               @SC86295
         MVI   CXZ,0                 In case aborted last file
         MVI   REASON,0      Not rejected yet                  @SC86316
         L     5,TSENT               TABLE W/FILES SENT SO FAR
         ICM   4,B'1111',NSENT       Number of files sent so far
         AIF   ('&KSYS' NE 'CMS').SOPN                         @SC86295
         BZ    SNDOPN        Go if none sent yet               @SC86295
SNDTBL   CLC   0(16,5),FILNAM                                  @SC86295
         BE    SNDNXT                Go if sent already
         LA    5,LFID(5)     Next file                         @SC86295
         BCT   4,SNDTBL
.SOPN    ANOP
SNDOPN   OPENF I,FILNAM,FILFDB,FILPTR,E=SNDFNF                 @SC87012
         USING FDBD,1                                          @SC86295
         MVC   FRECF,FDBRCF  Save format and file size         @SC86295
         MVC   KBYTES,FDBSIZE                                  @SC86295
         MVC   FDATE,FDBDATE Save file date                    @SC86295
         DROP  1                                               @SC86295
         CLI   TRMLIN,C' '   Alt. line?                        @SC87300
         BE    SNDNOW        No, be quiet                      @SC87300
         MVC   CMD(8),=CL8'Sending '  Yes, display message     @SC87300
         LA    7,CMD+8                                         @SC87300
         LA    1,FILNAM                                        @SC87300
         BAL   2,STAFSP      Format name and show it           @SC87300
SNDNOW   TM    SNFLG,FIRST                                     @SC86295
         BZ    SNDFIL                Go if not first file
         NI    SNFLG,255-FIRST No first file flag              @SC86295
         MVC   LIMTRY,MAXTNT Limit for INIT retries            @SC86345
         TM    FL4,NPS       Non-protocol?                     @HF86232
         BZ    SNDPRO        No, normal send message           @HF86232
         KCALL INTINI,5,E=SNDRET  Initialize for non-protocol  @SC87300
         B     SNDATZ        Skip protocol stuff               @HF86232
SNDPRO   KCALL INTINI,2,E=SNDRET  Initialize for send          @SC87300
         TM    FL2,SRV
         BO    SNDINI                Go if Server mode
         L     0,LCLDLY      Time to wait                      @SC86164
         KCALL SUPFNC,9                                        @SC86295
SNDINI   DS    0H                                              @SC86152
         KCALL RPARSET       Set up for exchange               @SC86152
         KCALL RPAR          Our S packet to send              @SC86152
         MVI   STYPE,AS              PACKET TYPE = SEND INITIATE
         BAL   9,INPUTSPK    Send RPAR and Interpret response  @SC86295
         KCALL SPAR          Interpret reply to our S packet
         MVC   BCTU,BCTR             Switch chksum to negotiated one
         MVC   LIMTRY,MAXTRY Reset limit                       @SC86164
         BAL   14,INCRSEQ
SNDFIL   MVI   STYPE,AX      Text transmission?                @SC86158
         TM    FL4,TXT                                         @SC86158
         BO    *+8           Yes                               @SC86158
         MVI   STYPE,AF      Packet type = file header         @SC86158
         XC    DATL,DATL     Null file spec.                   @SC86158
         TM    FL4,SFM                                         @SC86158
         BNZ   SNDCNTH       From memory, no file name         @SC86158
         BAL   9,PAKFIL      Compress to buffer with appends   @HF86223
         CLI   TRMLIN,C' '   Alt. line?                        @SC87300
         BE    SNDFIL2       No, be quiet                      @SC87300
         MVC   CMD(5),=CL5'  as '  Yes, display message        @SC87300
         L     1,RBUF        Ptr to name in ASCII              @SC87300
         MVC   CMD+5(250),0(1)                                 @SC87300
         TR    CMD+5(250),ATOE Back to EBCDIC                  @SC87300
         LA    0,CMD+5(7)    End of msg + name                 @SC87300
         BAL   2,STAPMSG     Show sending name                 @SC87300
SNDFIL2  DS    0H                                              @SC87300
         L     3,NSENT               Number of files sent so far
         LR    4,3                   Ditto
         C     3,=A(MAXNSENT) Did we send more than countable? @SC86135
         BNL   SNDCNT                Yes, cannot keep track of 'em
         MH    3,=Y(LFID)    Times length of items             @SC86295
         A     3,TSENT               Loc in sent-table
         MVC   0(LFID,3),FILNAM Save fn ft sent                @SC86295
         LA    4,1(4)                Incr number of sent files
         ST    4,NSENT               Keep it
SNDCNT   BAL   9,ENCODEN     Encode fn                         @SC86295
SNDCNTH  BAL   9,INPUTSPK    Send name and interpret response  @SC86295
         BAL   14,INCRSEQ
         MVC   TMP,SCAPA     Copy my flags                     @SC86149
         NI    TMP,8         Attributes                        @SC86149
         NC    TMP,RCAPA     Check if both on                  @SC86149
         BZ    SNDATZ        No, skip it                       @SC86149
         L     5,ASDATA                                        @SC86295
         ICM   4,15,KBYTES   File length known?                @SC86295
         BZ    SNDAT0        No, skip it                       @SC86316
         MVI   0(5),C'!'     Yes                               @SC86295
         LA    15,2(5)                                         @SC86295
         BAL   2,EDDEC       Format it                         @SC86295
         SR    15,5                                            @SC86295
         IC    4,ATOE+ABL-2(15) Indicate number of digits      @SC86295
         STC   4,1(5)                                          @SC86295
         AR    5,15          End of string                     @SC86295
SNDAT0   MVC   0(L'SYSATR,5),SYSATR                            @SC86316
         LA    5,L'SYSATR(5) System code                       @SC86295
         MVC   0(3,5),=C'"!B' Say it's binary                  @SC86316
         TM    FL1,BINF      Binary file?                      @SC86149
         BO    SNDAT1        Yes                               @SC86316
         MVC   2(4,5),=C'A*!A'  No, also say it's ASCII        @SC86316
         LA    5,3(5)        Advance over extra item           @SC86316
SNDAT1   LA    5,3(5)                                          @SC86316
         IC    4,TYPFIL      Specific file type                @SC86295
         BAL   2,CLKP        Dispatch via table                @SC86295
         DC    C'T',AL3(SNDATT)  Text                          @SC86295
         DC    C'D',AL3(SNDATD)  D-binary                      @SC86295
         DC    C'V',AL3(SNDATV)  V-binary                      @SC86295
         DC    X'0',AL3(SNDAT3)  Must be Binary                @SC86295
SNDATT   BAL   2,SNDAT2                                        @SC86295
         DC    AL1(3),C'AMJ' Format is delimited               @SC86295
SNDATD   BAL   2,SNDAT2                                        @SC86295
         DC    AL1(2),C'D%'  Format is undelimited             @SC86316
SNDATV   BAL   2,SNDAT2                                        @SC86295
         DC    AL1(2),C'V"'  Format is 2-byte binary prefix    @SC86295
SNDAT2   MVI   0(5),C'/'     Format                            @SC86295
         MVC   1(9,5),0(2)   Copy string                       @SC86295
         TR    1(1,5),ATOE+ABL Convert to char                 @SC86295
         SR    4,4                                             @SC86295
         IC    4,0(2)        Get length                        @SC86295
         LA    5,2(4,5)      Update string ptr                 @SC86295
SNDAT3   CLI   FDATE,0       File date defined?                @SC86295
         BE    SNDAT9        No, skip it                       @SC86295
         MVC   0(2,5),=C'#(' Yes, use yyyymmdd                 @SC86295
         UNPK  2(9,5),FDATE(5) Insert zones                    @SC86295
         LA    5,10(5)       Update ptr                        @SC86295
SNDAT9   L     15,ASDATA                                       @SC86295
         SR    5,15                                            @SC86295
         TR    0(256,15),ETOA Convert to ASCII                 @SC86295
         ST    5,DATL        Set length                        @SC86295
         LA    8,SNDNST      Restore state ptr                 @SC86295
         MVI   STYPE,AA                                        @SC86149
         BAL   9,INPUTSPK    Send it                           @SC86295
         BAL   14,INCRSEQ                                      @SC86149
         CLC   DATL,F0       Any objections?                   @SC86149
         BE    SNDATZ        Ok                                @SC86149
         L     1,ARDATA                                        @SC86316
         CLI   0(1),AN       Refused?                          @SC86149
         BE    SNDCAN        Sigh                              @SC86149
SNDATZ   DS    0H                                              @SC86149
         NI    FL1,255-EOF           Not end of file yet
         BAL   14,RDWSET     Check for special format          @SC86151
         XC    RBUFL,RBUFL           No data in input buffer
         TM    FL4,NPS       Non-protocol?                     @SC86165
         BO    SNDNPS        Yes, do it                        @SC86165
SNDENC   KCALL ENCODE,E=SNDENX Encode the data and more
SNDDAT   MVI   STYPE,AD              PACKET TYPE = DATA
         BAL   9,INPUTSPK    Send data and interpret reply     @SC86295
         BAL   14,INCRSEQ
         LH    15,SNPKCT                                       @SC86345
         BCT   15,SNDTUNZ    No tuning yet                     @SC86345
         CLC   MAXSIZ+4,AKMAX Long packets selected?           @SC86345
         BNP   SNDTUNY       No                                @SC86345
         BAL   9,OPTPKT      Calculate optimum size            @SC86345
         LTR   15,15         Valid?                            @SC86345
         BNP   SNDTUNY       No                                @SC86345
         C     15,MAXSIZ+4   Other Kermit's limit              @SC86345
         BNH   *+8                                             @SC86345
         L     15,MAXSIZ+4                                     @SC86345
         C     15,AKMAX                                        @SC86345
         BNL   *+8                                             @SC86345
         L     15,AKMAX      Don't get too small               @SC86345
         ST    15,MAXSIZ     Set send limit                    @SC86345
SNDTUNY  LA    15,20         Repeat after 20 more              @SC86345
SNDTUNZ  STH   15,SNPKCT                                       @SC86345
         CLC   DATL,F1
         BNE   SNDENC                Go if no Data in ack
         L     1,ARDATA                                        @SC86190
         CLI   0(1),AX                                         @SC86190
         BE    SNDCAN                Go if Abort sending file
         CLI   0(1),AZ                                         @SC86190
         BNE   SNDENC                Go if not Abort sending grp
SNDCAN   MVC   CXZ,0(1)      Pick up data                      @SC86190
         MVI   ERRNUM,ERRTRC Send cancelled                    @SC86156
         CLC   DATL,F2       Any reason given (if A-pkt)       @SC86316
         BL    SNDEOF        None                              @SC86316
         UNCHR 2,1(1),REASON Yes, save it                      @SC86316
SNDEOF   BAL   9,SNDCLS      Close file                        @SC86295
         MVI   STYPE,AZ              PACKET TYPE = EOF
         XC    DATL,DATL
         L     9,ASDATA                                        @SC86295
         MVI   0(9),AD       In case of discard                @SC86295
         CLI   CXZ,0         Aborting this file?               @SC86125
         BE    *+8           No, ok                            @SC86125
         MVI   DATL+3,1      Yes, send 'D'                     @SC86125
         BAL   9,INPUTSPK    Send EOF and Interpret response   @SC86295
         BAL   14,INCRSEQ
         TM    FL4,SFM                                         @SC86158
         BO    SNDBRK        Memory has only one 'file'        @SC86158
         B     SNDNXT                else GET-NEXT-FILE
*
SNDNPS   MVI   WRRD,0        Set for send only                 @SC86165
SNDNPSL  KCALL NPREAD,E=(SNDABR,P)                             @SC86165
         CLC   SNDPKL,F0     OK, any data?                     @SC86165
         BE    SNDNPZ        No, must be done                  @SC86165
         KCALL SIO,E=SNDABR  Send what we got                  @SC86165
         TM    FL1,EOF       Any more?                         @SC86165
         BZ    SNDNPSL       Yes, get it                       @SC86165
SNDNPZ   BAL   9,SNDCLS      Reached end                       @SC86295
         B     SNDBR2        All done                          @SC86165
*
SNDENX   LTR   15,15                 Positive or negative error?
         BP    SNDABR                Pos: error from ENCODE, not EOF
         CLC   DATL,F0
         BE    SNDEOF                No more data to send
         B     SNDDAT                Send last chunk
*
SNDNON   TM    SNFLG,FIRST                                     @SC86295
         BZ    SNDBRK                Go if not first file
SNDFNF   MVI   ERRNUM,ERRFNF Not found                         @SC87012
         TM    FL2,SRV
         BO    SNDABR                Go if server
         B     SNDRET                                          @SC86295
*
SNDBRK   MVI   STYPE,AB              PACKET TYPE = BREAK
         XC    DATL,DATL
         BAL   9,INPUTSPK    Send BRK and Interpret response   @SC86295
SNDBR2   DS    0H                                              @SC86165
         MVI   ERRNUM,ERRNOE Reset error (OK)                  @SC86156
         CLI   CXZ,0
         BE    SNDRET                Go if x-fer not stopped
         MVI   ERRNUM,ERRTRC Set this anyway                   @SC86156
SNDABR   BAL   9,SNDCLS      Close disk file                   @SC86295
         TM    FL4,NPS       Non-protocol?                     @SC86165
         BO    SNDRET        Yes, skip error packet            @SC86165
         KCALL ERPACK        Send error packet
SNDRET   NI    FL4,255-NPS-SFM-TXT                             @SC86165
         B     RETSNRC       Close statistics and return       @SC86295
*
SNDCLS   TM    FL4,SFM       Text xmit?                        @SC86158
         BOR   9             Yes, no disk file                 @SC86295
         CLOSF FILPTR        Close it                          @SC86158
         BR    9                                               @SC86295
         LOCALS ,                                              @SC86295
SNPKCT   DS    H             Cyclic counter for tuning         @SC86345
CXZ      DS    X             Flag for aborted transmission     @SC86295
SNFLG    DS    X             More local flags                  @SC86295
FIRST    EQU   X'80'         File is the first one             @SC86295
SEND     EXIT
         TITLE 'RECEIV Routine - receives a file'
* Receive file(s) and set ERRNUM appropriately
* Entry: filespec in FILNAM if ROVR is set
RECEIV   ENTER
         XC    TOUTOT(LSTATS),TOUTOT Clear statistics          @SC86295
         KCALL SUPFNC,10                                       @SC86295
         ST    15,SECTOT     Save start time                   @SC86295
         MVI   SEQ,0         Reset packet number               @SC86135
         KCALL SPARSET       Set up for exchange               @SC86152
         LA    8,RECINST             Next state table for RECEIVE I
         MVC   LIMTRY,MAXTNT Limit for INIT retries            @SC86345
         TM    FL2,SRV
         BO    RECSRV                Go if in server
         KCALL RPACK         Get init info
RECSRV   SR    3,3                   Clear retry counter for INPUTLUP
         BAL   9,INPUTINR    Interpret response to RPAC        @SC86295
         KCALL SPAR          Interpret his S packet
         KCALL RPAR          Reply to the S packet
         BAL   2,SENDACKL            Send an ACK, length set
         MVC   BCTU,BCTR             Restore desired chksum
         MVC   LIMTRY,MAXTRY Set retry limit                   @SC86164
         BAL   14,INCRSEQ
RECFIL   LA    8,RECFNST             Next state table for RECEIVE F
         BAL   9,INPUT       Read a packet and interpret       @SC86295
         NI    RFLG,255-RTRC-RRJC Clear each time              @SC86316
         MVI   REASON,0
         NI    FL1,255-EOF           Turn of EOF = no ctl-z seen
         TM    FL1,ROVR
         BO    RECOVR                Overwrite the name sent?
         BAL   9,DECODEN     Decode the input                  @SC86295
         L     1,WBUF                Start of data
         L     0,WBUFL               Data length decoded
         TR    0(256,1),ATOE         First to EBCDIC
         STM   0,1,SCANPTR   Set up scan                       @SC86295
         MVC   CMD+5(250),0(1)  Extra copy for display         @SC87300
         LA    0,FFHDR                                         @SC86295
         KCALL FSPEC,FILNAM                                    @SC86295
         CLI   TRMLIN,C' '   Alt. line?                        @SC87300
         BE    RECOVR        No, be quiet                      @SC87300
         MVC   CMD(5),=CL5'File '  Yes, display message        @SC87300
         LA    0,CMD+5                                         @SC87300
         A     0,WBUFL                                         @SC87300
         BAL   2,STAPMSG     Show name                         @SC87300
RECOVR   LA    3,FILNAM              Point to fn
         TM    FL3,APPN      Appending to old files?           @SC86203
         BO    RECOPN        Yes, just do it                   @SC86295
         TM    FL1,REN
         BZ    RECOPN        No, just do it                    @SC86295
         LA    0,FFNEW                                         @SC86295
         KCALL FSPEC,FILNAM,E=RECRER Check collisions          @SC86295
         CLI   TRMLIN,C' '   Alt. line?                        @SC87300
         BE    RECOPN        No, be quiet                      @SC87300
         MVC   CMD(9),=CL9'  Rcv as '  Yes, display message    @SC87300
         LA    7,CMD+9                                         @SC87300
         LA    1,FILNAM                                        @SC87300
         BAL   2,STAFSP      Format name and show it           @SC87300
RECOPN   XC    FILFLGS,FL3   Set flag for DISP                 @SC86295
         NI    FILFLGS,255-APPN                                @SC86295
         XC    FILFLGS,FL3                                     @SC86295
         OPENF O,FILNAM,FILFDB,FILPTR,E=RECRER                 @SC86295
         USING FDBD,1                                          @SC86295
         SR    0,0                                             @SC86295
         ICM   0,3,FDBLRC                                      @SC86295
         ST    0,FSIZE       Copy LRECL                        @SC86295
         MVC   FRECF,FDBRCF  Save info                         @SC86295
         DROP  1                                               @SC86295
         BAL   14,RDWSET     Check for special format          @SC86295
         BAL   2,SENDACK
         XC    WBUFL,WBUFL           Data length in WBUF
         MVI   PREV,0                Char previously decoded
         LA    8,RECANST     State table: REC D or A           @SC86149
RECDAT   BAL   14,INCRSEQ                                      @SC86316
         BAL   9,INPUT       Read a packet and interpret       @SC86295
         LA    8,RECDNST     Next state table: REC D only      @SC86149
         KCALL DECODE,E=RECABR Decode and write to file        @SC86316
RECDAK   BAL   2,SENDACK     Send an ack                       @SC86149
         B     RECDAT
*
RECCKA   L     2,ARDATA      Attributes                        @SC86316
         LR    5,2           Save start                        @SC86316
         L     3,DATL        Get length                        @SC86316
         LA    15,ATOE                                         @SC86316
         BAL   14,TRANSLAT   Convert to EBCDIC                 @SC86316
         LR    3,2           Save end                          @SC86316
         MVI   ERRNUM,ERRIPS In case of error                  @SC86316
RECCKL   CR    5,3           Another attribute?                @SC86316
         BNL   RECDAK        No, done                          @SC86316
         LR    6,5                                             @SC86316
         IC    4,0(6)        Get code                          @SC86316
         SR    5,5                                             @SC86316
         IC    5,1(6)        Get length of value               @SC86316
         UNCHR 7,ETOA(5)                                       @SC86316
         BM    RECABR        Invalid: length was <0            @SC86316
         LA    6,2(6)        Space over code+length            @SC86316
         LA    5,0(7,6)      Next field                        @SC86316
         CR    5,3           Does it match?                    @SC86316
         BH    RECABR        Overflows data                    @SC86316
         BAL   2,CLKP                                          @SC86316
         DC    C'!',AL3(RECALN) File length                    @SC86316
         DC    X'0',AL3(RECCKL) Other                          @SC86316
RECALN   BAL   14,GETNUM     Get file length                   @SC86316
          B    RECABR                                          @SC86316
         LR    2,0                                             @SC86316
         LA    0,11          Ask for length check              @SC86316
         KCALL DISKIO,FILPTR,E=RECRJC                          @SC86316
         B     RECCKL        Ok, keep looking                  @SC86316
*
RECRJC   LA    8,RECZNST     Now accept only EOF pkt           @SC86316
         L     9,ASDATA      Output buffer                     @SC86316
         MVI   0(9),C'N'     Mark it rejected                  @SC86316
         S     6,F2          Back up to attribute code         @SC86316
         MVC   1(1,9),0(6)   Copy to output                    @SC86316
         TR    0(2,9),ETOA   ASCIIify                          @SC86316
         UNCHR 0,1(9),REASON                                   @SC86316
         OI    RFLG,RRJC     Mark it rejected                  @SC86316
         MVC   DATL,F2       Data = 'N' + code                 @SC86316
         BAL   2,SENDACKL    Acknowledge                       @SC86316
         B     RECDAT        And wait for EOF                  @SC86316
*
RECEOF   CLC   DATL,F1
         BNE   RECWR                 One piece of data
         L     1,ARDATA                                        @SC86190
         CLI   0(1),AD                                         @SC86190
         BNE   RECWR                 Go if not discard
         CLOSF FILPTR        Close the file                    @SC86135
         TM    FL3,APPN      Appending to old file?            @SC86225
         BO    RECKEP        Yes, keep what we got             @SC86225
         TM    FL5,KEEP                                        @SC86225
         BO    RECKEP        Don't delete it anyway            @SC86225
         ERASF FILNAM        And delete it                     @SC86295
RECKEP   MVI   ERRNUM,ERRTRC Receive cancelled                 @SC86225
         OI    RFLG,RTRC     Remember that                     @SC86295
         B     RECACK                Pick up later on
* If data left in buffer when we get EOF, write remaining data.
RECWR    CLC   WBUFL,F0
         BE    RECCLO                No data in WBUF, send Ack
         KCALL OUTBUF,E=RECABR Write out buffer
RECCLO   CLOSF FILPTR        Close it                          @SC86135
RECACK   BAL   2,SENDACK             Send an ACK
         BAL   14,INCRSEQ
         NI    FL1,255-ROVR          Only change first file
         B     RECFIL
*
RECBRK   TM    FL2,SRV       Server will read another command  @SC87343
         BO    *+8            so don't zap write/read flag     @SC87343
         MVI   WRRD,0        No read for Ack'ing BRK pkt       @SC87343
         BAL   2,SENDACK             Send an ACK
         MVI   ERRNUM,ERRNOE Reset error                       @SC86156
         TM    RFLG,RTRC+RRJC                                  @SC86295
         BZ    RECRET        OK                                @SC86295
         MVI   ERRNUM,ERRTRC Receive cancelled                 @SC86156
         B     RECABR
*
RECBAD   MVI   ERRNUM,ERRFNE Illegal filename                  @SC86156
         B     RECABR
*
RECRER   ERRF  ,             Cannot write. Analyze error       @SC87338
RECABR   CLOSF FILPTR        Close open file                   @SC86135
         KCALL ERPACK        Send error packet                 @SC86316
RECRET   ICM   0,15,RECTRC   Any records truncated?            @SC87268
         BZ    RETSNRC       None                              @SC87268
         CLI   ERRNUM,0                                        @SC87268
         BNE   *+8           Already got some (worse) error    @SC87268
         MVI   ERRNUM,ERRRTR Indicate error                    @SC87268
         B     RETSNRC       Close statistics and return       @SC87268
* Receive mode Rpack interpret input tables
RECINST  DC    AL1(AS),AL3(0)        Micro sent parm
         DC    AL1(00),AL3(RECABR)   Error routine
RECFNST  DC    AL1(AF),AL3(0)        Micro sent a filename
         DC    AL1(AX),AL3(0)        Micro sent a filename     @SC86155
         DC    AL1(AB),AL3(RECBRK)   Micro sent end of transaction
         DC    AL1(00),AL3(RECABR)   Error return
RECANST  DC    AL1(AA),AL3(RECCKA)   Micro sent A-packet       @SC86316
RECDNST  DC    AL1(AD),AL3(0)        Micro sent data
RECZNST  DC    AL1(AZ),AL3(RECEOF)   Micro sent EOF            @SC86316
         DC    AL1(00),AL3(RECABR)   Error return
         LOCALS ,                                              @SC86295
RFLG     DS    X             Local flags                       @SC86295
RTRC     EQU   X'80'         Other side cancelled              @SC86295
RRJC     EQU   X'40'         I cancelled                       @SC86316
RECEIV   EXIT
         TITLE 'SPAR Routine - use parms from other host in DATA'
SPAR     ENTER
         L     7,DATL        Data length                       @SC86120
         L     5,ARDATA      Point to data                     @SC86190
         LA    8,DEFPARM                                       @SC86190
         SR    8,5           Set up offset for defaults        @SC86190
         BCTR  5,0           Point one before data             @SC86190
         LA    6,1           Set up BXH                        @SC86120
         AR    7,5           Point to last data char           @SC86120
         BAL   14,SPARFTCH   Get a char                        @SC86120
         UNCHR 4             Max send packet size              @SC86120
         C     4,AKMIN       Less than min Kermit size?        @SC86295
         BNL   SPARSPM               No, it's OK
         LA    4,KMIN                Else, use the min value
SPARSPM  C     4,AKMAX       More than max Kermit size?        @SC86295
         BNH   SPARSPS               No, it's OK
         LA    4,KMAX
SPARSPS  ST    4,SPSIZ               Save max send packet size
         BAL   14,SPARFTCH   Get a char                        @SC86120
         UNCHR 4,,TIMOUT     Timeout micro wants us to do      @SC86120
         BAL   14,SPARFTCH   Get a char                        @SC86120
         UNCHR 4,,SPADN      Pad count micro wants             @SC86120
         BAL   14,SPARFTCH                                     @SC86120
         CTL   4,,SPADC      Pad char micro wants              @SC86120
         BAL   14,SPARFTCH                                     @SC86120
         UNCHR 4,,SEOL       EOL char we have to use           @SC86120
         CLC   SEOL,SMARK
         BE    SPARCR                Use CR if EOL=MARK char
         CLI   SEOL,ABL
         BL    SPAREOL2      OK if within ctl range            @SC87274
SPARCR   MVI   SEOL,CR               Send a CR to that crazy micro
SPAREOL2 MVC   S1EOL,SEOL    Make extra copy                   @SC87274
SPARCTL  BAL   14,SPARFTCH                                     @SC86120
         NOTQR *+8           Go if not 33-62 or 96-126         @SC86120
          LA   4,A#          Default ctl-quote                 @SC86120
         STC   4,RCTLQ       Save ctl-quote micro's using      @SC86120
         BAL   14,SPARFTCH                                     @SC86120
         CLI   EBQC,0                                          @SC87008
         BE    SPARNB        8-bit is off                      @SC87008
         CLM   4,1,=AL1(AY)                                    @SC86120
         BNE   *+8                                             @SC86120
         IC    4,EBQC        Micro agrees                      @SC86120
         BAL   14,SPARCKQX                                     @SC86120
          B    SPARNB        Micro says no 8-bit quoting       @SC86120
         CLI   EBQ,0
         BE    SPAREBQ               Use it if we agree
         CLM   4,1,EBQ                                         @SC86120
         BE    SPAREBQ               Or we match
SPARNB   SR    4,4                   Otherwise cannot do it
SPAREBQ  STC   4,EBQ                 Set 8-bit-quoting char/flag
         BAL   14,SPARFTCH                                     @SC86120
         S     4,=A(A0)                                        @SC86120
         BNP   SPARBCD       Go if less than 1, use 1          @SC86120
         C     4,F3                                            @SC86295
         BH    SPARBCD               Go if over 3, use 1
         CLM   4,B'0001',BCTR        Requested and our BCT same?
         BE    SPARBCT               Yes, they are the same
         CLI   BCTR,0
         BE    SPARBCT               We'll accept anything
SPARBCD  LA    4,1                   We don't match, use 1
SPARBCT  STC   4,BCTR                Micro's chksum length
         BAL   14,SPARFTCH                                     @SC86120
         BAL   14,SPARCKQX   See if valid                      @SC86120
          B    SPARNR        No good                           @SC86120
         CLM   4,1,EBQ                                         @SC86120
         BE    SPARNR                Go if same prefix
         CLI   RPTQ,0
         BE    SPARRQ                We can use anything
         CLM   4,1,RPTQ                                        @SC86120
         BE    SPARRQ                We match
SPARNR   SR    4,4                   No repeat quoting
SPARRQ   STC   4,RPTQ                Use negotiated repeat quote
         BAL   14,SPARFTCH   Get capabilities                  @SC86149
         UNCHR 4,,RCAPA                                        @SC86149
         TM    RCAPA,LONGP   Test for long packet bit          @TB86196
         BZ    SPARNX        No extended packets               @TB86196
         MVC   TMP,RCAPA                                       @SC86202
SPARNS1  TM    TMP,MORCAPAS  Test for more CAPAS bytes         @SC86202
         BZ    SPARNS2       No more                           @TB86196
         BAL   14,SPARFTCH   Get capabilities                  @TB86196
         UNCHR 4,,TMP                                          @TB86196
         B     SPARNS1                                         @TB86196
SPARNS2  BAL   14,SPARFTCH   Skip window byte                  @SC86202
         BAL   14,SPARFTCH   Get next header byte              @TB86196
         LR    1,4                                             @TB86196
         UNCHR 1             MAXLX1 byte                       @TB86196
         MH    1,XLFCT+2     Times the factor                  @SC86202
         BAL   14,SPARFTCH   Get next header byte              @TB86196
         UNCHR 4             MAXLX2 byte                       @TB86196
         AR    1,4           Compute total length              @TB86196
         BNP   SPARNX        If zero, use default              @TB86196
         ST    1,SPSIZ       New SPSIZ for extended            @TB86196
SPARNX   DS    0H                                              @TB86196
* Now compute MAXSIZ
         L     5,SPSIZ               Maximum send packet size
         C     5,AKMAX       Check max packet size             @TB86196
         BNH   SPARNY        Not long                          @TB86196
         S     5,F3          Extended header length            @TB86196
         CLI   TRMTP,C'T'                                      @SC87166
         BNE   SPARNY        Not TTY ==> not limited           @SC87166
         C     5,AMAXWT                                        @SC86205
         BNH   *+8                                             @SC86205
         L     5,AMAXWT      Biggest we can send               @SC86205
SPARNY   DS    0H                                              @SC86205
         S     5,F5                  Minus control information
         IC    4,BCTR                Get user's negotiated BCT
         SR    5,4                   Minus checksum length
         CLI   EBQ,0
         BE    SPARNEBQ              Go if no 8-Bit quoting
         BCTR  5,0                   Another one for 8-bit quoting
SPARNEBQ CLI   RPTQ,0
         BE    SPARNRQ               Go if no repeat char quoting
         BCTR  5,0
         BCTR  5,0                   Minus two for repeat prefix
SPARNRQ  ST    5,MAXSIZ              Save max length for data field
         ST    5,MAXSIZ+4    Static extra copy (for tuning)
SPARBAK  RET                                                   @SC86152
SPARCKQX CLM   4,1,RCTLQ                                       @SC86120
         BER   14            Cannot use same prefix            @SC86120
         CLM   4,1,SCTLQ                                       @SC86120
         BER   14                                              @SC86120
         B     CHKQR         Test if 33-62 or 96-126           @SC86120
SPARFTCH L     4,SPACE       Default                           @SC86120
         BXH   5,6,*+8       Check for more data               @SC86120
         IC    4,0(5)        OK, use it                        @SC86120
         C     4,SPACE       Default?                          @SC86120
         BNER  14                                              @SC86120
         IC    4,0(5,8)      Yes, get default value            @SC86190
         BR    14                                              @SC86120
*
*        SPARSET Routine - set up for exchange (SPAR 1st)      @SC86152
*
SPARSET  ENTER ALT                                             @SC86152
         MVI   BCTR,0        Use whatever micro wants          @SC86152
         MVI   EBQ,0                                           @SC86152
         MVI   RPTQ,0                                          @SC86152
         MVI   BCTU,1        Must start at 1                   @SC86295
         B     SPARBAK                                         @SC86152
         LOCALS ,                                              @SC86295
SPAR     EXIT
         TITLE 'RPAR Routine - sets up parms to send to other host'
RPAR     ENTER
         OI    FL3,PXCH      Parameters exchanged now          @SC87012
         L     9,ASDATA                                        @SC86295
         TOCHR 5,RPSIZ+3,0(9)  Receive packet size limit       @SC86295
         TOCHR 5,RTIMO,1(9)  Time limit for micro to wait      @SC86295
         TOCHR 5,RPADN,2(9)  Number of padding chars.          @SC86295
         CTL   5,RPADC,3(9)  Pad character                     @SC86295
         TOCHR 5,REOL,4(9)   EOL char I need                   @SC86295
         MVC   5(1,9),SCTLQ                                    @SC86295
         MVC   6(1,9),EBQ                                      @SC86295
         CLI   EBQ,0
         BNE   RPARBCT               It's OK if not null
         MVI   6(9),AN       Else, use an N                    @SC86295
RPARBCT  MVC   7(1,9),BCTR   Negotiated checksum               @SC86295
         OI    7(9),A0       Make into a real digit            @SC86295
         MVC   8(1,9),RPTQ                                     @SC86295
         CLI   RPTQ,0
         BNE   *+8           It's ok if not null               @SC86149
         MVI   8(9),ABL      Else, use a blank                 @SC86295
         LA    0,10          Size of data                      @SC86149
         NI    SCAPA,255-LONGP No long packets                 @TB86196
         LA    5,KMAX        Largest old KERMIT size           @TB86196
         C     5,RPSIZ       Check max packet size             @TB86196
         BNL   RPARNEX       KMAX >= RPSIZ                     @TB86196
         TOCHR 5,,0(9)       Set largest packet size           @SC86295
         OI    SCAPA,LONGP   Long packets                      @TB86196
         MVI   10(9),ABL     Window size is blank              @SC86295
         L     5,RPSIZ       Packet size                       @SC86205
         CLI   TRMTP,C'T'                                      @SC87166
         BNE   RPARS1        Not TTY ==> not limited           @SC87166
         C     5,AMAXRT                                        @SC86205
         BNH   *+8                                             @SC86205
         L     5,AMAXRT      Biggest we can send               @SC86205
RPARS1   SR    4,4                                             @SC86205
         D     4,XLFCT       Compute extended size bytes       @TB86196
         TOCHR 5,,11(9)      Extended size 1                   @SC86295
         TOCHR 4,,12(9)      Extended size 2                   @SC86295
         LA    0,13          Size of data                      @TB86196
RPARNEX  DS    0H                                              @TB86196
         TOCHR 5,SCAPA,9(9)  Capabilities                      @SC86295
         ST    0,DATL        Return it                         @SC86149
         LA    0,3           Reset function                    @SC86295
         CLI   TRMTP,C'F'                                      @SC87300
         BE    RPARSTT       3708/fullscreen                   @SC87300
         CLI   TRMTP,C'T'                                      @SC87166
         BE    RPARSTT       TTY                               @SC87166
         KCALL SCRNIO                                          @SC86295
         B     RPARBAK                                         @SC86295
RPARSTT  KCALL TERMIO                                          @SC86295
RPARBAK  RET                                                   @SC86152
*
*        RPARSET Routine - set up for exchange (RPAR 1st)      @SC86152
*
RPARSET  ENTER ALT                                             @SC86152
         MVI   BCTU,1        Must start at 1                   @SC86295
         TM    FL2,SRV       Possible I-packet exchange?       @SC87169
         BZ    RPSCLR        Not in Server mode                @SC87169
         TM    FL3,PXCH      Any exchange since last SET?      @SC87169
         BO    RPARBAK       Yes, keep latest settings         @SC87169
RPSCLR   MVC   BCTR,BCTC     Use what user set                 @SC87169
         MVC   EBQ,EBQC      Set what we want otherwise        @SC86152
RPSEBQ   CLI   RPTQ,0                                          @SC86152
         BNE   RPARBAK       If RPTQ is set leave it alone     @SC86152
         MVC   RPTQ,RPTQC    Set what we want otherwise        @SC86152
         B     RPARBAK                                         @SC86152
         LOCALS ,                                              @SC86295
RPAR     EXIT
         TITLE 'ENCODE Routine - encode pkts from RBUF into DATA'
ENCODE   ENTER
         L     6,MAXSIZ                                        @SC86295
         L     9,ASDATA      Pointer to data to fill           @SC86190
         AR    6,9           Limit on output                   @SC86295
ENCAGAIN L     8,RBUFP               Index of next char in RBUF
         L     5,RBUFL       Data length in RBUF               @SC86163
         L     1,RBUF                Point to start of buffer
         AR    5,1                   Point to char after last one
         AR    8,1           Point to char to encode           @SC86163
ENCNXT   CR    8,5           Are we past the last char?        @SC86163
         BL    ENCPKT        No, not exhausted RBUF yet        @SC86163
         TM    FL1,NAME                                        @SC86163
         BO    ENCEMPT       No more disk read if file name    @SC86163
         KCALL INBUF,E=ENCRET                                  @SC86163
         B     ENCAGAIN                                        @SC86163
ENCPKT   CLI   RPTQ,0
         BE    ENCEBQ                Go if no repeat quoting
         LA    14,3(8)       Point to 3 chars past current     @SC86163
         CR    14,5          Is this past the last char?       @SC86163
         BNL   ENCEBQ                Yes, not enough to use repeat
         CLC   0(2,8),1(8)   At least 3 of these?              @SC86163
         BNE   ENCEBQ        No, not enough                    @SC86163
         LR    2,8           Start of string                   @SC86163
         LA    3,KMAX(8)     Max allowed by notation           @SC86163
         CR    3,5           Watch for end of data             @SC86163
         BNH   *+6                                             @SC86163
         LR    3,5           Truncate at max                   @SC86163
         LR    15,3          Same limit                        @SC86163
         SR    3,2           Get lengths                       @SC86163
         SR    15,14         Length of shorter string          @SC86163
         ICM   15,8,0(8)     Use starting char for fill        @SC86163
         CLCL  2,14          Find end of match                 @SC86163
         SR    14,8          Get repeat count                  @SC86163
         AR    8,14          Advance ptr to                    @SC86163
         BCTR  8,0             last matching char              @SC86163
         MVC   0(1,9),RPTQ   Put repeat quote into DATA        @SC86163
         TOCHR 14,,1(9)                                        @SC86163
         LA    9,2(9)        Count 2 for RPTQ and rpt count    @SC86295
ENCEBQ   TM    0(8),128                                        @SC86163
         BZ    ENCCTL                no 8th bit
         CLI   EBQ,0
         BE    ENCCTL                cannot use 8bit quoting
         NI    0(8),127      Get rid of 8th bit                @SC86163
         MVC   0(1,9),EBQ            Move EBQ into DATA
         LA    9,1(9)        Count for it                      @SC86295
ENCCTL   IC    7,0(8)        Load desired char                 @SC86163
         CLI   0(8),ABL                                        @SC86163
         BL    ENCSCTL               within control range
         CLI   0(8),ADEL                                       @SC86163
         BNE   ENCNCTL               not a control char
ENCSCTL  CTL   7             Convert to non-control            @SC86163
         B     ENCMVCTL
*
ENCNCTL  CLM   7,1,SCTLQ                                       @SC86163
         BE    ENCMVCTL              send prefix if ctl quote char
         CLM   7,1,EBQ                                         @SC86163
         BE    ENCMVCTL              ditto if 8bit quote
         CLM   7,1,RPTQ                                        @SC86163
         BNE   ENCNOCTL              not so if not repeat quote
ENCMVCTL MVC   0(1,9),SCTLQ          Move a ctl quote
         LA    9,1(9)                incr for it
ENCNOCTL STC   7,0(9)        Move the char, finally!           @SC86163
         LA    9,1(9)                incr for it
         LA    8,1(8)        Incr RBUF pointer                 @SC86163
         CR    9,6           Did we reach max pkt size?        @SC86295
         BL    ENCNXT        Test for more data                @SC86295
*
ENCFULL  CR    8,5           Are we past the last char?        @SC86163
         BL    ENCGOOD       No, not exhausted RBUF data yet   @SC86163
ENCEMPT  XC    RBUFL,RBUFL   Zap data length for next time     @SC86163
ENCGOOD  SR    15,15
         S     8,RBUF        Get current index                 @SC86163
         ST    8,RBUFP               Save RBUF index
ENCRET   S     9,ASDATA      Get length                        @SC86295
         ST    9,DATL        Save encoded DATA length          @SC86295
         RET   ,                                               @SC86295
         LOCALS ,                                              @SC86295
ENCODE   EXIT
         TITLE 'NPREAD Routine - copy from RBUF to SDATA'      @HF86150
NPREAD   ENTER                                                 @HF86150
         L     6,SPSIZ       Max packet length                 @SC86295
         LR    4,6           Save                              @SC86295
         L     9,ASPKT       Fill pointer (includes header)    @SC86165
         SR    7,7                                             @SC86165
         IC    7,TCTLQ       Fetch control quote               @SC86165
NPRAGAIN L     8,RBUFP       Index of next char in RBUF        @SC86165
         L     5,RBUFL       Data length in RBUF               @SC86165
         L     1,RBUF        Start of buffer                   @SC86165
         AR    5,1           Point to char after last one      @SC86165
         AR    8,1           Point to char to encode           @SC86165
NPRNXT   CR    8,5           Are we past the last char?        @SC86165
         BL    NPRTCT        No, not exhausted RBUF yet        @SC86165
NPRRD    KCALL INBUF,E=NPRRET                                  @HF86150
         B     NPRAGAIN                                        @SC86165
NPRTCT   LTR   7,7           Test for quoting                  @SC86165
         BZ    NPRNOCTL      Not enabled                       @HF86150
         CLM   7,1,0(8)      Is it a quote character?          @HF86150
         BNE   NPRNOCTL      No, copy it                       @HF86150
         LA    8,1(8)        Check next                        @HF86150
         CR    8,5                                             @HF86150
         BNL   NPRRD         Ran out of data, ignore the quote @HF86150
         CLM   7,1,0(8)      If repeat of quote character      @HF86150
         BE    NPRNOCTL       send that character              @HF86150
         NI    0(8),X'1F'    Make control character            @HF86150
NPRNOCTL MVC   0(1,9),0(8)   Copy the char                     @HF86150
         LA    9,1(9)        Incr for it                       @HF86150
         LA    8,1(8)        Incr RBUF pointer                 @HF86150
         BCT   6,NPRNXT      Get next character if any room    @SC86295
*
NPRGOOD  SR    15,15                                           @HF86150
         S     8,RBUF        Convert to index                  @SC86165
         ST    8,RBUFP       Save it                           @SC86165
NPRRET   SR    4,6           Get DATA length                   @SC86295
         ST    4,SNDPKL      Save it                           @HF86150
         RET                                                   @HF86150
         LOCALS ,                                              @SC86295
NPREAD   EXIT                                                  @HF86150
         TITLE 'DECODE Routine - decode pkts from DATA to WBUF'
DECODE   ENTER
         ICM   5,B'1111',DATL        Data length to decode
         BNP   RTRN1         No data to decode                 @SC86295
         TM    FL1,EOF
         BO    DECNULL               Ignore if ctl-z caused EOF
         L     1,WBUF                Point to output buffer
         L     9,WBUFL               Number of chars in it
         AR    1,9                   Point to next spot to fill
         L     8,ARDATA      Data to be decoded                @SC86190
         AR    5,8           Point one past the last char
DECLOOP  LA    3,1           Repeat count                      @SC86316
         CLI   RPTQ,0
         BE    DECEBQ                Not doing repeats
         CLC   RPTQ,0(8)
         BNE   DECEBQ                Not the repeat quote
         UNCHR 3,1(8)        Get number of repeats             @SC86316
         LA    8,2(8)                skip to char to decode
DECEBQ   MVI   CUR,0                 No 8th bit yet
         CLI   EBQ,0
         BE    DECCTL                Not doing 8bit quoting
         CLC   EBQ,0(8)
         BNE   DECCTL                Not the 8bit quote
         LA    8,1(8)                point to char to decode
         MVI   CUR,128               8th bit seen
DECCTL   CLC   RCTLQ,0(8)
         BNE   DECCHR                not the ctl quote
         LA    8,1(8)                point to char to decode
         CLI   0(8),63
         BL    DECCHR                skip if not in ctl range
         CLI   0(8),95
         BH    DECCHR                skip if not in ctl range
         CTL   4,0(8),0(8)           Ctl it
DECCHR   OC    0(1,8),CUR            put in the parity
         MVC   CUR,0(8)              move it here also
         TR    CUR,ATOE              keep the EBCDIC version here
DECRLOOP TM    FL1,NAME
         BO    DECPUT                skip if not writing to disk
         LTR   7,9           Started yet?                      @SC86316
         BZ    DECTFUL       No                                @SC86151
         C     9,RDWLEN                                        @SC86151
         BNE   DECTFUL                                         @SC86151
         L     6,WBUF        Just finished RDW                 @SC86316
         SR    14,14                                           @SC86151
         ICM   14,3,0(6)     Get expected length               @SC86316
         C     9,F2          Short?                            @SC86262
         BE    DECVLEN       Yes, we got it                    @SC86262
         TR    0(5,6),ATOE   No, must be 5-byte ASCII prefix   @SC86316
         MVI   ERRNUM,ERRBPC Look out for bad field            @SC86262
         BAL   14,GETNUM     Read length field                 @SC86316
          B    RTRN1         Bad                               @SC86316
         LR    14,0                                            @SC86316
DECVLEN  DS    0H                                              @SC86262
         AR    14,9               + RDW length                 @SC86151
         ST    14,MAXOUT     Reset byte limit                  @SC86151
DECTFUL  C     9,MAXOUT      Max write buffer size reached?    @SC86151
         BNL   DECWRT                Yes, write the buffer
DECMORE  TM    FL1,BINF
         BO    DECPUT                No special test in binary mode
         CLI   CUR,CR
         BE    DECWRT                A cr means end of record
         CLI   CUR,LF
         BNE   DECTAB                Not an LF
         CLI   PREV,CR
         BE    DECIGN                A cr/lf together = ignre the LF
DECWRT   ST    9,WBUFL               Buffer length to write
         KCALL OUTBUF,E=RTRN1 Dump it                          @SC86295
         SR    9,9                   Reset length to resume decoding
         L     1,WBUF                Reset pointer also
         CLC   WBUFL,MAXOUT
         BNL   DECMORE               Resume decoding if max
         B     DECIGN
*
DECTAB   TM    FL2,TABS
         BZ    DECCTLZ               Skip if not expanding tabs
         CLI   CUR,TAB
         BNE   DECCTLZ               Not a tab
         LR    0,1           Save output ptr                   @SC86355
         LH    2,TABCNT      Get count of tabs that are set    @TS86100
         LTR   2,2           Any?                              @SC86355
         BZ    DECTL8        No, use every 8 cols              @SC86355
         LA    7,TABTBL      Yes, point to table of tabs       @TS86100
         SR    1,1                                             @TS86100
DECTLP   IC    1,0(7)        Get tab column from table         @TS86100
         BCTR  1,0           Adjust for displacement compare   @TS86100
         CR    1,9           Where is this tab compared to buf @TS86100
         BH    DECTLX        Above buffer position             @TS86100
         LA    7,1(7)        Point to next tab position        @TS86100
         BCT   2,DECTLP      Continue with next tab            @TS86100
DECTL8   DS    0H                                              @SC86355
         LA    1,8(9)        Buffer pointer + 8                @SC86355
         SRL   1,3                                             @SC86355
         SLL   1,3           Round up to multiple of 8         @SC86355
DECTLX   C     1,MAXLRC                                        @SC86355
         BL    *+8                                             @SC86355
         L     1,MAXLRC      Don't go past end of buffer       @SC86355
         SR    1,9           Number of blanks to add           @SC86355
         AR    9,1           Advance the count                 @SC86355
         LA    15,ABL                                          @SC86355
         SLL   15,24         Set for ASCII blank fill          @SC86355
         MVCL  0,14          Jump to tab stop                  @SC86355
         LR    1,0           Restore output ptr                @SC86355
         B     DECIGN                skip to the end of this
*
DECCTLZ  TM    FL2,EOFZ
         BZ    DECPUT                Skip if EOF is off
         CLI   CUR,SUB
         BNE   DECPUT                Skip if not a ctl-z
         OI    FL1,EOF               Fake an end-of-file
         B     DECEOF                all done
*
DECPUT   C     9,MAXLRC      Still within disk buffer?         @SC86355
         BNL   *+10          No, don't copy                    @SC86355
         MVC   0(1,1),0(8)   Yes, put the data in buffer       @SC86355
         LA    9,1(9)                Increment count
         LA    1,1(1)                Increment pointer
DECIGN   MVC   PREV,CUR              copy the decoded char
         BCT   3,DECRLOOP    Repeat it repeat count times      @SC86316
         LA    8,1(8)                Increment decoded data pointer
         CR    8,5                   Did we reach end of DATA?
         BL    DECLOOP               No, More data left to decode
DECEOF   ST    9,WBUFL               Save buffer length
DECNULL  B     RTRN0         Good return code                  @SC86295
         LOCALS ,                                              @SC86295
CUR      DS    C             Char being decoded                @SC86295
DECODE   EXIT
         TITLE 'ERPACK Routine - send error packet with errnum'
ERPACK   ENTER
         CLI   ERRNUM,ERRABO                                   @SC86295
         BE    RTRN0         Skip it if the micro died         @SC86295
         CLI   ERRNUM,ERRTRC                                   @SC86295
         BE    RTRN0         Skip it if other cancelled        @SC86295
         MVI   STYPE,AE              Error packet
         MVC   SEQ,RSN               Synch packet numbers
         SR    5,5
         IC    5,ERRNUM              Get right message number
         SLL   5,2           Pointer offset = ERRNUM * 4       @SC86156
         A     5,AERRTAB     Pointer address                   @SC86156
         L     3,0(5)        Msg ptr                           @SC86156
         SR    4,4                                             @SC86156
         IC    4,0(5)        Msg length                        @SC86156
         TM    FL2,PROTO                                       @SC87300
         BZ    RTRN0         Skip packet if never started      @SC87300
         TM    FL2,SRV       Server will read another command  @SC87343
         BO    *+8            so don't zap write/read flag     @SC87343
         MVI   WRRD,0        No read ncessary for Err pkt      @SC87300
         ST    4,RBUFL       Save length to encode             @SC86156
         L     1,RBUF
         MVC   0(50,1),0(3)  Put data in RBUF (and some extra) @SC86156
         TR    0(50,1),ETOA  Ascii it                          @SC86156
         BAL   9,ENCODEN                                       @SC86295
         KCALL SPACK         Send error packet                 @SC86135
         RET
         LOCALS ,                                              @SC86295
ERPACK   EXIT
         TITLE 'SPACK Routine - sends DATA buffer'
SPACK    ENTER
         SR    3,3                   Zero out IC register
         L     8,AASPKT      SNDPKT address                    @SC86295
SPKNX3   LA    8,3(8)        Remove LX1, LX2, HCHECK from hdr  @SC86295
         L     9,DATL                Data size
         IC    3,BCTU                CHK len
         LA    9,2(3,9)              Data, CHK, SEQ, TYP lengths
         LA    1,3(9)        Plus SOH, LEN, EOL lengths        @SC86202
         C     9,AKMAX       Check packet length byte          @SC86202
         BNH   SPKNXDL1      No extended data len              @SC86202
         LA    1,3(1)        Plus LX1,LX2,HCHECK for ext. hdr  @SC86202
         SR    9,9           Set 'Type 0' extended hdr         @SC86202
         SH    8,SPKNX3+2    Remove LX1, LX2, HCHECK from hdr  @SC86295
SPKNXDL1 ST    1,SNDPKL      SNDPKT length                     @SC86202
         LM    14,15,TOUTOT  Update send count                 @SC86295
         ALR   15,1                                            @SC86295
         BNO   *+8                                             @SC86295
         AL    14,F1                                           @SC86295
         STM   14,15,TOUTOT  Save new count                    @SC86295
         ST    8,ASPKT       Ptr to buffer                     @SC86295
         MVC   0(1,8),SMARK  Add mark to packet                @SC86295
         TOCHR 9,,1(8)       Add it to packet                  @SC86295
         TOCHR 4,SEQ,2(8)    Get packet number                 @SC86295
         AR    9,4                   And add to checksum
         IC    3,STYPE               Type
         STC   3,3(8)        Store in buffer                   @SC86295
         AR    9,3                   Add to checksum
         CLI   1(8),ABL      Chk 'Type 0' extended hdr         @SC86295
         BNE   SPKNXDL3      No extended data len              @TB86196
         L     7,DATL        Data size                         @TB86196
         IC    3,BCTU        CHK len                           @TB86196
         AR    7,3           Sum = extended length             @TB86196
         SR    6,6                                             @TB86196
         D     6,XLFCT       Get two parts                     @TB86196
         TOCHR 7,,4(8)       Add LENX1 to packet               @SC86295
         AR    9,7           And add to checksum               @TB86196
         TOCHR 6,,5(8)       Add LENX2 to packet               @SC86295
         AR    9,6           And add to checksum               @TB86196
         LR    6,9           Chksum thru LENX2 byte            @TB86196
         SRL   6,6           High 2 bits of total              @TB86196
         N     6,F3          Get just 2 bits                   @SC86295
         AR    6,9           Get type-1 check value            @TB86196
         N     6,MOD64                                         @TB86196
         TOCHR 6,,6(8)       Make printable                    @SC86295
         AR    9,6           And add to checksum               @TB86196
SPKNXDL3 DS    0H                                              @TB86196
         L     8,ASDATA                                        @SC86295
         BCTR  8,0           Ptr one before data               @SC86295
         ICM   6,B'1111',DATL        Data length
         BZ    SPKCHK                Go if no data
         LR    5,6                                             @SC86135
SPKCHAR  IC    3,0(5,8)      Pick up char                      @SC86295
         AR    9,3                   Add to checksum
         BCT   5,SPKCHAR     Yes, there's more data            @SC86135
SPKCHK   LA    6,1(6,8)      Point to where chksum goes        @SC86295
         LR    7,9                   Need copy of chksum
         CLI   BCTU,2
         BE    SPKCHK2               Go if 2 char chksum
         BH    SPKCHK3               Go if 3 char CRC
         SRL   9,6                   High 2 bits of total
         N     9,F3          Get just 2 bits                   @SC86295
         AR    7,9                   Add the two values
         B     SPKCHK1               Go add chksum to data
*
SPKCHK3  L     5,ASPKT                                         @SC86190
         LA    5,1(5)        Where checksum starts             @SC86190
         KCALL CRCCLC        Calculate the CRC
         LR    7,15                  Keep in here
         SRL   15,12                 High 4 bits of high byte
         TOCHR 15,,0(6)              Make char printable
         LA    6,1(6)                Bump output pointer
SPKCHK2  LR    15,7                  total
         SRL   15,6          Next 6 bits of total              @SC86295
         N     15,MOD64      Get just 6 bits                   @SC86295
         TOCHR 15,,0(6)              Make char printable
         LA    6,1(6)                Bump pointer
SPKCHK1  N     7,MOD64               Get low order 6 bits
         TOCHR 7,,0(6)               Make printable
SPKEOL   MVC   1(2,6),S1EOL  Add micro's EOL char + handshake  @SC87274
         KCALL SIO           Write the SNDPKT                  @SC86135
         RET   ,             Return with SIO's rc              @SC86295
         LOCALS ,                                              @SC86295
SPACK    EXIT
         TITLE 'RPACK Routine - Reads data into DATA buffer'
RPACK    ENTER
         KCALL RIO,E=RPKNAK
         L     7,RCVPKL              Length of data read
         LM    14,15,TINTOT  Update recv count                 @SC86295
         ALR   15,7                                            @SC86295
         BNO   *+8                                             @SC86295
         AL    14,F1                                           @SC86295
         STM   14,15,TINTOT  Save new count                    @SC86295
         L     14,ARPKT      Point to recv buffer              @SC86295
         L     8,APKT        Point to PKT                      @SC86190
         MVI   RTYPE,AT      In case of time-out               @SC87012
         C     7,F1          Time-out signal is ASCII T        @SC87012
         BNE   *+12                                            @SC87012
         CLI   0(8),AT                                         @SC87012
         BE    RTRN          Yes, timed out                    @SC87012
         AR    7,8           Point past last char
RPKBEG   SR    3,3                   Use this for IC's
RPKLOOP  CLC   RMARK,0(8)
         LA    8,1(8)        Try next character                @SC86135
         BE    RPKSOH                Go if a Control-A
         CR    8,7                   Are we within the received pkt?
         BL    RPKLOOP               Yes, keep on looking for SOH
         B     RPKERR
*
RPKSOH   LA    9,4(14)       Skip over usual header            @SC86295
         MVC   1(3,14),0(8)  Copy usual header to RCVPKT       @SC86295
         UNCHR 3,0(8)                Length
         BM    RPKBEG        Invalid length, try again         @SC86153
         LA    5,ABL(3)              Chksum accumulator
         LR    4,3                   Keep length to compute DATA len
         LA    15,0(3,8)             pkt len + beg
         CR    15,7                  Is it within received pkt?
         BNL   RPKBEG                too long, look for another SOH
         IC    3,2(8)        Pick up packet type               @SC86153
         STC   3,RTYPE       Save value here                   @SC86153
         AR    5,3           Add to checksum                   @SC86153
         BCTR  4,0                   -1 for Seq #
         BCTR  4,0                   -1 for Type
         UNCHR 3,1(8)        Pick up packet number             @SC86153
         BM    RPKBEG        Invalid char                      @SC86153
         LA    5,ABL(3,5)            Add to checksum
         STC   3,RSN         Received packet number            @SC86135
         LA    8,3(8)        Go to putative data               @SC86153
         CLI   1(14),ABL     Is this an extended pkt?          @SC86295
         BNE   RPKEXT2       No                                @TB86196
         LA    15,3(8)       Past LENX1,LENX2,HCHECK           @TB86196
         CR    15,7          Is it within rcvd pkt?            @TB86196
         BNL   RPKBEG        Too long, try for another SOH     @TB86196
         MVC   4(3,14),0(8)  Copy extended pkt hdr             @SC86295
         UNCHR 1,0(8)        Pick up LENX1 byte                @TB86196
         LA    5,ABL(1,5)    Add to check                      @SC86202
         MH    1,XLFCT+2     High digit of size                @SC86202
         UNCHR 3,1(8)        Pick up LENX2 byte                @TB86196
         LA    5,ABL(3,5)    Add to chksum                     @SC86202
         AR    1,3           Total extended pkt size           @TB86196
         UNCHR 3,2(8)        Pick up HCHECK byte               @TB86196
         LR    6,5           Keep chksum copy here             @TB86196
         SRL   6,6           High 2 bits of total              @TB86196
         N     6,F3          Get just 2 bits                   @SC86295
         AR    6,5           Add the two values                @TB86196
         N     6,MOD64       Get low order 6 bits              @TB86196
         CR    6,3           Chk computed vs received          @TB86196
         BNE   RPKERR        Err if chksums no match           @TB86196
         LA    5,ABL(3,5)    Add HCHECK to chksum              @SC86202
         LA    8,3(8)        Update input+output ptrs          @SC86202
         LA    9,3(9)        Past LX1,LX2,HCHECK               @SC86202
         LR    4,1           Save length of data+check         @SC86202
         AR    1,8           Expected end of packet            @SC86202
         CR    1,7           Is it within pkt?                 @SC86202
         BH    RPKBEG        Too long, chk for SOH             @SC86202
RPKEXT2  DS    0H                                              @SC86202
         IC    3,BCTU        Chksum length                     @SC86202
         SR    4,3           Minus chksum length               @SC86202
         BM    RPKBEG        Can't have negative data length   @SC86202
         ST    4,DATL        Save data length                  @SC86202
         ST    9,ARDATA      Save ptr                          @SC86202
         LTR   4,4                   Any data to send?
         BZ    RPKCHK                Nope
RPKCHAR  IC    3,0(8)                Get next data char
         STC   3,0(9)                Move it to DATA
         AR    5,3                   Add to checksum
         LA    8,1(8)                Bump input buffer pointer
         LA    9,1(9)                Bump output buffer pointer
         BCT   4,RPKCHAR             Decrement amount of input
RPKCHK   UNCHR 3,0(8)                Get checksum
         LR    6,9           CRC calc ends here                @SC86135
         LA    8,1(8)                Bump input pointer
         LR    4,5                   Keep chksum copy here
         CLI   BCTU,2
         BE    RPKCHK2               Go if using 2 char chksum
         BH    RPKCHK3               Three character CRC
         SRL   5,6                   High 2 bits of total
         N     5,F3          Get just 2 bits                   @SC86295
         AR    4,5                   Add the two values
         B     RPKCHK1               compare it
*
RPKCHK3  LA    5,1(14)       Start of data for CRC             @SC86295
         KCALL CRCCLC        Calculate the CRC
         LR    4,15                  Keep computed value here also
         SRL   15,12                 High 4 bits of high byte
         CR    15,3                  compare computed and received
         BNE   RPKERR                skip if chksums don't match
         UNCHR 3,0(8)                Get next char of checksum
         LA    8,1(8)                Bump input pointer
RPKCHK2  LR    15,4                  Get back the CRC
         SRL   15,6          Next 6 bits of total              @SC86295
         N     15,MOD64      Get just 6 bits                   @SC86295
         CR    15,3                  compare computed and received
         BNE   RPKERR                skip if chksums don't match
         UNCHR 3,0(8)                Get checksum
         LA    8,1(8)                Bump input pointer
RPKCHK1  N     4,MOD64               Get low order 6 bits
         CR    4,3                   Compare computed and received
         BE    RPKRET                skip if chksums match
         TM    FL1,TSTF                                        @SC86295
         BO    RPKRET        Just testing, anything goes       @SC86295
RPKERR   MVI   ERRNUM,ERRBPC Rpack error                       @SC86156
         CR    8,7                                             @BS86001
         BL    RPKBEG        More stuff, see if it's a packet  @BS86001
RPKNAK   MVI   RTYPE,AQ              Return a Q pkt
RPKRET   RET
         LOCALS ,                                              @SC86295
RPACK    EXIT
         TITLE 'CRCCLC Routine - calculates CRC'
* Calculate the CRC and return it in R15.  Expects R5 to point to the
* start of the data on which the CRC is calculated, and R6 to the
* char after the last one.
*
CRCCLC   ENTER
         SR    15,15                 Initial CRC value is zero
CRCLUP   IC    4,0(5)        Get the next character            @SC86295
         XR    4,15          XOR char and CRC low byte         @SC86295
         LR    7,4                   same as above
         SRL   7,4                   High 4 bits of low byte
         N     4,F                   Low 4 bits of low byte
         N     7,F           High 4 bits of low byte           @SC86295
         ALR   4,4                   Double to get index into table
         LH    4,CRCTAB2(4)          CRC for low 4 bits
         ALR   7,7                   Double to get another index
         LH    7,CRCTAB1(7)          CRC for high 4 bits
         XR    4,7                   XOR the two
         SRL   15,8                  Shift prev CRC 8 bits to right
         XR    15,4                  XOR current char's CRC into it
         N     15,=XL4'FFFF' Drop negative stuff               @SC86295
         LA    5,1(5)                Bump input pointer
         CR    5,6                   Did we reach the end?
         BL    CRCLUP                Nope, loop for whole pkt
CRCRET   RET
* Table to use for CRC calculation
CRCTAB1  DC    X'00,00,10,81,21,02,31,83,42,04,52,85,63,06,73,87'
         DC    X'84,08,94,89,A5,0A,B5,8B,C6,0C,D6,8D,E7,0E,F7,8F'
*
CRCTAB2  DC    X'00,00,11,89,23,12,32,9B,46,24,57,AD,65,36,74,BF'
         DC    X'8C,48,9D,C1,AF,5A,BE,D3,CA,6C,DB,E5,E9,7E,F8,F7'
*
         LOCALS ,                                              @SC86295
CRCCLC   EXIT
         TITLE 'RIO Routine - Read packet into RCVPKT'
RIO      ENTER
         MVI   SIORIO,C'R'   Set type                          @SC86316
         L     7,APKT        Ptr to data                       @SC86316
         L     15,RIOC       Previous read count               @SC86295
         MVI   RIOC,X'80'    Nothing left in read buffer       @SC86295
         CLI   TRMTP,C'T'                                      @SC87166
         BE    RIOTTY        Go if not a S/1?                  @SC87166
         CLI   TRMTP,C'F'                                      @SC87300
         BE    RIOTTY        Go if not a S/1?                  @SC87300
         LA    5,OFF80       Turn off all X'80' bits           @SC86316
         TM    FL2,DAT8      Unless 8-bit line                 @SC86316
         BZ    *+6           Not 8-bit                         @SC86316
         SR    5,5           Yes, use all bits                 @SC86316
         LTR   15,15         Any previous?                     @SC86295
         BNM   RIOCOM        Yes, use it                       @SC86295
         CLI   TRMTP,C'G'                                      @SC87215
         BE    RIOS1R        Skip prompt if graphics mode      @SC87215
         LA    0,4           Write                             @SC86295
         KCALL SCRNIO,S1XOPL,E=(RIOER,M) Send a prompt         @SC86295
RIOS1R   DS    0H                                              @SC87215
         LA    0,5           Read                              @SC86295
         KCALL SCRNIO,S1RDPL,E=(RIOER,M) perform read          @SC86295
         BP    RIOCOM                                          @SC86355
RIOER    MVI   ERRNUM,ERRTIE Terminal I/O error                @SC86156
         B     RTRN1         Error, return to caller           @SC86295
*
RIOTTY   LA    5,ETOA        Translate to ASCII                @SC86316
         TM    FL4,TTAB      Using separate terminal tables?   @SC87117
         BZ    *+8           No                                @SC87117
         LA    5,TETOA       Yes                               @SC87117
         LTR   15,15         Any previous data?                @SC86295
         BNM   RIOCOM        Yes, use it                       @SC86295
         LA    0,5           No, read some now                 @SC86295
         KCALL TERMIO,TYRDPL,E=(RIOER,M)                       @SC86295
RIOCOM   LR    6,15          Copy byte count                   @SC86295
         ST    6,RCVPKL      Save
         BAL   9,RIORAW      Log raw data                      @SC86316
         LR    2,7                                             @SC86316
         LR    3,6           Length                            @SC86202
         LTR   15,5          Copy table ptr                    @SC86316
         BZ    *+8           Don't translate after all         @SC86316
         BAL   14,TRANSLAT   Do the translate                  @SC86202
         BAL   9,RIOLOG      Write to log                      @SC86190
         B     RTRN0                                           @SC86295
*  Write record to log buffer, R7->data, R6=length             @SC87286
*  Clobbers R0,R1,R2,R3,R8,R14,R15, return to (R9)             @SC87286
RIORAW   SR    3,3           Write raw data                    @SC86316
         B     RIOLG1                                          @SC86316
RIOLOG   LA    3,ATOE        Write data in EBCDIC              @SC86316
RIOLG1   C     3,DBGTYP      Correct type?                     @SC86316
         BNER  9             No, skip this one                 @SC86316
         TM    FL1,DEBUG                                       @SC86316
         BZR   9             Skip if no debugging              @SC86190
         LA    8,2(6)        Two extra for R:, etc.            @SC87286
         L     2,LOGBUF      LOG buffer                        @SC86316
         MVC   0(1,2),SIORIO Indicate log type                 @SC86316
         LA    2,2(2)        Skip over prefix                  @SC86190
         LR    0,2           Buffer ptr                        @SC86190
         LR    1,8           Data length                       @SC86316
         LR    14,7          Data ptr                          @SC86316
         LR    15,8                                            @SC86316
         MVCL  0,14          Copy to log buffer                @SC86316
         LTR   15,3          Check if translation needed       @SC86316
         BZ    *+10          No                                @SC86316
         LR    3,8           Data length                       @SC86316
         BAL   14,TRANSLAT   Do the translate                  @SC86202
         WRITF LOGPTR,BSIZE=(8),E=RIOLQU                       @SC87034
         BR    9             Done                              @SC86190
RIOLQU   CLOSF LOGPTR        Turn off DEBUG, it fails          @SC86355
         NI    FL1,255-DEBUG                                   @SC86355
         BR    9                                               @SC86355
         TITLE 'SIO Routine - Send packet in SNDPKT'
SIO      ENTER ALT                                             @SC86190
         MVI   SIORIO,C'S'   Set type                          @SC86316
         MVI   RIOC,X'80'    Set no read count                 @SC86295
         L     6,SNDPKL              Length of SNDPKT to be sent
         TM    FL4,NPS       Non-protocol?                     @SC86239
         BO    SIOPLEN       Yes, no handshake at all          @LP87272
         CLI   WRRD,0        Only writing?                     @LP87272
*        BE    SIOPLEN       Yes, handshake done next Read     @LP87272
         CLI   S1HND,0       Handshake desired at all?         @SC87275
         BE    SIOPLEN       No, skip it                       @SC87275
         LA    6,1(6)        Allow for handshake character     @LP87272
SIOPLEN  DS    0H                                              @SC86239
         L     7,ASPKT       Ptr to send data                  @SC86316
         BAL   9,RIOLOG      Write to log                      @SC86190
         L     2,S1WRPL      Final output buffer               @SC86154
         LR    1,2           Save start                        @SC86154
         SR    3,3                                             @SC86154
         TM    FL4,NPS       Non-protocol?                     @SC86191
         BO    *+8           Yes, skip padding                 @SC86191
         IC    3,SPADN       Pad count                         @SC86154
         LA    4,S1DATA                                        @SC86154
         LA    5,S1ORDL      Length of Series/1 stuff          @SC86154
         CLI   TRMTP,C'G'    Graphics?                         @SC87215
         BNE   SIOPAD                                          @SC87215
         LA    4,GRDATA      Yes, use separate command         @SC87215
         LA    5,GRDL                                          @SC87215
SIOPAD   DS    0H                                              @SC87215
         AR    3,5           Total padding + Series/1          @SC86154
         ICM   5,8,SPADC     Get padding character             @SC86154
         MVCL  2,4           Copy to buffer with padding       @SC86154
         LR    3,6           Packet length                     @SC86154
         LR    5,6                                             @SC86154
         LR    4,7           Ptr to packet                     @SC86316
         MVCL  2,4           Copy packet to buffer             @SC86154
         CLI   TRMTP,C'T'                                      @SC87166
         BE    SIOTTY        Go if not S/1?                    @SC87166
         CLI   TRMTP,C'F'                                      @SC87300
         BE    SIOTTY        Go if not S/1?                    @SC87300
         SR    2,1           Total length                      @SC86154
         ST    2,S1WRPL+4    Store len in CCW                  @SC86154
         L     4,ASCRNIO     I/O routine for fullscreen        @SC87275
         LA    5,S1WRPL      1st plist                         @SC87275
SIOGO    LM    7,8,0(5)                                        @SC87275
         BAL   9,RIORAW      Log it                            @SC86316
         LA    0,4           Write                             @SC86295
         KCALL (4),(5),E=(RIOER,M)                             @SC87275
         CLI   TRMTP,C'G'                                      @SC87215
         BE    SIOGOOD       No immediate answer if graphics   @SC87215
         LA    0,5                                             @SC86295
         KCALL (4),8(5),E=(RIOER,M) Read it now                @SC87275
         CLI   WRRD,0        Write/read?                       @SC86301
         BE    SIOGOOD       No, ignore bare status            @SC86301
         LTR   15,15                                           @TB87009
         BP    SIOCOM                                          @TB87009
         CLI   TRMTP,C'T'                                      @SC87275
         BE    SIOCOM        No problem if TTY                 @SC87275
         CLI   TRMTP,C'F'                                      @SC87300
         BE    SIOCOM        No problem if TTY                 @SC87300
* If only 3 bytes (AID and cursor) come in, VTAM has caused    @TB87009
* the S/1 to discard its transparent data. Fill the screen and @TB87009
* read it back in protocol conversion mode to cause VTAM       @TB87009
* to put up a longer READ MODIFIED CCW at its next read.       @TB87009
         LA    0,6           Message (Leave Transparent Mode)  @TB87009
         KCALL SCRNIO,SIORTPL,E=(SIORTY,M)                     @TB87009
         LA    0,5                                             @TB87009
         KCALL SCRNIO,S1RDPL,E=(RIOER,M) Rdmod to prime VTAM.  @TB87009
SIORTY   SR    15,15         No data actually seen.            @TB87009
SIOCOM   DS    0H                                              @TB87009
         ST    15,RIOC               save residual byte count
SIOGOOD  NI    FL1,255-NAK0  Something sent now                @SC86295
         B     RTRN0                                           @SC86295
*
SIOTTY   L     1,TYWRPL      Skip S/1 stuff                    @SC86295
         SR    2,1           Length to write                   @SC86154
         ST    2,TYWRPL+4    Length                            @SC86295
         LA    15,ATOE       Send in EBCDIC                    @SC86202
         TM    FL4,TTAB      Using separate terminal tables?   @SC87117
         BZ    *+8           No                                @SC87117
         LA    15,TATOE      Yes                               @SC87117
         LR    3,2           Length                            @SC87281
         LR    2,1                                             @SC86202
         BAL   14,TRANSLAT   Do the translate                  @SC86202
         L     4,ATERMIO     I/O routine for TTY               @SC87275
         LA    5,TYWRPL      1st plist                         @SC87275
         B     SIOGO         Now do it                         @SC87275
*                                                              @TB87009
SIORTPL  DC    A(SIOMSGXX,SIOMSL)                              @TB87009
* Greetings for ERROR mode                                     @TB87009
SIOMSGXX DC    X'&S1CMD',AL1(SBA),X'4040'                      @TB87009
         DC    C'S/1 VTAM Error Recovery '                     @TB87009
         DC    X'3C5D7F40'   Repeat blanks to end of screen    @TB87009
SIOMSL   EQU   *-SIOMSGXX                                      @TB87009
         LOCALS ,                                              @SC86295
SIORIO   DS    C             Operation code                    @SC86316
SIO      EXIT
         TITLE 'INTINI Routine - Initialize console for protocol'
* If R1 is 0, reset the traps unless in Server mode.
* If R1 is positive, set up console traps for protocol:
*  1 for SERVER, 2 for SEND, 3 for RECEIVE, 4 for short msg    @SC86184
* R15 = 0 on return if ok
*
INTINI   ENTER
         MVI   WRRD,5        Reset w/r flag                    @SC86184
         TM    FL2,SRV
         BO    INTINIR               Return if server running
         LTR   3,1           Call type: 0 or 1-5               @HF86232
         BZ    INTINICL              If R1 is 0 clear traps
         OI    FL2,PROTO     Line open for transfer            @SC86295
         ICM   5,15,LCLDLY   No delay?                         @HF86232
         BNZ   INTINIDL                                        @HF86232
         LA    1,5           Yes, use no message               @HF86232
INTINIDL C     1,F5          No delay or non-protocol send?    @HF86232
         BE    INTINIMS      Yes                               @HF86232
         BCT   5,INTINIMS    Short delay?                      @HF86232
         LA    1,4           Yes, use short message anyway     @SC86184
INTINIMS SLL   1,3           8-byte indexing                   @HF86232
         LA    5,INTCCWSR-8(1)  Get ptr to correct CCW         @SC86184
         MVC   SVHND,S1HND   Save handshake character          @SC87343
         KCALL SETMSG,2,E=INTINERR Prepare line for transfer   @SC87300
         LA    0,2                                             @SC87309
         SR    0,3                                             @SC87309
         LPR   0,0           Get ABS(code-2)                   @SC87309
         BCT   0,*+8         Test for Serve or Rec codes (1,3) @SC87309
         OI    FL1,NAK0      Send NAK during retry, if any     @SC87309
         MVI   RIOC,X'80'    Clr any prev byte count           @SC86295
         CLI   TRMTP,C'T'                                      @SC87166
         BE    INTINITY      Go if TTY                         @SC87166
         CLI   TRMTP,C'F'                                      @SC87300
         BE    INTINITY      Go if TTY                         @SC87300
         LA    0,1           Open screen                       @SC86295
         KCALL SCRNIO                                          @SC86295
         LA    0,6           Simple write                      @SC86316
         KCALL SCRNIO,(5),E=(INTINIR,M)  Message               @SC86295
         C     3,F2          Was this SEND?                    @SC86184
         BE    INTINIR               SEND does sleep anyway
         ICM   0,15,LCLDLY   See if speed wanted               @SC87253
         BZ    INTINIP       Yes, no greetings anyway          @SC87309
         LA    0,1           Wait 1 sec                        @SC86295
         KCALL SUPFNC,9      This seems essential              @SC86295
INTINIP  CLI   TRMTP,C'G'    Graphics terminal?                @SC87309
         BNE   INTINIR       No, go ahead                      @SC87309
         TM    FL1,NAK0      Will we receive?                  @SC87309
         BZ    *+8           No, fine                          @SC87309
         BAL   2,SENDNAK     Yes, must prompt hardware         @SC87309
         B     INTINIR
*
INTINITY L     1,0(5)        Text address from ccw             @SC86184
         LH    4,6(5)        Get total length                  @SC86184
         LA    3,INTPRL(1)   Skip over WCC and SBA             @SC86184
         SH    4,*-2          and deduct that from length      @SC86184
         C     4,F64                                           @SC86184
         BL    INTINIT2      Just one (short) line             @SC86184
         LA    4,80                  Length to type
         WTEXT (3),(4)
         LA    3,80(3)               Next line
INTINIT2 WTEXT (3),(4)                                         @SC86184
         LA    0,1                                             @SC86295
         KCALL TERMIO        Open line                         @SC86295
         B     INTINIR
*
INTINICL TM    FL2,PROTO     Was line open?                    @SC86295
         BZ    INTINIR       No                                @SC86295
         LA    0,2                                             @SC86295
         L     15,ATERMIO                                      @SC87300
         CLI   TRMTP,C'T'                                      @SC87300
         BE    INTINIK       Go if TTY                         @SC87300
         CLI   TRMTP,C'F'                                      @SC87300
         BE    INTINIK       Go if 3708/fullscreen             @SC87300
         L     15,ASCRNIO                                      @SC87300
INTINIK  KCALL (15)          Release line                      @SC87300
         KCALL SETMSG,3                                        @SC86316
         MVC   S1HND,SVHND   Restore handshake character       @SC87343
INTINIR  B     RTRN0                                           @SC87300
*
INTINERR NI    FL2,255-PROTO Turn off protocol mode            @SC87300
         MVI   ERRNUM,ERRCOM Bad comm line                     @SC87300
         B     RTRN1                                           @SC87300
*
         DS    0D
INTCCWSR DC    A(INTMSGSR,INTPRL+80+80)                        @SC86295
INTCCWSN DC    A(INTMSGSN,INTPRL+80+80)                        @SC86295
INTCCWRC DC    A(INTMSGRC,INTPRL+80+80)                        @SC86295
INTCCWQU DC    A(INTMSGQU,INTQL)                               @SC86295
INTCCWNL DC    A(INTMSGQU,INTPRL)                              @SC86295
* Short greetings                                              @SC86184
INTMSGQU DC    X'&S1CMD',AL1(SBA),X'4040'                      @SC86295
INTPRL   EQU   *-INTMSGQU    Length of prefix                  @SC86295
INTMSGQ2 DC    C'Kermit-&KSYS....'                             @SC86268
INTQL    EQU   *-INTMSGQU                                      @SC86184
* Greetings for RECEIVE mode
INTMSGRC DC    X'&S1CMD',AL1(SBA),X'4040'                      @SC86295
 DC CL80'Kermit-&KSYS ready to receive.'                       @SC86268
 DC CL80'Please escape to local Kermit now to SEND the file(s).'
* Greetings for SEND mode
INTMSGSN DC    X'&S1CMD',AL1(SBA),X'4040'                      @SC86295
 DC CL80'Kermit-&KSYS ready to send.'                          @SC86268
 DC CL80'Please escape to local Kermit now to RECEIVE the file(s).'
* Greetings for SERVER mode
INTMSGSR DC    X'&S1CMD',AL1(SBA),X'4040'                      @SC86295
 DC CL80'Entering server mode.  Please escape to local Kermit now.'
 DC CL80'To terminate the server use the BYE or FINISH commands.'
*
         LOCALS ,                                              @SC86295
INTINI   EXIT
         TITLE 'INBUF Routine - read next disk record into WBUF'
* Exit: R15=0 if ok, -1 if EOF, 1 if read error (ERRNUM set)
INBUF    ENTER
         TM    FL1,EOF
         BO    RTRNM1        Go if hit eof already             @SC86295
         SR    15,15         In case reading from memory       @SC86158
         ST    15,RBUFP      Clear read buffer pointer         @SC86158
         ST    15,RBUFL      Clear read buffer length          @SC86158
         L     9,RBUF        Read into this buffer             @SC86158
         TM    FL4,SFM       Source is memory?                 @SC86158
         BZ    IBFDSK        No, read disk                     @SC86158
         LM    4,5,TXTPTR    Yes, copy to buffer               @SC86158
         CR    4,5           Any left?                         @SC86158
         BNL   IBFEOF        No, quit                          @SC86158
         XC    CMD,CMD                                         @SC86158
         MVI   CMD+X'15',1   Set up TRT                        @SC86158
         MVC   0(256,9),0(4) Copy one line or so               @SC86158
         LA    1,256(4)      In case no NL                     @SC86158
         TRT   0(256,4),CMD  Scan for NL                       @SC86158
         CR    1,5           No X'15'?                         @SC86158
         BNH   *+6           OK                                @SC86158
         LR    1,5           Limit is end of data              @SC86158
         SR    1,4           Length of line                    @SC86158
         LA    4,1(1,4)                                        @SC86158
         ST    4,TXTPTR      Update ptr                        @SC86158
         LR    0,1           Save length                       @SC86158
         B     IBFXLAT       Go change to ASCII                @SC86158
IBFDSK   DS    0H                                              @SC86158
         ICM   2,15,RDWLEN   Special format?                   @SC86151
         BZ    *+6           No                                @SC86151
         AR    9,2           Space over record descriptor      @SC86151
         READF FILPTR,BUFFER=(9),E=IBFERR                      @SC87034
         LM    14,15,DSKTOT  Update disk count                 @SC86295
         ALR   15,0                                            @SC86295
         BNO   *+8                                             @SC86295
         AL    14,F1                                           @SC86295
         STM   14,15,DSKTOT  Save new count                    @SC86295
         LTR   2,2           Special format?                   @SC86151
         BZ    IBFNRM        No                                @SC86151
         SR    9,2           Back up to start of buffer        @SC86151
         STCM  0,3,0(9)      Store length                      @SC86151
         C     2,F2          Short?                            @SC86262
         BE    IBFVLEN       Yes                               @SC86262
         CVD   0,TMPDW       No, use 5-byte ASCII              @SC86262
         OI    TMPDW+7,15                                      @SC86262
         UNPK  0(5,9),TMPDW                                    @SC86262
         TR    0(5,9),ETOA                                     @SC86262
IBFVLEN  DS    0H                                              @SC86262
         AR    0,2                                             @SC86151
         B     IBFLEN        Must be binary                    @SC86151
IBFNRM   DS    0H                                              @SC86151
         TM    FL1,BINF
         BO    IBFLEN                No trans for binary file
         ICM   1,15,RMARG    Text file: check margins          @SC87253
         BZ    IBFCKLM       No right margin specified         @SC87253
         CR    0,1                                             @SC87253
         BNH   IBFCKLM       Record is shorter than margin     @SC87253
         LR    0,1           Truncate record at margin         @SC87253
IBFCKLM  L     1,LMARG                                         @SC87253
         S     1,F1                                            @SC87253
         BNP   IBFXLAT       No left margin, or start in col 1 @SC87253
         SR    0,1           See if record is long enough      @SC87253
         BNP   IBFEMPT       Too short, make empty record      @SC87253
         LR    2,9           Ptr to record                     @SC87253
         LR    3,0           Shortened length                  @SC87253
         LA    4,0(1,2)                                        @SC87253
         LR    5,3                                             @SC87253
         MVCL  2,4           Eliminate stuff before margin     @SC87253
IBFXLAT  LA    15,ETOA       Change to ASCII                   @SC86202
         LR    2,9           Address                           @SC86202
         LR    3,0           Length                            @SC86202
         BAL   14,TRANSLAT   Do the translate                  @SC86202
         AR    9,0           Point one past last char
IBFTRUNC BCTR  9,0                   Back up one
         CLI   0(9),ABL
         BNE   IBFLCHAR              Found non-blank
         BCT   0,IBFTRUNC            FIND LAST CHAR
IBFEMPT  SR    0,0           Record is empty                   @SC87253
         BCTR  9,0           Empty record                      @SC86119
IBFLCHAR MVI   1(9),CR       Add CR                            @SC86135
         MVI   2(9),ALF      Add LF                            @SC86135
         A     0,F2                  Two extra bytes of data
IBFLEN   ST    0,RBUFL               LRECL or LRECL + 2 (FOR CRLF)
         B     RTRN0
*
IBFEOF   OI    FL1,EOF
         B     RTRNM1                                          @SC86295
*
IBFERR   C     15,F12                EOF code?
         BE    IBFEOF                Yes
         ERRF  ,             Disk read error, analyze it       @SC87338
         CLOSF FILPTR        Close file                        @SC86295
         B     RTRN1                                           @SC86295
         LOCALS ,                                              @SC86295
INBUF    EXIT
         TITLE 'OUTBUF Routine - write WBUF to a disk file'
OUTBUF   ENTER
         L     9,WBUFL               Amount of data to write
         SR    6,6                                             @SC86295
         ICM   6,3,LRECL     Use to hold lrecl                 @SC86295
         L     7,WBUF                Address of buffer
         ICM   2,15,RDWLEN                                     @SC86151
         BZ    OBFNRM                                          @SC86151
         SR    1,1           Special format                    @SC86151
         ICM   1,3,0(7)      Get true record length            @SC86151
         C     2,F2          Short?                            @SC86262
         BE    OBFVLEN       Yes                               @SC86262
         PACK  TMPDW,0(5,7)  No, must be 5-byte ASCII          @SC86262
         OI    TMPDW+7,15    Get + sign                        @SC86262
         CVB   1,TMPDW       Convert back to binary            @SC86262
OBFVLEN  DS    0H                                              @SC86262
         AR    7,2           Skip over descriptor              @SC86151
         SR    9,2           Correct length                    @SC86151
         L     15,FILPTR     Ptr to disk FAB                   @SC87351
         MVC   FABCOMM-FABD(8,15),=CL8'Binary'                 @SC87351
         LA    15,15         Suitable disk error               @SC86151
         CR    1,9           Match?                            @SC86151
         BNZ   OBFERR        No, give up                       @SC86151
         B     OBFLEN        Do it                             @SC87351
OBFNRM   DS    0H                                              @SC86151
         TM    FL1,BINF
         BO    OBFLEN                Go if binary data file
         LTR   9,9                   Any data to write?
         BNZ   OBFTR                 Yes, there's data
         MVI   0(7),ABL              Make first char a space
         LA    9,1                   Length of one
OBFTR    LA    15,ATOE       Change to EBCDIC                  @SC86202
         LR    2,7                                             @SC86202
         LR    3,9           Length                            @SC86202
         BAL   14,TRANSLAT   Do the translate                  @SC86202
OBFLEN   CLI   FRECF,C'F'                                      @SC87012
         BNE   OBFWRT        Go if variable format             @SC87012
         TM    FL3,APPN      Appending to old file?            @SC86203
         BZ    *+8           No, use LRECL                     @SC86203
         L     6,FSIZE       Yes, use old size                 @SC86203
         CR    9,6                   Compare data length and lrecl
         BE    OBFWRT        Go if lrecl exactly               @SC87268
         BH    OBFTRNC       Go if must truncate               @SC87268
         LR    1,6                   Else, get lrecl size
         SR    1,9                   Pad with this many spaces
         LA    0,0(9,7)              Where to start padding
         SR    15,15                                           @SC86295
         TM    FL1,BINF                                        @SC86295
         BO    *+8                                             @SC86295
         ICM   15,8,BLANK    Pad with spaces                   @SC86295
         MVCL  0,14                  Do it
         B     OBFLRECL      And note new length               @SC87268
OBFTRNC  LA    0,1                                             @SC87268
         A     0,RECTRC                                        @SC87268
         ST    0,RECTRC      Increment count of truncations    @SC87268
OBFLRECL LR    9,6                   Length has to be this size
OBFWRT   LM    14,15,DSKTOT  Update disk count                 @SC86295
         ALR   15,9                                            @SC86295
         BNO   *+8                                             @SC86295
         AL    14,F1                                           @SC86295
         STM   14,15,DSKTOT  Save new count                    @SC86295
         WRITF FILPTR,BUFFER=(7),BSIZE=(9)                     @SC87034
         LTR   15,15                 Any disk write errors?
         BZ    OBFRET                Nope, all OK
         MVI   ERRNUM,ERRFUL Maybe disk is full                @SC86345
         CLM   15,1,ERRNUM   Is it?                            @SC86345
         BE    OBFRET        Yes, too bad                      @SC86345
OBFERR   ERRF  ,             General write error, analyze it   @SC87338
OBFRET   RET
         LOCALS ,                                              @SC86295
OUTBUF   EXIT
         END   KERMIT
