This PDS contains documentation and JCL to install code on a system
running Perl and PostgreSQL. This code emulates the DB2 code supplied
by IBM with z/OS.

This documentation assumes that you or your are familar with:
    z/OS
    RACF on z/OS
    Linux
    Perl on Linux
    PostgreSQL on Linux
    How to do SQL queries (at the psql prompt and/or in Perl)
This documentation does not attempt to teach you about these.

In particular, this PDS contains the following members:
1. $DOC     - This member, which contains the basic documentation
2. HASX20B  - This member is a JES2 exit which puts a value in the
              JCTUSEID field of the $JCT. This is then placed in all
              of the SMF records generated by this job, in the SMFnUIF
              field.
3. IRRADU00 - This member is example JCL to create the RACF activity
              records to be sent to your Linux system.
4. IRRDBU00 - This member is example JCL to create the RACF database
              unload dataset to be sent to your Linux system.
5. RECEIVE  - The basic JCL to create the file which is to be
              ftp'ed to the Linux system and then ftp that file
              to the Linux system.
              This member must be customized as described therein.
6. TARFILE  - This member contains the output of an XMIT command.
              This member must be RECEIVE'd (see RECEIVE member)
              in order to create a sequential file. This sequential
              file must then be binary ftp'ed to the Linux system
              upon which the system will run. This sequential file
              is the output from a tar command, run on Linux, which
              was binary ftp'ed to a z/OS system. Don't bother trying
              to read it, it looks like binary junk.

=======================================================

Steps required to install and use this facility

1. Run the RECEIVE job. This job will create the tar file in an MVS
   sequential file. The second step will the ftp this to your Linux
   system. Please note that you must customize the ftp step with the
   IP address of your Linux system as well as the appropriate userid
   and password on your Linux system.

2. If needed, run the example jobs:

   IRRADU00 - This job creates the RACF activity reformatted dataset
              on your MVS system.

   IRRDBU00 - This job creates the dataset which contains the unloaded
              RACF database.

3. The remainder of the steps must be done on your Linux system.
   Logon to it.

4. Change to the "newracf" subdirectory created by the RECEIVE job.

5. Use ftp to download the datasets created by the IRRADU00 and
   IRRDBU00 jobs.  You must remember to preserve trailing blanks or
   the load Perl programs will not work correctly. If you are using
   the IBM TCP/IP stack, this is done with the ftp subcommand:
       quote site trailingblanks
   This is an "ascii" download.  In my examples below, I assume that
   the IRRADU00 output is downloaded to the file "irradu00.data" and
   the IRRDBU00 output is downloaded to the file "irrdbu00.data".

   Please note that the irradu00.data file may be very large,
   depending on your RACF options and activity. For example, on my
   system, one weeks worth of data is around 3.5 gigabytes once it is
   downloaded. Once processed, this data can either be deleted or you
   can use the bzip2 or gzip program to decrease its size.  When I
   used bzip2 on the 3.5 gigabyte file, it was reduced to only 10
   megabytes! That is 350 to 1 compression. The Perl programs cannot
   directly read this compressed file, but you could invoke them by
       bzcat input.file.bz2 | ./perl-program.pl
   instead of
       ./perl-program.pl input.file
   This will, of course, cause the programs to run slower.

6. Create the "racf" database and tables by entering the following
   commands:  From the shell, enter the command "psql" to get a
   PostgreSQL command prompt.  Once in psql, enter the following
   commands:

       create database racf;
       \c racf
       \i racdbutb.psql
       \i irradutb.psql
       \i create_jobinit_index.psql
       \i create_jobstart-jobend_views.psql
       \i create_and_load_viol.psql
       \q

   -- or --

   Run the shell command:
      ./create_racf_database.sh

   Note that all my Perl programs and psql script depend on the
   database being named "racf". If you want to use some other database
   to contain the tables, you must search for where "racf" is used as
   a database name and change it to your database name.

7. Run the Perl program "racdbuld.pl" by entering:
       ./racdbuld.pl irrdbu00.data
   This program will abort (die) with an error message if there is any
   problem.  The program will output a message for every 1000 lines of
   input which it reads. This is for your comfort that it is doing
   something. This program does not issue a "commit" until all records
   have been successfully processed.  When this program completes, the
   RACF database information will have been loaded into a number of
   PostgreSQL tables, which are The easiest way to find the names of
   the tables created and the columns defined in them is by looking at
   the racdbuld.txt file.

8. Create and load the "auth_ids" table by entering the shell command:
       psql <create_and_load_auth_ids.psql

9. Run the Perl program "irraduld.pl" by entering:
       ./irraduld.pl irradu00.data
   Due to its large size, this program takes quite a while to start
   up.  The program will abort (die) with an error message if an error
   occurs.  The program will output a message for every 1000 lines of
   input which it reads. It will also issue a "commit" at this time.
   The message is to assure you that it is running. When the program
   completes, the RACF activity information will have been loaded into
   a number of PostgreSQL tables. The easiest way to find the names of
   the tables created and the columns defined in them is by looking at
   the racdbutb.txt file.

10. At this point the "racf" database will have all of its tables
    defined and information loaded into them.

11. You will periodically need to rerun the IRRDBU00 job, download the
    output and rerun the irrdbuld.pl program and the
    create_and_load_auth_ids.psql script as documented in steps 7 and
    8. This is to keep the information current. Note that the
    irrdbuld.pl program will remove all the old information.

12. You will need to periodically run the IRRADU00 job, download the
    output and run the "irraduld.pl" program. This is to keep
    information current.  Note that unlike the "irrdbuld.pl" program,
    the "irraduld.pl" program does not clear out old information. It
    is the responsibility of the user of this data to periodically
    purge it from the system.

13. Optionally, install the HASX20B exit in JES2. I don't have a JES3
    equivalent due to lack of knowledge of JES3.

=======================================================

Maintenance of the programs and scripts is the your responsibility. If
you go to a new release of z/OS and RACF has been enhanced, there is a
possibility that any of the members:  IRRADULD, IRRADUTB, RACDBULD, or
RACDBUTB may be changed. If this occurs, you will likely be able to
use the new RACF functionality by downloading those members and running
the the various Perl program which begin with "mk". These programs and
how to run them are documented below. I will attempt to keep my
version of these programs up to date. But I cannot guarantee that I
will be able to do so.

However, doing the above may result in data loss. This is because
these Perl programs are not designed to "upgrade" the tables with new
columns, but to delete the current tables and replace them with new
tables.

I will mention that the "mk" programs are dependant on the way that
IBM has formatted the commands contained within them. There are many
ways to format these commands. The "mk" scripts are not intelligent
enough to decode every possible legal formatting.

=======================================================

The contents of the tar file are:

45day.psql
  This shows how to get a report of RACF userids not accessed in 45
  days. You execute this interactively by using the "\i" command in
  an interactive "psql" session. This is true of all files which
  end in ".psql".

90day.psql
  The same as the above, only with 90 days as the interval.

adusymbl.txt
  This is the contents of SYS1.SAMPLIB(ADUSYMBL). I currently do not
  use it for anything.

create_access_indices.psql
  This psql script simply defines some indices on the ACCESS table which
  should help with some queries. Running it is optional. Having these
  indices does slow down the loading of data into the ACCESS table.

create_and_load_auth_ids.psql
  This Perl program creates and loads the AUTH_IDS table. It must
  be run after the "racdbuld.psql" program is run.

create_and_load_viol.psql
  This psql script creates a table with two fields. One field contains
  the values (as of z/OS 1.5) which may occur in the "init_event_qual"
  field of the JOBINIT table. This field is the primary key. The second
  field contains an English explaination of what it means.

create_jobinit_index.psql
  This psql script creates two PostgreSQL indices on the "jobinit"
  table. You need not run this for other things to work. I used it
  to increase the performance of some queries.

create_jobstart-jobend_views.psql
  This psql script creates two views. They are both on the "jobinit"
  table. One view is for when a job started. The other is for when
  a job ended. I use these view in the "jobsrun.psql" script to report
  on job executions. The simplify some SELECT commands.

create_racf_database.sh
  This shell script simply issues the psql command necessary to create
  the racf database and most of its tables.

dbusplit.pl
  This Perl program is designed to read the output from IRRDBU00 and
  report on the counts for the various record types.

dbusymbl.txt
  This is the contents of SYS1.SAMPLIB(DBUSYMBL). I currently do not
  use it for anything.

dsn_access.psql
  This is just an example psql script relating dataset names and the
  accesses granted to them.

irradu00_count.pl
  This Perl program can read the IRRADU00 output and give you the
  counts of how many rows will be inserted into which tables. It is
  just an example of using Perl to directly read the IRRADU00 output
  for some simple functionality.

irraduld.pl
  This is a very large Perl program. This program reads the output
  from IRRADU00 and loads the data into the various tables. This
  Perl program is created by the mkirraduld.pl program.

irraduld.txt
  This is the contents of SYS1.SAMPLIB(IRRADULD). This file is read
  by the mkirraduld.pl program in order to create the irraduld.pl
  program.

irradutb.psql
  This psql script creates the tables used by the irraduld.pl program.
  You must run this psql script before running the irraduld.pl program.
  This script assumes that the tables DO NOT exist. If they already
  exist, it will generate a lot of error messages.
  I generated this file "by hand" from the irradutb.txt file. It is
  ugly.

irradutb.txt
  This is the contents of SYS1.SAMPLIB(IRRADUTB). I used this file
  as the basis for the irradutb.psql file.

jobsrun.psql
  This psql script generates a listing of all jobs which successfully
  initiated and / or terminated.

jobs_with_errors.psql
  This psql script is supposed to generate output listing all jobs
  which had a problem such as "Invalid Password".

mkdb2load.pl
  This Perl program is used to create the irraduld.pl and racdbuld.pl
  programs. It is run by issuing the commands:

  export database='racf'
  ./mkdb2load.pl irraduld.txt >irraduld.pl
  chmod 755 irraduld.pl

  export database='racf'
  ./mkdb2load.pl racdbuld.txt >racdbuld.pl
  chmod 755 racdbuld.pl

  You must export the environment variable "database" to name the
  database in which the tables are created. If you use something other
  than "racf", then you must change all the *.psql files to use that
  database in the "\c racf" control statement.

  The plus of this is that it is driven by either the irraduld.txt or
  racdbuld.txt files. This means that if IBM changes RACF, and the
  SYS1.SAMPLIB(IRRADULD) member or SYS1.SAMPLIB(RACDBULD) member, the
  irraduld.pl and racdbuld.pl programs can be updated simply. I assure
  you that you don't want to create these programs by hand.

  This program removes all DB2 comments and any data in columns 73-80
  so there is should be no need to "clean up" the DB2 LOAD control
  statements.

  Actually, this program should be able to create a Perl program to
  load any set of tables for which you have LOAD control statement of
  the DB2 utilities.

mktar.sh
  This shell script creates the gzip'ed tar file with all the *.pl,
  *.sh, *.txt, *.psql files in it.

noowner.psql
  This psql script simply shows those resources which reference an
  owner which no longer exists. Actually, it is much easier to get
  this report by using the IRRRID00 program supplied by IBM with RACF.

noseq.pl
  This Perl program is used to remove any sequence numbers in columns
  73 through 80, then remove any trailing blanks.

racdbuld.pl
  This Perl program loads the output of the IRRDBU00 program into
  the PostgreSQL tables. This is based on the z/OS 1.4 version of
  the racdbuld.txt file.

racdbuld.txt
  This is the contents of SYS1.SAMPLIB(RACDBULD). This file is read
  by the mkracdbuld.pl program in order to create the racdbuld.pl
  program.

racdbuqr.txt
  This is the contents of SYS1.SAMPLIB(RACDBUQR). It is not used for
  any particular purpose. I just keep it around for reference.

racdbutb.psql
  This psql script creates the PostgreSQL tables needed by the
  racdbuld.pl program. It was created, by hand, by editting the
  racdbutb.txt file.

racdbutb.txt
  This is the contents of SYS1.SAMPLIB(RACDBUTB). I used it to create
  the racdbutb.psql file.

remove_carriage_returns.pl
  This is another weird utility that I had to create due to the way
  that I got the IRRADU00 and RACDBU00 output onto my Linux system at
  home. This routine basically does the same thing as "dos2unix".
  Unfortunately, "dos2unix" did not work on the above outputs due
  to embedded binary data placed by CA-7 in the "SMFUSER" fields.

remove_db2_comments.pl
  This is a utility which simply strips out all DB2 and SPFUI
  comments.  I created it to simplify some files that I was working
  with.  It is not needed before sending a "control file" to the
  mkdb2load.pl program.

sortsymbl.pl
  This program simply reads its input file and writes it out, excluding
  any lines which start with an asterisk. I don't remember why I wrote
  it. Likely it had something to do with the "adusymbl.txt" and
  "dbusymbl.txt" files which I ended up not using.

==========================================================

