//DISASTER JOB (0904,0012,TIME,200),GERHARD,CLASS=A,PRTY=1,TIME=35
/*SETUP       MVT004 PLUS MISCELLANEOUS TAPES;  IN SEQUENCE :
/*MESSAGE     2859  2858  2857  2855  2853  2856  2852  2854  2862
/*MESSAGE     2851  2850  2849  2848  2861  2847  2846  2845  2844
/*MESSAGE     2843  2842
// EXEC PL1LFCLG,REGION.GO=150K,TIME.GO=30
 /* FIND SPECIFIED MEMBERS OF OPTIONAL SOURCE MATERIAL TAPES */
 FINDIT: PROC(PARM) OPTIONS(MAIN);
0/*
 THIS PROGRAM WAS WRITTEN BY:

      SEYMOUR JEROME METZ
      PINKERTON COMPUTER CONSULTANTS, INC.
      5881 LEESBURG PIKE
      BAILEYS CROSSROADS, VIRGINIA  22041
      703-820-5571

 THIS PROGRAM IS FURNISHED ON AN AS-IS BASIS.
 IT IS NOT PROPRIETARY, AND MAY BE DISTRIBUTED TO
      ANY OTHER INSTALLATION.
 FEEL FREE TO CONTACT ME IF ANY PROBLEMS OCCUR.
 */
1
 DCL
      PARM CHAR(*),
      (
      CARD CHAR(80),
      CCARD CHAR(80),
      MT BIT(1) INIT('1'B),
      OPEN BIT(1) INIT(0),
      OLD_NAME CHAR(8) VAR INIT(''),
      OLD_VOL CHAR(6) INIT(' '),
      OLD_SEQ FIXED BIN INIT(0),
      SEQ FIXED BIN,
      DSN CHAR(44) VARYING INIT('')
      ) STATIC;
0DCL  1  MODCARD ,  2 MODLEN CHAR(80)  INIT(' '),
      1  OTHCARD DEF MODCARD,
         2  MODULE CHAR(8),
         2  FILL1 CHAR(2),
         2  VOL   CHAR(6),
         2  FILL2 CHAR(2),
         2  FILE  CHAR(2),
         2  FILL3 CHAR(2),
         2  NAME  CHAR(8),
         2  FILL4 CHAR(2),
         2  SSI   CHAR(8),
         2  FILL5 CHAR(40);
-DCL
 SYSUT1 RECORD ENV(F(14400,80));
 DCL  SYSUT2 RECORD; /* ENV(F(3360,80)) */
 DCL  LISTING PRINT;
0DCL MODJFCB EXTERNAL ENTRY(
      CHAR(8), CHAR(6), FIXED BIN(15,0), CHAR(44) VARYING);

 OPEN FILE(SYSIN) INPUT STREAM;
 ON ENDFILE(SYSIN) GO TO HELL;

 ON ERROR SNAP BEGIN;
     ON ERROR SNAP CALL IHEDUMP;
     DISPLAY('ERROR WAS SIGNALLED');
     CALL IHEDUMP;
     END;

 MAIN_LOOP: PUT LIST(' ') SKIP(2); GET EDIT(CARD) (A(80)) COPY;
 /* CRUDE, BUT ALL VERY WELL FOR A SPREE */
 IF SUBSTR(CARD,1,1)=' ' THEN DO;
      PUT LIST('SCHMUCK, COL 1 IS BLANK');
      CALL IHESARC(4095);
       RETURN;
      END;
0/* CHECK FOR DSN OPTION */
 IF SUBSTR(CARD,1,4)='DSN=' THEN DO;
      DSN=SUBSTR(CARD,5,44);
      GO TO MAIN_LOOP;
      END;
0/* FIND LENGTH OF VOLUME SERIAL */
 I=INDEX(CARD,' ')-1;
 IF (I<0) | (I>6) THEN GO TO BAD_BOOK;
 VOL=SUBSTR(CARD,1,I);
0/* FIND FILE SEQUENCE NUMBER */
 DO I1=I+1 TO 71 WHILE(SUBSTR(CARD,I1,1)=' '); END;
 IF I1>70 THEN GO TO BAD_MOUTH;
 IF SUBSTR(CARD,I1+1,1)=' ' THEN DO; FILE=SUBSTR(CARD,I1-1,2);
      SEQ=SUBSTR(CARD,I1,1);    END;
      ELSE
 IF SUBSTR(CARD,I1+2,1)=' ' THEN DO;
      FILE=SUBSTR(CARD,I1,2);   SEQ=FILE;
      I1=I1+1;
      END;
      ELSE GO TO BAD_MOUTH;
0/* FIND NAME */
 DO I=I1+1 TO 75 WHILE(SUBSTR(CARD,I,1)=' '); END;
 IF I>74 THEN DO;
     NAME=(8)'9'; GO TO NO_NAME; END;
 I1=INDEX(SUBSTR(CARD,I+1),' ');
 IF (I1=0)|(I1>8) THEN GO TO FOUL_MOUTH;
 NAME=SUBSTR(CARD,I,I1);

 NO_NAME: /* CARD IN FORM SER SEQ IS USED TO LIST WHOLE FILE */
0/* PREFIX SHORT NUMERIC VOL-SER'S */
 IF (SUBSTR(VOL,1,1) >= '0') & (SUBSTR(VOL,5,1) = ' ') THEN
      VOL= 'M' || VOL;
0/* TEST FOR SAME-VOLSER OPTION */
 IF VOL='*' THEN VOL=OLD_VOL;

 IF (OLD_VOL = VOL) & (OLD_SEQ = SEQ) THEN GO TO LEAVE_OPEN;
0RE_OPEN: IF OPEN THEN DO;
 /* IF SYSUT1 IS OPEN, THIS CODE WILL REDUCE REPOSITIONING TIME.
    THERE ARE THREE CASES. */
     IF OLD_VOL = VOL THEN
0                            /* SAME TAPE FURTHER ON */
         IF OLD_SEQ < SEQ THEN CALL SETLEAV(SYSUT1);
0                            /* SAME TAPE EARLIER */
                          ELSE CALL SETRERD(SYSUT1);
0                            /* NEW TAPE */
                             /* POSITION OLD TAPE AS PER DISP ON DD */
         ELSE CALL SETDISP(SYSUT1);
0    CLOSE FILE(SYSUT1);
     END;
 OLD_NAME=''; MT='1'B;
-/* AT THIS POINT, ADD CODE FOR MULTI-FILE, MULTI-VOLUME */
 IF VOL = '      ' THEN GO TO BAD_BOOK;
 CALL MODJFCB( 'SYSUT1  ', VOL, SEQ, DSN );
 /* THIS IS STILL A MAKE-SHIFT FOR A COMPLETE PACKAGE */
-
 OPEN FILE(SYSUT1) RECORD INPUT;
 OPEN='1'B;
 ON ENDFILE(SYSUT1) GO TO MAIN_LOOP;
 /* DEFER CLOSE UNTIL DISP IS CALLED, BASED ON NEXT CONTROL CARD */
0/* BE PREPARED TO REPROCESS SAME MEMBER */
 LEAVE_OPEN: IF NAME <= OLD_NAME THEN GO TO RE_OPEN;
 OLD_NAME=NAME;
 OLD_VOL=VOL;
 OLD_SEQ=SEQ;
0LOOK_LOOP: IF MT THEN READ FILE(SYSUT1) INTO(CCARD);
 MT='1'B;
 IF SUBSTR(CCARD,1,3) ¬= './ ' THEN GO TO LOOK_LOOP;
 PUT LIST(CCARD) SKIP;
0/* FIND OPCODE */
 DO I=3 TO 40 WHILE(SUBSTR(CCARD,I,1)=' '); END;
 IF SUBSTR(CCARD,I,4) ¬= 'ADD ' THEN GO TO LOOK_LOOP;
0/* FIND OPERAND */
 DO I1=I+4 TO 50 WHILE(SUBSTR(CCARD,I1,1) = ' ' );
      END;
 IF I1>49 THEN GO TO LOOK_LOOP;
0I=I1; /* SET UP FOR IEBUPDAT FORM */
 IF INDEX(PARM,'DAT') ¬= 0 THEN GO TO IEBUPDAT;
 /* LOCATE NAME=X (IEBUPDTE FORM) */
 I=INDEX(SUBSTR(CCARD,I1),'NAME=');
 IF I=0 THEN GO TO LOOK_LOOP;
 I=I+I1+4;
 IEBUPDAT:
 /* FIND LENGTH OF NAME */
 I1=INDEX(SUBSTR(CCARD,I),' ');
 I2=INDEX(SUBSTR(CCARD,I),',');
 IF I1=0 THEN I1=I2;
 IF I2=0 THEN I2=I1;
 I1=MIN(I1,I2)-1;
 IF I1<1 THEN GO TO GEHENNA;
 MODULE=SUBSTR(CCARD,I,I1);
         SSI=' ';  I2 = INDEX (CCARD,'SSI=');
          IF I2 ¬= 0 THEN SSI = SUBSTR(CCARD,I2+4,8);
   WRITE FILE(SYSUT2) FROM (MODCARD);
 /* IF MISSING MEMBER, REMEMBER THE CURRENT ADD CARD */
1COPY:
      READ FILE(SYSUT1) INTO(CCARD);
      IF SUBSTR(CCARD,1,3) ¬= './ ' THEN GO TO COPY;
 /* FIND OPCODE */
 DO I=3 TO 72 WHILE(SUBSTR(CCARD,I,1)=' '); END;
 IF SUBSTR(CCARD,I,6)= 'ENDUP ' THEN GO TO MAIN_LOOP;
 IF SUBSTR(CCARD,I,4)¬= 'ADD ' THEN PUT LIST(CCARD) SKIP;
 IF SUBSTR(CCARD,I,4)¬= 'ADD ' THEN GO TO COPY;
            GO TO LOOK_LOOP;  /* FORCE ALL MEMBERS TO BE PROCESSED */
0KEEPIT: MT=0; GO TO MAIN_LOOP;
1/* ERROR MESSAGES AND OTHER CONSOLATION PRIZES */
 FOUL_MOUTH: /* BAD NAME ON CONTROL CARD */
 PUT LIST('BAD NAME') SKIP; GO TO ERR;
0BAD_BOOK: /* BAD VOLUME SPECIFICATION */
 PUT LIST('BAD VOL-SER ') SKIP; GO TO ERR;
0BAD_MOUTH: /* BAD FILE SEQUENCE NUMBER */
 GEHENNA: /* INVALID NAME CARD */
 ERR:
 SIGNAL ERROR;
 HELL: RETURN;
 END;
//LKED.SYSLIB DD
// DD DSN=SYS1.AMSLIB,DISP=SHR
// DD DSN=SYS1.AMSLINK,DISP=SHR
   INCLUDE SYSLIB(DIST)
//GO.SYSPRINT DD SYSOUT=A
//SYSUT1 DD DSN=OSTAPE,VOL=SER=XTNN,LABEL=(,BLP),DISP=(OLD,PASS),
// UNIT=(2400,,DEFER)
//SYSUT2 DD DSN=&&TEMP,UNIT=2400,VOL=SER=GPTAPE,LABEL=(,NL),
// DCB=(RECFM=FB,LRECL=80,BLKSIZE=14400),DISP=(,PASS)
002859 1 NL511
002859 2 NL511
002859 3 NL511
002858 1 NL511
002858 2 NL511
002858 3 NL511
002857 1 NL511
002857 2 LM512
002857 3 PL552
002857 4 RC541
002857 5 LM537
002857 6 IO523
002855 1 IO523
002855 2 FO520
002855 3 FO550
002855 4 LM501
002855 5 FO500
002855 6 DN554
002853 1 LM532
002853 2 AL531
002853 3 LM546
002853 4 CB545
002853 5 CB545
002853 6 DN539
002856 1 CO503
002856 2 LM504
002856 3 RC543
002856 4 AS037
002856 5 ED521
002856 6 LD547
002856 7 CQ519
002856 8 LM542
002852 1 SM023
002852 2 SM023
002852 3 RG038
002854 1 UT507
002854 2 UT506
002854 3 UT506
002854 4 UT506
002862 1 UT506
002862 2 CQ513
002862 3 DM509
002862 4 IO526
002851 1 IO526
002851 2 DM508
002851 3 DM508
002851 4 DM508
002850 1 DM508
002850 2 DM508
002850 3 PVTMACS
002850 4 PVTMACS
002849 1 DN527
002849 2 DN527
002849 3 DN527
002848 1 DN527
002848 2 CI505
002848 3 CI505
002861 1 CI505
002861 2 CI505
002861 3 CI505
002847 1 CI505
002847 2 CI505
002847 3 DN533
002847 4 CQ563
002846 1 RC551
002846 2 CI535
002846 3 CI535
002846 4 RC536
002845 1 CI555
002845 2 CI555
002845 3 CI555
002844 1 CI555
002844 2 CI555
002844 3 CI555
002843 1 CI555
002843 2 CQ548
002843 3 CQ548
002842 1 CQ548
002842 2 CQ548
002842 3 CQ548
002842 4 CQ548
