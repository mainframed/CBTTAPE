An AMS program interface

It may be desirable for user programs to be able to call the Access Method
Services (AMS) program IDCAMS, thus enabling them to use services of it directly
to gain greater flexibility in developing applications.  For example, the progam
could generate a DEFINE CLUSTER or DELETE command, execute it immediately, and
check the return code for success; or the program could do a LISTCAT and search
the output for particular information.

The sub-routine AMSPIF works as a generalised program interface to AMS.  In
addition to calling IDCAMS by a separate job step, it is possible to pass
control cards in core.  In the same way IDCAMS list output can be transferred
directly to the program for processing.

* AMS (ACCESS METHOD SERVICES) PROGRAM INTERFACE
* I.G. PL/1 :
* CALLPIF: PROC OPTIONS(MAIN);
* DCL AMSPIF ENTRY EXT OPTIONS(ASM INTER);
* DCL RC FIXED BIN(15) STATIC; /* AMS RETURN CODE */
* DCL PARM CHAR(l00) VAR STATIC INIT('MARGINS(2 80)'); /*EXEC PARM*/
* DCL PSTART FIXED BIN(15) STATIC INIT(l); /*STARTING PAGE NUMBER*/
* DCL DDIN CHAR(8) STATIC INIT(
*  /* 'AMSIN   ' /* INPUT FROM FILE */
*  /* '        ' /* INPUT FROM FILE SYSIN */
*  /* '*SCREEN ' /* INPUT FROM SCREEN */
*     '*CORE   ' /* INPUT FROM PROGRAM */ );
* DCL DDPRINT CHAR(8) STATIC INIT(
*  /* 'AMSPRINT' /* OUTPUT TO FILE */
*  /* '        ' /* OUTPUT TO FILE SYSPRINT */
*  /* '*SCREEN ' /* OUTPUT TO SCREEN */
*     '*CORE   ' /* OUTPUT TO PROGRAM */ );
* DCL AMSCNTL(2) CHAR(80) STATIC INIT(
*     ' LISTCAT',
*     '/*' ); /* NECESSARY TO INDICATE END OF INPUT */
* DCL AMSLIST(100) CHAR(121);
* AMSLIST(100) = '/*'; /* NECESSARY TO INDICATE END OF OUTPUT AREA */
* CALL AMSPIF(RC,PARM,PSTART,DDIN,DDPRINT,AMSCNTL,AMSLIST);
*             /* ALL ARGUMENTS ARE OPTIONAL */
* DO I = 1 TO 100;
*  IF AMSLIST(I) = '/* ' THEN LEAVE;
*  PUT SKIP LIST(AMSLIST(I));
* END;
* IF AMSLIST(l00) = '***'
* IF AMSLIST(100) = '***'
*  THEN PUT SKIP LIST('AMS LISTING INCOMPLETE');
* END;
*
AMSPIF   CSECT                                SERIALLY REUSABLE
         SAVE  (14,12),,AMSPIF_&SYSDATE
         LR    R2,R15
         USING AMSPIF,R2
         ST    R13,SAVEAREA+4
         LR    R3,R13
         LA    R13,SAVEAREA
         ST    R13,8(R3)
         LA    R3,H0                   ADDR OF DEFAULT 1ST IDCAMS ARG
         ST    R3,AMSOPT               INTO PARAMETER LIST
         MVC   DEFIN,=CL8'SYSIN'       DEFAULT
         MVC   DEFPRINT,=CL8'SYSPRINT' DD NAMES
         MVC   PSTART,=C'0001'         DEFAULT PAGE NR
         LA    R3,IOLIST1              ADDR OF I/O LIST
         ST    R3,AMSIO                INTO PARAMETER LIST FOR IDCAMS
         XC    IONR1,IONR1             0 = NO USER I/O ROUTINES
         MVI   FLAG,X'00'              = FROM/TO CORE
         XC    ADDRCNTL,ADDRCNTL       AMS CONTROL CARDS ADDR = 0
         XC    ADDRLIST,ADDRLIST       AMS LINES ADDR = 0
         LTR   R4,R1                   ANY ARGUMENTS ?
         BZ    LINK                       NO
         TM    0(R4),X'80'             ONLY 1 ARGUMENT ?
         BO    LINK                       YES
         L     R5,4(R4)                ADDR OF 2ND ARGUMENT
         ST    R5,AMSOPT               INTO PARAMETER LIST FOR IDCAMS
         NI    AMSOPT,X'7F'            RESET ARGUMENT LIST FINAL BIT
         TM    4(R4),X'80'             ONLY 2 ARGUMENTS ?
         BO    LINK                        YES
         L     R5,8(R4)                ADDR OF 3RD ARGUMENT
         LH    R3,0(R5)                PAGE NR
         LTR   R3,R3                   NEGATIVE ?
         BNM   LOOP                       NO
         SLR   R3,R3                   SET TO ZERO
LOOP     CH    R3,=H'10000'            BECAUSE
         BL    CVD                        9999
         SH    R3,=H'10000'                  IS
         B     LOOP                             MAX
CVD      CVD   R3,PACK                 TO DECIMAL
         UNPK  PSTART,PACK+5(3)        UNPACK
         OI    PSTART+3,X'F0'          SET ZONE
         TM    8(R4),X'80'             ONLY 3 ARGUMENTS ?
         BO    LINK                        YES
         L     R5,12(R4)               ADDR OF 4TH ARGUMENT
         CLC   0(8,R5),=CL8' '         = SYSIN ?
         BE    TM1                        YES
         CLC   0(8,R5),=CL8'*SCREEN'
         BE    SET1
         CLC   0(8,R5),=CL8'*CORE'
         BE    BUILD1
         MVC   DEFIN,0(R5)             INTO PARAMETER LIST FOR IDCAMS
         B     TM1
SET1     OI    FLAG,X'80'              AMS CONTROL CARDS FROM SCREEN
BUILD1   LA    R3,1                    ONE USER ROUTINE
         ST    R3,IONR1
         MVC   DDIN,DEFIN              DD NAME FOR USER ROUTINE
TM1      TM    12(R4),X'80'            ONLY 4 ARGUMENTS ?
         BO    LINK                        YES
         L     R5,16(R4)               ADDR OF 5TH ARGUMENT
         CLC   0(8,R5),=CL8' '         = SYSPRINT ?
         BE    TM2                        YES
         CLC   0(8,R5),=CL8'*SCREEN'
         BE    SET2
         CLC   0(8,R5),=CL8'*CORE'
         BE    BUILD2
         MVC   DEFPRINT,0(R5)          INTO PARAMETER LIST FOR IDCAMS
         B     TM2
SET2     OI    FLAG,X'08'              AMS LINES TO SCREEN
BUILD2   L     R3,IONR1
         LTR   R3,R3                   ALREADY INPUT ROUTINE ?
         BNZ   Y                          YES
         LA    R3,IOLIST2              ADDR OF I/O LIST
         ST    R3,AMSIO                INTO PARAMETER LIST FOR IDCAMS
LA    R3,1                    ONLY OUTPUT ROUTINE
         ST    R3,IONR2
         B     YY
Y        LA    R3,2                    2 USER ROUTINES
         ST    R3,IONR1
YY       MVC   DDPRINT,DEFPRINT        DD NAME FOR USER ROUTINE
TM2      TM    16(R4),X'80'            ONLY 5 ARGUMENTS ?
         BO    LINK                        YES
         L     R5,20(R4)               ADDR OF 6TH ARGUMENT
         ST    R5,ADDRCNTL             KEEP IN MIND
         TM    20(R4),X'80'            ONLY 6 ARGUMENTS ?
         BO    LINK                        YES
         L     R5,24(R4)               ADDR OF 7TH ARGUMENT
         ST    R5,ADDRLIST             KEEP IN MIND
LINK     OI    AMSIO,X'80'             SET PARAMETER LIST FINAL BIT
         LA    R1,AMSPARMS             ADDR PARAMETER LIST FOR IDCAMS
         LINK  EP=IDCAMS
         LTR   R4,R4                   RETURN CODE ARGUMENT GIVEN ?
         BZ    PROGEND                    NO
         L     R5,0(R4)                ADDR OF RETURN CODE ARGUMENT
         STH   R15,0(R5)               RETURN IDCAMS RETURN CODE
PROGEND  SLR   R15,R15
         L     R13,4(R13)
         RETURN (14,12),RC=(15)
         LTORG
H0       DC    H'0'                    DEFAULT: NO OPTIONS FOR AMS
PACK     DS    D
SAVEAREA DS    18F
AMSPARMS DS    0A                      PARAMETER LIST FOR IDCAMS
AMSOPT   DS    A                       ADDR OF OPTIONS
AMSDD    DC    A(DDNAMES)              ADDR OF DD NAMES
AMSPAGE  DC    A(PSTART-2)             ADDR OF PAGE NR
????? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ???? ????
USING ROUTINE,R15             TEMP BASE
         B     BB                      BRANCH AROUND CONSTANT
AA       DC    A(AMSPIF)
BB       L     R2,AA                   LOAD PROPER BASE
         POP   USING
         ST    R13,SAVEI+4
         LR    R6,R13
         LA    R13,SAVEI
         ST    R13,8(R6)
         LM    R10,R11,4(R1)           LOAD ADDRESSES OF ARGUMENTS
         SLR   R6,R6
         IC    R6,0(R10)               OPEN/CLOSE/GET/PUT FLAG
         B     B(R6)                   BRANCH TO PROPER ENTRY
B        B     OPEN
         B     CLOSE
         B     GET
         B     PUT
OPEN     B     OK                      DO NOTHING
CLOSE    TM    FLAG,X'08'              WRITTEN TO SCREEN ?
         BO    OK                         YES, DO NOTHING
         TM    1(R10),X'40'            OUTPUT ?
         BZ    OK                         NO, DO NOTHING
         L     R6,ADDRLIST             ADDR OF RECORD
         LTR   R6,R6                   ANY LINES GIVEN ?
         BZ    OK                         NO
         MVC   0(3,R6),ENDMARK         MARK END OF LINES
         MVC   3(118,R6),2(R6)         FILL WITH BLANKS
         B     OK
GET      TM    FLAG,X'80'              TO READ FROM SCREEN ?
         BO    GETSCR                     YES
GETCORE  L     R6,ADDRCNTL             ADDR OF RECORD
         LTR   R6,R6                   CONTROL CARDS IN CORE ?
         BZ    EOF                        NO
         CLC   0(3,R6),ENDMARK         EOF ?
         BE    EOF                        YES
         LA    R7,80                   RECORD LENGTH
         STM   R6,R7,0(R11)            RETURN RECORD ADDR/LENGTH
         LA    R6,80(R6)               ADDR OF NEXT RECORD
         ST    R6,ADDRCNTL                KEEP IN MIND
         B     OK
GETSCR   TGET  BUFIN,L'BUFIN           READ RECORD FROM SCREEN
         CLC   BUFIN,ENDMARK           EOF ?
         BE    EOF                        YES
         OC    BUFIN,UP                TO UPPER CASE
         LA    R6,BUFIN                ADDR OF RECORD
         LA    R7,80                   RECORD LENGTH
         STM   R6,R7,0(R11)               RETURN IT
         B     OK
PUT      TM    FLAG,X'08'              TO WRITE TO SCREEN ?
         BO    PUTSCR                     YES
PUTCORE  L     R6,ADDRLIST             ADDR OF RECORD (OUTPUT)
         LTR   R6,R6                   ANY LINES GIVEN ?
         BZ    OK                         NO
         CLC   0(3,R6),ENDMARK         POSSIBLE TO RETURN 1 MORE LINE?
         BNE   GOON                       YES
         MVC   0(4,R6),=C'*** '        INDICATE THAT LINES ARE LOST
         MVC   4(117,R6),3(R6)         FILL WITH BLANKS
         XC    ADDRLIST,ADDRLIST       RETURN NO FURTHER LINES
         B     OK
GOON     LM    R8,R9,0(R11)            RECORD ADDR/LENGTH (INPUT)
         BCTR  R9,0                    MINUS ONE BECAUSE OF EX
         EX    R9,EX                   MOVE LINE
         LA    R8,1(R6,R9)             ADDR OF LAST NON BLANK CHAR
         LA    R7,118
         SLR   R7,R9                   REMAINING LENGTH MINUS ONE
         MVI   0(R8),C' '
         EX    R7,EX2                  FILL WITH BLANKS
         LA    R6,121(R6)              ADDR OF NEXT LINE
         ST    R6,ADDRLIST                KEEP IN MIND
         B     OK
EX       MVC   0(1,R6),0(R8)
EX2      MVC   1(1,R8),0(R8)PUTSCR
         LM    R8,R9,0(R11)            RECORD ADDR/LENGTH
         BCTR  R9,0                    MINUS 1 BECAUSE NO CARRIAGE CTL
         TPUT  1(R8),(R9)              RECORD TO SCREEN WITHOUT CC
         B     OK
EOF      LA    R15,4                   INDICATE EOF
         B     REND
OK       SLR   R15,R15                 OK
REND     L     R13,4(R13)
         RETURN (14,12),,RC=(15)
SAVEI    DS    18F
         LTORG
ENDMARK  DC    CL80'/*'
         ORG   ENDMARK+2
UP       DC    80X'40'
         END   AMSPIF


Walter Wiedemann
Consultant (West Germany)     © Walter Wiedemann 1987

































































