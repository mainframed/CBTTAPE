/*   REXX EXEC : ( TLMSVSNL )
     FUNCTION  : TSO INTERACTIVE TAPE DATASET VOLSER LIST SERVICES
                                                                      */
TRACE O
/*     */
HOUSE_KEEPING:
ADDRESS TSO
PARSE UPPER ARG TAPEDSN .
IF TAPEDSN = '' THEN DO
   SAY '*** INVALID OR MISSING TAPE DATASET NAME ON COMMAND LINE. ***'
   SAY '+++ TAPE DATASET NAME CAN BE PASSED FROM DSL COMMAND LINE. +++'
   SAY '*** TLMS TAPE DATASET VOLSER LIST FACILITY CANCELLED. ***'
   EXIT 1
END
TAPEDSN = STRIP(TAPEDSN,"B","'")
TAPEHDR = '*****  TAPE VOLSER LIST FOR: 'TAPEDSN'  *****'
X = MSG("OFF")
DUNIT = 'APPLTA'
TSOID = SYSVAR(SYSUID)
TSOPRFX = SUBSTR(TSOID,1,4)
IF TSOPRFX = 'TECH' THEN DUNIT = 'SMS'
USERLIB = TSOID'.USER.CNTLLIB'
USERDSN.1 = TSOID'.TLMS.SYSIN'
USERDSN.2 = TSOID'.TLMS.SYSOUT'
TLMSDSN.1  = 'SYSS.TLMS.V5R3M0.VMF'
TLMSDSN.2  = 'SYSS.TLMS.V5R3M0.VMF'
TLMSDSN.3  = 'SYSS.TLMS.V5R3M0.VMF'
TLMSDSN.4  = 'SYSS.TLMS.V5R3M0.RMF.CLUSTER'
TLMSDSN.5 = 'SYSS.TLMS.V5R3M0.VMFINDEX.CLUSTER'
TLMSDSN.6 = USERDSN.1
TLMSDSN.7 = USERDSN.2
TLMSFIDD = 'CAIVMF CAIVMFI CAIVMFS CAIRMF CAIVMFXI SYSIN SYSPRINT'
ATTRB.1 = 'ATTRB1 DSORG(PS) RECFM(F B) LRECL(80) BLKSIZE(80)'
ATTRB.2 = 'ATTRB2 DSORG(PS) RECFM(F B A) LRECL(133) BLKSIZE(133)'
LOADLIB = 'SYS1.TLMS.V5R3M0.CAILIB.LOADLIB'
/*
       M A I N   R O U T I N E   S E C T I O N     */
/*     */
MAIN_ROUTINE:
CALL LISTCAT_TAPE_DATASET
IF LSTSW = 'YES' THEN DO
   CALL WRITE_TAPE_DATASET_VOLSERS
   CALL EDIT_TAPE_DATASET_VOLSERS
   EXIT 0
END
CALL FREE_DATASETS
CALL ALLOC_USER_DATASETS
CALL WRITE_TLMS_DISPLAY_NAME_SYSIN
CALL ALLOC_TLMS_DATASETS
CALL FETCH_TLMS_LOAD_MODULE
CALL GET_TLMS_BASE_VOLSER
CALL WRITE_TLMS_DISPLAY_VOLUME_SYSIN
"FREE FILE("TLMSFIDD")"
CALL ALLOC_TLMS_DATASETS
CALL FETCH_TLMS_LOAD_MODULE
CALL GET_TLMS_TAPE_VOLSER_LIST
CALL BROWSE_TAPE_VOLSER_LIST
CALL FREE_DATASETS
EXIT 0
/*
       S U B R O U T I N E   S E C T I O N     */
/*     */
ALLOC_USER_DATASETS:
ADDRESS TSO
DO D = 1 TO 2
   "ATTRIB" ATTRB.D
   ATTRBTL = WORD(ATTRB.D,1)
   "ALLOC DA('"USERDSN.D"') NEW SPACE(1,0) CYLINDERS USING("ATTRBTL")
    UNIT("DUNIT")"
   SRC = RC
   IF SRC ¬= 0 THEN DO
      SAY '*** ALLOCATE ERROR: RETURN CODE: ('SRC'). ***'
      SAY '*** ERROR ALLOCATING DATASET: ('USERDSN.D'). ***'
      SAY '*** TLMS TAPE DATASET VOLSER LIST FACILITY CANCELLED. ***'
      EXIT SRC
   END
END
RETURN
/*     */
WRITE_TLMS_DISPLAY_NAME_SYSIN:
"FREE DA('"USERDSN.1"')"
"FREE FILE(TLMSIN)"
"DELSTACK"
TLMSRCD = 'DN DSN='TAPEDSN
"ALLOC DA('"USERDSN.1"') FILE(TLMSIN) SHR"
QUEUE TLMSRCD
"EXECIO 1 DISKW TLMSIN (FINIS"
SRC = RC
"FREE FILE(TLMSIN)"
IF SRC ¬= 0 THEN DO
   SAY '*** EXECIO WRITE ERROR: RETURN CODE: ('SRC'). ***'
   SAY '*** ERROR WRITING ('USERDSN.1') TLMS SYSIN RECORDS. ***'
   SAY '*** TLMS TAPE DATASET VOLSER LIST FACILITY CANCELLED. ***'
   CALL FREE_DATASETS
   EXIT SRC
END
RETURN
/*     */
ALLOC_TLMS_DATASETS:
ADDRESS TSO
DO D = 1 TO 7
   TLMSDD = WORD(TLMSFIDD,D)
   "ALLOC DA('"TLMSDSN.D"') FILE("TLMSDD") SHR"
   SRC = RC
   IF SRC ¬= 0 THEN DO
      SAY '*** ALLOCATE ERROR: RETURN CODE: ('SRC'). ***'
      SAY '*** ERROR ALLOCATING DATASET: ('TLMSDSN.D'). ***'
      SAY '*** TLMS TAPE DATASET VOLSER LIST FACILITY CANCELLED. ***'
      CALL FREE_DATASETS
      EXIT SRC
   END
END
RETURN
/*     */
FETCH_TLMS_LOAD_MODULE:
"CALL '"LOADLIB"(TLMSRPTS)'"
SRC = RC
IF SRC ¬= 0 THEN DO
   SAY '*** TLMS LOCATE ERROR: RETURN CODE: ('SRC'). ***'
   SAY '*** TAPE DSN ('TAPEDSN') NOT FOUND IN TLMS VMF. ***'
   SAY '*** TLMS TAPE DATASET VOLSER LIST FACILITY CANCELLED. ***'
   CALL FREE_DATASETS
   EXIT SRC
END
RETURN
/*     */
GET_TLMS_BASE_VOLSER:
VOLSW = 'NO'
"FREE DA('"USERDSN.2"')"
"FREE FILE(TLMSPRT)"
"ALLOC DA('"USERDSN.2"') FILE(TLMSPRT) SHR"
"EXECIO * DISKR TLMSPRT (STEM DATA. FINIS"
SRC = RC
"FREE FILE(TLMSPRT)"
IF SRC ¬= 0 THEN DO
   SAY '*** EXECIO READ ERROR: RETURN CODE: ('SRC'). ***'
   SAY '*** ERROR READING ('USERDSN.2') TLMS SYSOUT RECORDS. ***'
   SAY '*** TLMS TAPE DATASET VOLSER LIST FACILITY CANCELLED. ***'
   CALL FREE_DATASETS
   EXIT SRC
END
DO I = 1 TO DATA.0
   VSNKEY = POS('VSN=',DATA.I)
   IF VSNKEY ¬= 0 THEN DO
      VOLSW = 'YES'
      V = VSNKEY + 4
      TAPEVOL = SUBSTR(DATA.I,V,6)
      LEAVE
   END
END
IF VOLSW = 'YES' THEN RETURN
SAY '*** TAPE VOLSER ERROR: RETURN CODE: (8). ***'
SAY '*** BASE TAPE VOLSER NOT FOUND IN ('USERDSN.2') TLMS SYSOUT RECORDS. ***'
SAY '*** TLMS TAPE DATASET VOLSER LIST FACILITY CANCELLED. ***'
CALL FREE_DATASETS
EXIT 8
/*     */
WRITE_TLMS_DISPLAY_VOLUME_SYSIN:
"DELSTACK"
TLMSRCD = 'DVL 'TAPEVOL
"ALLOC DA('"USERDSN.1"') FILE(TLMSIN) SHR"
QUEUE TLMSRCD
"EXECIO 1 DISKW TLMSIN (FINIS"
SRC = RC
"FREE FILE(TLMSIN)"
IF SRC ¬= 0 THEN DO
   SAY '*** EXECIO WRITE ERROR: RETURN CODE: ('SRC'). ***'
   SAY '*** ERROR WRITING ('USERDSN.1') TLMS SYSIN RECORDS. ***'
   SAY '*** TLMS TAPE DATASET VOLSER LIST FACILITY CANCELLED. ***'
   CALL FREE_DATASETS
   EXIT SRC
END
RETURN
/*     */
GET_TLMS_TAPE_VOLSER_LIST:
VOLSW = 'NO'
VOLKEY = 'DVL 'TAPEVOL
"ALLOC DA('"USERDSN.2"') FILE(TLMSPRT) SHR"
"EXECIO * DISKR TLMSPRT (STEM DATA. FINIS"
SRC = RC
"FREE FILE(TLMSPRT)"
IF SRC ¬= 0 THEN DO
   SAY '*** EXECIO READ ERROR: RETURN CODE: ('SRC'). ***'
   SAY '*** ERROR READING ('USERDSN.2') TLMS SYSOUT RECORDS. ***'
   SAY '*** TLMS TAPE DATASET VOLSER LIST FACILITY CANCELLED. ***'
   CALL FREE_DATASETS
   EXIT SRC
END
DO I = 1 TO DATA.0
   VOLLST = POS(VOLKEY,DATA.I)
   IF VOLLST ¬= 0 THEN DO
      VOLSW = 'YES'
      ITERATE
   END
   IF VOLSW = 'YES' THEN DO
      SKIP = POS(TAPEDSN,DATA.I)
      IF SKIP ¬= 0 THEN ITERATE
      ENDKEY = POS('BUILDING',DATA.I)
      IF ENDKEY ¬= 0 THEN LEAVE
/*    SAY DATA.I  */
   END
END
IF VOLSW = 'YES' THEN RETURN
SAY '*** TAPE VOLSER ERROR: RETURN CODE: (8). ***'
SAY '*** BASE TAPE VOLSER NOT FOUND IN ('USERDSN.2') TLMS SYSOUT RECORDS. ***'
SAY '*** TLMS TAPE DATASET VOLSER LIST FACILITY CANCELLED. ***'
CALL FREE_DATASETS
EXIT 8
/*     */
BROWSE_TAPE_VOLSER_LIST:
ADDRESS ISPEXEC
"EDIT DATASET('"USERDSN.2"')"
RETURN
/*     */
FREE_DATASETS:
ADDRESS TSO
DO D = 1 TO 2
   "FREE DA('"USERDSN.D"')"
   UDSN = SYSDSN("'"USERDSN.D"'")
   IF UDSN = 'DATASET NOT FOUND' THEN ITERATE
   "ALLOC DA('"USERDSN.D"') FILE(USERDD)"
   "DELETE ('"USERDSN.D"')  NONVSAM SCRATCH PURGE FILE(USERDD)"
   "FREE FILE(USERDD)"
END
"FREE ATTRLIST(ATTRB1 ATTRB2)"
"FREE FILE("TLMSFIDD")"
RETURN
/*     */
LISTCAT_TAPE_DATASET:
T = 0
LSTSW = 'NO'
X = OUTTRAP("LSTCAT.","*","CONCAT")
"LISTCAT ENT('"TAPEDSN"') VOL"
IF RC ¬= 0 THEN RETURN
LSTSW = 'YES'
DO L = 1 TO LSTCAT.0
   VOLKEY = POS("VOLSER------------",LSTCAT.L)
   IF VOLKEY ¬= 0 THEN DO
      STA = VOLKEY + 18
      T = T + 1
      TAPE.T = SUBSTR(LSTCAT.L,STA,6)
   END
END
TAPECNT = T
RETURN
/*     */
WRITE_TAPE_DATASET_VOLSERS:
"DELSTACK"
C = 0
TAPERCD = ' '
"ALLOC DA('"USERLIB"(TLMSVSNO)') FILE(TLMSDD) SHR"
SRC = RC
IF SRC ¬= 0 THEN DO
   SAY '*** ALLOCATE ERROR: RETURN CODE: ('SRC'). ***'
   SAY '*** ERROR ALLOCATING DATASET: ('USERLIB'(TLMSVSNO). ***'
   SAY '*** TLMS TAPE DATASET VOLSER LIST FACILITY CANCELLED. ***'
   EXIT SRC
END
QUEUE TAPEHDR
DO T = 1 TO TAPECNT
   C = C + 1
   IF C < 10 THEN DO
      TAPERCD = TAPERCD||TAPE.T||' '
      ITERATE
   END
   IF C = 10 THEN DO
      C = 0
      TAPERCD = TAPERCD||TAPE.T
      QUEUE TAPERCD
      TAPERCD = ' '
   END
END
IF TAPERCD ¬= ' ' THEN QUEUE TAPERCD
NUMRCDS = QUEUED()
"EXECIO" NUMRCDS "DISKW TLMSDD (FINIS"
SRC = RC
"FREE FILE(TLMSDD)"
IF SRC ¬= 0 THEN DO
   SAY '*** EXECIO WRITE ERROR: RETURN CODE: ('SRC'). ***'
   SAY '*** ERROR WRITING DATASET: ('USERLIB'(TLMSVSNO). ***'
   SAY '*** TLMS TAPE DATASET VOLSER LIST FACILITY CANCELLED. ***'
   "DELSTACK"
   EXIT SRC
END
RETURN
/*     */
EDIT_TAPE_DATASET_VOLSERS:
ADDRESS ISPEXEC
"BROWSE DATASET('"USERLIB"(TLMSVSNO)')"
RETURN
