/* This REXX EXEC is designed to facilitate the CA-LIBRARIAN LIB/CCF
   CLOSE function for a opened CR/WO that has completed the turnover
   cycle into the PROD libraries.                   */

TRACE O
/*     */
HOUSE_KEEPING:
ADDRESS TSO
TSOID = SYSVAR(SYSUID)
SYST1 = 'NONE'
INPT1 = 'NONE'
OUPT1 = 'NONE'
DOCC1 = 'NONE'
WCNT = 0
RCDCNT = 0
X = MSG("OFF")
DSN = SYSDSN("DIALOG.ISPFILE")
IF DSN = 'OK' THEN DO
   "FREE DA(DIALOG.ISPFILE)"
   SIGNAL DISPLAY_USER_ANALYSIS_PANEL
END
CALL ALLOC_ISPFILE
"FREE DA(DIALOG.ISPFILE)"

/*     */
DISPLAY_USER_ANALYSIS_PANEL:
ADDRESS ISPEXEC
"CONTROL ERRORS RETURN"
DO FOREVER
   "DISPLAY PANEL(LBCLOSE1)"
   SRC = RC
   IF SRC = 0 THEN LEAVE
   IF SRC = 8 THEN LEAVE
   IF SRC > 8 THEN DO
      SAY '*** PANEL ERROR: ISPF DIALOG ERROR INVOKING PANEL ( LBCLOSE1 ). ***'
      SAY '*** LBCLOSE EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
      EXIT
   END
END
IF CCFUSER = '' | WORKORDR = '' | ANAL1 = '' THEN DO
     SAY '*** REQUIRED DATA NOT SUPPLIED - LBCLOSE EXEC TASK TERMINATED. ***'
     EXIT
END
WO = WORKORDR
MEM = WORKORDR

/*     */
DISPLAY_MODULE_AFFECTED_PANEL:
DO FOREVER
   "DISPLAY PANEL(LBCLOSE2)"
   SRC = RC
   IF SRC = 0 THEN LEAVE
   IF SRC = 8 THEN LEAVE
   IF SRC > 8 THEN DO
      "FREE F(ISPFILE)"
      SAY '*** PANEL ERROR: ISPF DIALOG ERROR INVOKING PANEL ( LBCLOSE2 ). ***'
      SAY '*** LBCLOSE EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
      EXIT
   END
END
IF AFFT1 = '' | MODDATE = '' | VERDATE = '' THEN DO
     "FREE F(ISPFILE)"
     SAY '*** REQUIRED DATA NOT SUPPLIED - LBCLOSE EXEC TASK TERMINATED. ***'
     EXIT
END

/*     */
DISPLAY_DOCLIST_PANEL:
DO FOREVER
   "DISPLAY PANEL(LBCLOSE3)"
   SRC = RC
   IF SRC = 0 THEN LEAVE
   IF SRC = 8 THEN LEAVE
   IF SRC > 8 THEN DO
      "FREE F(ISPFILE)"
      SAY '*** PANEL ERROR: ISPF DIALOG ERROR INVOKING PANEL ( LBCLOSE3 ). ***'
      SAY '*** LBCLOSE EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
      EXIT
   END
END
IF SYST1 = '' THEN SYST1 = 'NONE'
IF INPT1 = '' THEN INPT1 = 'NONE'
IF OUPT1 = '' THEN OUPT1 = 'NONE'
IF DOCC1 = '' THEN DOCC1 = 'NONE'

/*     */
BUILD_JOBSTREAM:
ADDRESS TSO
"DELSTACK"
"FREE FILE(ISPFILE)"
"ALLOC DA(DIALOG.ISPFILE("WORKORDR")) F(ISPFILE) OLD"
CALL BUILD_JOB_JCL
CALL BUILD_MODULE_ANALYSIS_RECORDS
CALL BUILD_MODULE_AFFECTED_RECORDS
CALL BUILD_SYSTLIST_RECORDS
CALL BUILD_INPTLIST_RECORDS
CALL BUILD_OUPTLIST_RECORDS
CALL BUILD_DOCCLIST_RECORDS
CALL BUILD_END_RECORDS
CALL WRITE_LBCLOSE_RECORDS
IF SRC ¬= 0 THEN CALL WRITE_LBCLOSE_RECORDS
CALL SUBMIT_LBCLOSE_JOB
ADDRESS TSO
"ALLOC DA(DIALOG.ISPFILE F(ISPFILE) SHR"
"DELETE (DIALOG.ISPFILE) SCRATCH PURGE NONVSAM FILE(ISPFILE)"
"FREE F(ISPFILE)"
SAY '+++++++++++++++++++++++++++++++++++++++++++++++++++'
SAY '+++ LBCLOSE EXEC TASK COMPLETE - JOB SUBMITTED. +++'
SAY '+++++++++++++++++++++++++++++++++++++++++++++++++++'
EXIT

/*     S U B R O U T I N E S   S E C T I O N     */

/*     */
BUILD_JOB_JCL:
R = 7
RCD.1 = "//"WO" JOB 5302010530000000,'LIBCCF.BATCH.CLOSE',NOTIFY="TSOID","
RCD.2 = "//             CLASS=P,MSGCLASS=S,MSGLEVEL=(1,1),REGION=1024K"
RCD.3 = "//CCFUTIL    EXEC PGM=$CCFB104,PARM=COND"
RCD.4 = "//CCFPRINT   DD SYSOUT=*"
RCD.5 = "-USER" CCFUSER
RCD.6 = "-SYSM" MODDATE
RCD.7 = "-SYSV" VERDATE
CALL QUEUE_RECORDS
RETURN

/*     */
BUILD_MODULE_ANALYSIS_RECORDS:
N = 0
R = 0
CCFCNT = 0
ADDRESS TSO
ANAL.1 = ANAL1
ANAL.2 = ANAL2
ANAL.3 = ANAL3
ANAL.4 = ANAL4
ANAL.5 = ANAL5
ANAL.6 = ANAL6
ANAL.7 = ANAL7
ANAL.8 = ANAL8
ANAL.9 = ANAL9
ANAL.10 = ANAL10
ANAL.11 = ANAL11
ANAL.12 = ANAL12
DO 12
   N = N + 1
   IF ANAL.N = '' THEN ITERATE
   CCFCNT = CCFCNT + 1
END
DO CCFCNT
   R = R + 1
   RCD.R = "-ANAL" ANAL.R
END
CALL QUEUE_RECORDS
RETURN

/*     */
BUILD_MODULE_AFFECTED_RECORDS:
N = 0
R = 0
CCFCNT = 0
ADDRESS TSO
AFFT.1 = AFFT1
AFFT.2 = AFFT2
AFFT.3 = AFFT3
AFFT.4 = AFFT4
AFFT.5 = AFFT5
AFFT.6 = AFFT6
AFFT.7 = AFFT7
AFFT.8 = AFFT8
AFFT.9 = AFFT9
AFFT.10 = AFFT10
AFFT.11 = AFFT11
AFFT.12 = AFFT12
AFFT.13 = AFFT13
AFFT.14 = AFFT14
AFFT.15 = AFFT15
DO 15
   N = N + 1
   IF AFFT.N = '' THEN ITERATE
   CCFCNT = CCFCNT + 1
END
DO CCFCNT
   R = R + 1
   RCD.R = "-AFFT" AFFT.R
END
CALL QUEUE_RECORDS
RETURN

/*     */
BUILD_SYSTLIST_RECORDS:
N = 0
R = 0
CCFCNT = 0
ADDRESS TSO
SYST.1 = SYST1
SYST.2 = SYST2
SYST.3 = SYST3
DO 3
   N = N + 1
   IF SYST.N = '' THEN ITERATE
   CCFCNT = CCFCNT + 1
END
DO CCFCNT
   R = R + 1
   RCD.R = "-SYST" SYST.R
END
CALL QUEUE_RECORDS
RETURN

/*     */
BUILD_INPTLIST_RECORDS:
N = 0
R = 0
CCFCNT = 0
ADDRESS TSO
INPT.1 = INPT1
INPT.2 = INPT2
INPT.3 = INPT3
DO 3
   N = N + 1
   IF INPT.N = '' THEN ITERATE
   CCFCNT = CCFCNT + 1
END
DO CCFCNT
   R = R + 1
   RCD.R = "-INPT" INPT.R
END
CALL QUEUE_RECORDS
RETURN

/*     */
BUILD_OUPTLIST_RECORDS:
N = 0
R = 0
CCFCNT = 0
ADDRESS TSO
OUPT.1 = OUPT1
OUPT.2 = OUPT2
OUPT.3 = OUPT3
DO 3
   N = N + 1
   IF OUPT.N = '' THEN ITERATE
   CCFCNT = CCFCNT + 1
END
DO CCFCNT
   R = R + 1
   RCD.R = "-OUPT" OUPT.R
END
CALL QUEUE_RECORDS
RETURN

/*     */
BUILD_DOCCLIST_RECORDS:
N = 0
R = 0
CCFCNT = 0
ADDRESS TSO
DOCC.1 = DOCC1
DOCC.2 = DOCC2
DOCC.3 = DOCC3
DO 3
   N = N + 1
   IF DOCC.N = '' THEN ITERATE
   CCFCNT = CCFCNT + 1
END
DO CCFCNT
   R = R + 1
   RCD.R = "-DOCC" DOCC.R
END
CALL QUEUE_RECORDS
RETURN

/*     */
BUILD_END_RECORDS:
R = 5
RCD.1 = "-CLOSE" WORKORDR
RCD.2 = "-EMOD"
RCD.3 = "-END"
RCD.4 = "/*"
RCD.5 = "//"
CALL QUEUE_RECORDS
RETURN

/*     */
QUEUE_RECORDS:
RCNT = R
RCDCNT = RCDCNT + R
R = 0
DO RCNT
   R = R + 1
   QUEUE RCD.R
END
RETURN

/*     */
WRITE_LBCLOSE_RECORDS:
"EXECIO" RCDCNT "DISKW ISPFILE (FINIS"
SRC = RC
IF SRC ¬= 0 THEN DO
   WCNT = WCNT + 1
   IF WCNT > 1 THEN DO
      SAY '*** EXECIO WRITE ERROR: ( 'TSOID'.DIALOG.ISPFILE('MEM'). ***'
      SAY '*** LBCLOSE EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
      "FREE F(ISPFILE)"
      "DELETE (DIALOG.ISPFILE) SCRATCH PURGE NONVSAM"
      EXIT
   END
   SAY '*** EXECIO WRITE ERROR: ( 'TSOID'.DIALOG.ISPFILE('MEM'). ***'
   SAY '+++ DATASET WILL BE DELETED AND RE-ALLOCATED - ATTEMPT RE-WRITE. +++'
   "FREE F(ISPFILE)"
   "DELETE (DIALOG.ISPFILE) SCRATCH PURGE NONVSAM"
   CALL ALLOC_ISPFILE
   "FREE FILE(ISPFILE)"
   "ALLOC DA(DIALOG.ISPFILE("WORKORDR")') F(ISPFILE) OLD"
END
RETURN

/*     */
ALLOC_ISPFILE:
"ALLOC DA(DIALOG.ISPFILE) LIKE(USER.CNTLLIB) NEW SPACE(2,0) DIR(15) CYLINDERS"
SRC = RC
IF SRC ¬= 0 THEN DO
   SAY '*** ALLOCATE ERROR: ERROR ALLOCATING TEMP ISPFILE DATASET. ***'
   SAY '*** LBCLOSE EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
   "DELETE (DIALOG.ISPFILE) SCRATCH PURGE NONVSAM"
   EXIT
END
RETURN

/*     */
SUBMIT_LBCLOSE_JOB:
"SUBMIT '"TSOID".DIALOG.ISPFILE("WORKORDR")'"
SRC = RC
"FREE F(ISPFILE)"
IF SRC ¬= 0 THEN DO
   SAY '*** SUBMIT ERROR: MEMBER ( 'TSOID'.DIALOG.ISPFILE('MEM'). ***'
   SAY '*** LBCLOSE EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
   EXIT
END
RETURN
