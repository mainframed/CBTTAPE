/* This REXX EXEC is designed to facilitate the CA-LIBRARIAN LIB/CCF
   logout of modules for a new application system that does not already
   exist in the PROD Librarian Master datasets.   */

TRACE O
/*     */
HOUSE_KEEPING:
ADDRESS TSO
JCLSW = 'NO'
MEMBCNT = 0
TSOID = SYSVAR(SYSUID)
ACCTCCF = 5200010520000000
X = MSG("OFF")
LBPANEL.1 = 'ASSEMBLE 1'
LBPANEL.2 = 'BMSMAP 18'
LBPANEL.3 = 'BMSMAP 19'
LBPANEL.4 = 'BMSMAP 20'
LBPANEL.5 = 'CICSCOB 18'
LBPANEL.6 = 'CICSCOB 19'
LBPANEL.7 = 'CICSCOB 20'
LBPANEL.8 = 'CICSCOB2 18'
LBPANEL.9 = 'CICSCOB2 19'
LBPANEL.10 = 'CICSCOB2 20'
LBPANEL.11 = 'CICSCOPY 18'
LBPANEL.12 = 'CICSCOPY 19'
LBPANEL.13 = 'CICSCOPY 20'
LBPANEL.14 = 'COBOL 1'
LBPANEL.15 = 'COBOL2 1'
LBPANEL.16 = 'COPY 3'
LBPANEL.17 = 'DMSMAP 18'
LBPANEL.18 = 'DMSMAP 19'
LBPANEL.19 = 'DMSMAP 20'
LBPANEL.20 = 'DYL280 1'
LBPANEL.21 = 'JCL 4'
LBPANEL.22 = 'PROC 5'
LBPANEL.23 = 'RAMIS 6'
LBPANEL.24 = 'RPGIAUTO 1'
LBPANEL.25 = 'RPGII 1'
LBPANEL.26 = 'SYSIN 7'
LBPANEL.27 = 'COBDB2 21'
LBPANEL.28 = 'CICSDB2 22'
LBPANEL.29 = 'CICSDB2 23'
LBPANEL.30 = 'CICSDB2 24'
DSN = SYSDSN("'SYSS.TESTCCF.LOGOUT.CNTLLIB'")
IF DSN ¬= 'OK' THEN DO
   SAY '*** DATASET ERROR: ( LOGOUT.CNTLLIB ) DATASET NOT FOUND. ***'
   SAY '*** LBLOGOUT EXEC TASK CANCELLED. ***'
   EXIT
END
"ALLOC DA('SYSS.TESTCCF.LOGOUT.CNTLLIB') F(ISPFILE) OLD"
SRC = RC
IF SRC ¬= 0 THEN DO
   SAY '*** ALLOC ERROR: DATASET ( LOGOUT.CNTLLIB ) UNAVAILABLE OR IN USE. ***'
   SAY '+++ RETRY LBLOGOUT TASK LATER. +++'
   SAY '*** LBLOGOUT EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
   "FREE F(ISPFILE)"
   EXIT
END
ADDRESS ISPEXEC
"CONTROL ERRORS RETURN"
"VGET (ACCTCDE) PROFILE"
IF RC ¬= 0 THEN ACCTCDE = ACCTCCF

/*     */
DISPLAY_MAIN_PANEL:
DO FOREVER
   ADDRESS ISPEXEC "DISPLAY PANEL(LBLOPNL1)"
   SRC = RC
   IF SRC = 0 THEN LEAVE
   IF SRC = 8 THEN LEAVE
   IF SRC > 8 THEN DO
      "FREE F(ISPFILE)"
      SAY '*** PANEL ERROR: ISPF DIALOG ERROR INVOKING PANEL ( LBLOPNL1 ). ***'
      SAY '*** LBLOGOUT EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
      EXIT
   END
END
IF WORKORDR = '' | APPLSYS = '' | ABS1 = '' THEN DO
     "FREE F(ISPFILE)"
     SAY '*** REQUIRED DATA NOT SUPPLIED - LBLOGOUT EXEC TASK TERMINATED. ***'
     EXIT
END
WO = WORKORDR
CALL GET_LOGOUT_PDS_MEMBER_NAME

/*     */
DISPLAY_LANGCODE_LCDF_PANEL:
DO FOREVER
   LANGTYP = ''
   ADDRESS ISPEXEC "DISPLAY PANEL(LBLOPNL2)"
   SRC = RC
   IF SRC = 0 THEN CALL DISPLAY_MODULE_SELECTION_PANEL
   IF SRC = 8 THEN CALL DISPLAY_MODULE_SELECTION_PANEL
   IF SRC > 8 THEN DO
      "FREE F(ISPFILE)"
      SAY '*** PANEL ERROR: ISPF DIALOG ERROR INVOKING PANEL (LBLOPNL2). ***'
      SAY '*** LBLOGOUT EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
      EXIT
   END
END
SIGNAL EXIT_RETURN

/*     S U B R O U T I N E S   S E C T I O N     */
/*     */
GET_LOGOUT_PDS_MEMBER_NAME:
M = 0
MEMBSW = 'NO'
DO 26
   M = M + 1
   JOB_SUFFIX = SUBSTR('ABCDEFGHIJKLMNOPQRSTUVWXYZ',M,1)
   MEMBER = TSOID||JOB_SUFFIX
   DSN = SYSDSN("'SYSS.TESTCCF.LOGOUT.CNTLLIB("MEMBER")'")
   IF DSN ¬= 'OK' THEN DO
      MEMBSW = 'YES'
      LEAVE
   END
END
IF MEMBSW = 'NO' THEN DO
   "FREE F(ISPFILE)"
   SAY '*** MEMBER ERROR: ( LOGOUT.CNTLLIB ) UNABLE TO ADD MEMB. ***'
   SAY '*** MEMBER SUFFIX ( A THRU Z ) ALREADY EXISTS. ***'
   SAY '*** LBLOGOUT EXEC TASK CANCELLED. ***'
   EXIT
END
RETURN

/*     */
DISPLAY_MODULE_SELECTION_PANEL:
IF LANGTYP = '' THEN SIGNAL SUBMIT_LOGOUT_JOB
P = LANGTYP
LANGCODE = SUBWORD(LBPANEL.P,1,1)
DO FOREVER
   ADDRESS ISPEXEC "DISPLAY PANEL(LBLOPNL3)"
   SRC = RC
   IF SRC = 0 THEN LEAVE
   IF SRC = 8 THEN LEAVE
   IF SRC > 8 THEN DO
      "FREE F(ISPFILE)"
     SAY '*** PANEL ERROR: ISPF DIALOG ERROR INVOKING PANEL (LBLOPNL3). ***'
     SAY '*** LBLOGOUT EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
      EXIT
   END
END
CALL BUILD_MODULE_COPY_RECORDS
RETURN

/*     */
BUILD_MODULE_COPY_RECORDS:
N = 0
ADDRESS TSO
MOD.1 = MOD1 MOD2 MOD3 MOD4 MOD5 MOD6 MOD7 MOD8 MOD9 MOD10
MOD.2 = MOD11 MOD12 MOD13 MOD14 MOD15 MOD16 MOD17 MOD18 MOD19 MOD20
MOD.3 = MOD21 MOD22 MOD23 MOD24 MOD25 MOD26 MOD27 MOD28 MOD29 MOD30
MOD.4 = MOD31 MOD32 MOD33 MOD34 MOD35 MOD36 MOD37 MOD38 MOD39 MOD40
MOD.5 = MOD41 MOD42 MOD43 MOD44 MOD45 MOD46 MOD47 MOD48 MOD49 MOD50
DO 5
   N = N + 1
   IF MOD.N = '' THEN ITERATE
   MEMBCNT = MEMBCNT + 1
END
IF MEMBCNT = 0 THEN RETURN
IF JCLSW = 'NO' THEN CALL WRITE_JOB_EXECUTE_JCL
N = 0
R = 0
LIBRNUM = SUBWORD(LBPANEL.P,2,1)
R = R + 1
RCD.R = "-MFID" LIBRNUM
R = R + 1
RCD.R = "-LANG" LANGCODE
DO MEMBCNT
   I = 0
   N = N + 1
   DO 10
      I = I + 1
      MODNAME = SUBWORD(MOD.N,I,1)
      IF MODNAME = '' THEN ITERATE
      R = R + 1
      RCD.R = "-COPY" MODNAME
   END
END
CALL WRITE_LOGOUT_RECORDS
SAY '+++ PARAMETERS ACCEPTED FOR (' LANGCODE ') MODULE SELECTION. +++'
SAY '===> HIT ENTER TO CONTINUE WITH NEXT PARMS OR TO END ...'
PULL ENTER_KEY
RETURN

/*     */
WRITE_JOB_EXECUTE_JCL:
ADDRESS TSO
ACNT = 0
RCD.1 = "//"WO" JOB "ACCTCDE",'LIBCCF.BATCH.LOGOUT',NOTIFY="TSOID","
RCD.2 = "//             CLASS=P,MSGCLASS=S,MSGLEVEL=(1,1),REGION=4M"
RCD.3 = "//CCFUTIL    EXEC PGM=$CCFB102,PARM=COND"
RCD.4 = "//CCFPRINT   DD SYSOUT=*"
RCD.5 = "-CRID" WORKORDR
RCD.6 = "-APPL" APPLSYS
RCD.7 = "-DESC BUILDING APPLICATION SYSTEM"
ABS.1 = ABS1
ABS.2 = ABS2
ABS.3 = ABS3
ABS.4 = ABS4
ABS.5 = ABS5
ABS.6 = ABS6
ABS.7 = ABS7
ABS.8 = ABS8
ABS.9 = ABS9
ABS.10 = ABS10
ABS.11 = ABS11
ABS.12 = ABS12
ABS.13 = ABS13
ABS.14 = ABS14
ABS.15 = ABS15
ABS.16 = ABS16
A = 0
R = 7
DO 16
   A = A + 1
   IF ABS.A = '' THEN ITERATE
   ACNT = ACNT + 1
END
IF ACNT = 0 THEN SIGNAL EXIT_RETURN
A = 0
DO ACNT
   A = A + 1
   R = R + 1
   RCD.R = "-ABST" ABS.A
END
"FREE F(ISPFILE)"
"ALLOC DA('SYSS.TESTCCF.LOGOUT.CNTLLIB("MEMBER")') F(ISPFILE) OLD"
CALL WRITE_LOGOUT_RECORDS
JCLSW = 'YES'
RETURN

/*     */
SUBMIT_LOGOUT_JOB:
ADDRESS TSO
IF MEMBCNT = 0 THEN SIGNAL EXIT_RETURN
R = 4
RCD.1 = "-EMOD"
RCD.2 = "-END"
RCD.3 = "/*"
RCD.4 = "//"
CALL WRITE_LOGOUT_RECORDS
"EXECIO 0 DISKW ISPFILE (FINIS"
"SUBMIT 'SYSS.TESTCCF.LOGOUT.CNTLLIB("MEMBER")'"
SRC = RC
IF SRC ¬= 0 THEN DO
   SAY '*** SUBMIT ERROR: MEMBER ( SYS1.LOGOUT.CNTLLIB('MEMB'). ***'
   SAY '*** LBLOGOUT EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
   "FREE F(ISPFILE)"
   EXIT
END
"FREE F(ISPFILE)"
SAY '+++ LBLOGOUT JOB: ('MEMBER') SUBMITTED - TASK COMPLETED RC = 0. +++'
EXIT

/*     */
WRITE_LOGOUT_RECORDS:
"DELSTACK"
RCDCNT = R
R = 0
DO RCDCNT
   R = R + 1
   QUEUE RCD.R
END
"EXECIO" R "DISKW ISPFILE"
SRC = RC
IF SRC ¬= 0 THEN DO
   MEMB = MEMBER
   SAY '*** WRITE ERROR: WRITING MEMBER ( SYS1.LOGOUT.CNTLLIB('MEMB'). ***'
   SAY '*** LBLOGOUT EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
   "FREE F(ISPFILE)"
   EXIT
END
RETURN

/*     */
EXIT_RETURN:
"FREE F(ISPFILE)"
SAY '*** INSUFFICIENT OR NO USER DATA NOT SUPPLIED FOR LIB/CCF LOGOUT. ***'
SAY '*** LBLOGOUT EXEC TASK TERMINATED. ***'
EXIT
