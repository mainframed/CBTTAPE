/* REXX mortgage calculation */
address "TSO";
outfile="'"userid()".USER.CNTLLIB(MORTGOUT)'";
"ALLOC F(OUT) DA("outfile") SHR";
"VMFCLEAR";
morgtype="";
do while(morgtype="");
   say "Enter mortgage type as follows:";
   say "    'F' for fixed rate mortgage";
   say "    'V' for variable rate mortgage";
   say "    'B' for bi-weekly fixed rate mortgage";
   parse upper pull morgtype;
   select;
      when morgtype="F" then nop;
      when morgtype="V" then nop;
      when morgtype="B" then nop;
      otherwise morgtype="";
   end;
end;
outptr=1;
select;
   when morgtype="F" then do;
     morgrate="";
     do while(morgrate="");
        say "Enter mortgage rate";
        parse upper pull morgrate;
        if ¬datatype(morgrate,"N") then morgrate="";
     end;
     morgterm="";
     do while(morgterm="");
        say "Enter mortgage term in years";
        parse upper pull morgterm;
        if ¬datatype(morgterm,"W") then morgterm="";
     end;
     morgamnt="";
     do while(morgamnt="");
        say "Enter mortgage amount";
        parse upper pull morgamnt;
        if ¬datatype(morgamnt,"W") then morgamnt="";
     end;
     monthrate=morgrate/1200.00;
     morgmths=morgterm*12;
 monthpay=morgamnt*(monthrate/(1.0-(1.0/((1.0+monthrate)**morgmths))));
     monthpay=TRUNC((monthpay+5.000001e-3)*100)/100;
     outp.outptr="Mortgage-amount Mortgage-term Mortgage-rate";
     outptr=outptr+1;
  outp.outptr=right(morgamnt,15)right(morgterm,14)right(morgrate,14);
     outptr=outptr+1;
     outp.outptr="Monthly payments are: $"monthpay;
     outptr=outptr+1;
     pamort.0=morgamnt;
     totint=0.0;
     do i = 1 to morgmths;
        p=i-1; /* prev month */
        iamort.i=trunc((pamort.p*monthrate+5.000001e-3)*100)/100;
        iamort.i=iamort.i+0; /* rexx will retain trail 0s */
        pamort.i=pamort.p-monthpay+iamort.i;
        mthprinc=monthpay-iamort.i;
        if pamort.p<mthprinc then do;
             mthprinc=pamort.p;
             pamort.i=0;
             iamort.i=0;
             end;
        totint=totint+iamort.i;
        totprinc=morgamnt-pamort.i;
outp.outptr="YrMth Principal Interest Remain-Principal Total-Princ"|| ,
      "ipal Total-Interest";
     outptr=outptr+1;
     t=i-1;
     year=t%12+1;
     mth=i-((year-1)*12);
     ym=year||"/"mth;
     fmthprinc=format(mthprinc,,2);
     fiamort=format(iamort.i,,2);
     fpamort=format(pamort.i,,2);
     ftotint=format(totint,,2);
     ftotprinc=format(totprinc,,2);
outp.outptr=right(ym,5)right(fmthprinc,10)right(fiamort,9)|| ,
             right(fpamort,17)right(ftotprinc,16)right(ftotint,15);
     outptr=outptr+1;
     end;
   end;
   when morgtype="V" then do;
   end;
   when morgtype="B" then do;
     morgrate="";
     do while(morgrate="");
        say "Enter mortgage rate";
        parse upper pull morgrate;
        if ¬datatype(morgrate,"N") then morgrate="";
     end;
     morgterm="";
     do while(morgterm="");
        say "Enter mortgage term in years";
        parse upper pull morgterm;
        if ¬datatype(morgterm,"W") then morgterm="";
     end;
     morgamnt="";
     do while(morgamnt="");
        say "Enter mortgage amount";
        parse upper pull morgamnt;
        if ¬datatype(morgamnt,"W") then morgamnt="";
     end;
     morgprep="";
     do while(morgprep="");
        say "Enter mortgage prepayment amount per payment";
        parse upper pull morgprep;
        if ¬datatype(morgprep,"W") then morgprep="";
     end;
 outp.outptr="Mortgage-amount Mortgage-term Mortgage-rate Prepay";
 outptr=outptr+1;
 outp.outptr=right(morgamnt,15)right(morgterm,14)right(morgrate,14)|| ,
   right(morgprep,7);
     outptr=outptr+1;
     monthrate=morgrate/1200.00;
     outp.outptr="Mortgage monthly interest rate:" monthrate;
     outptr=outptr+1;
     morgmths=morgterm*12;
 monthpay=morgamnt*(monthrate/(1.0-(1.0/((1.0+monthrate)**morgmths))));
     outp.outptr="Mortgage monthly payment:" monthpay;
     outptr=outptr+1;
     monthpay=(monthpay*13.0)/26.0;
     outp.outptr="Mortgage biweekly payment:" monthpay;
     outptr=outptr+1;
     monthpay=TRUNC((monthpay+5.000001e-3)*100)/100;
     monthrate=morgrate/2600.00;
     outp.outptr="Mortgage biweekly interest rate:" monthrate;
     outptr=outptr+1;
     morgmths=morgterm*26;
     outp.outptr="Bi-weekly payments are: $"monthpay;
     outptr=outptr+1;
     pamort.0=morgamnt;
     totint=0.0;
     do i = 1 to morgmths;
        p=i-1; /* prev month */
        iamort.i=trunc((pamort.p*monthrate+5.000001e-3)*100)/100;
        iamort.i=iamort.i+0; /* rexx will retain trail 0s */
        pamort.i=pamort.p-monthpay+iamort.i-morgprep;
        mthprinc=monthpay-iamort.i+morgprep;
        if pamort.p<mthprinc then do;
             mthprinc=pamort.p;
             pamort.i=0;
             iamort.i=0;
             end;
        totint=totint+iamort.i;
        totprinc=morgamnt-pamort.i;
outp.outptr="YrPay Principal Interest Remain-Principal Total-Princ"|| ,
      "ipal Total-Interest";
     outptr=outptr+1;
     t=i-1;
     year=t%26+1;
     mth=i-((year-1)*26);
     ym=year||"/"mth;
     fmthprinc=format(mthprinc,,2);
     fiamort=format(iamort.i,,2);
     fpamort=format(pamort.i,,2);
     ftotint=format(totint,,2);
     ftotprinc=format(totprinc,,2);
outp.outptr=right(ym,5)right(fmthprinc,10)right(fiamort,9)|| ,
             right(fpamort,17)right(ftotprinc,16)right(ftotint,15);
     outptr=outptr+1;
     if iamort.i=0 then leave i; /* finished in record time */
     end;
   end;
   otherwise nop;
end;
"EXECIO * DISKW OUT (FINIS STEM OUTP.";
"FREE F(OUT)";
say "Output is located in:" outfile;
