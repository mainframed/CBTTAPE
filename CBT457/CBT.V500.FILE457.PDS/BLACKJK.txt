 BLAKJAK: PROC OPTIONS(MAIN)  REORDER;
      DEFAULT RANGE(*) STATIC;
      DCL TME CHAR(9);
      DCL CHECK ENTRY(CHAR(120) VAR, FIXED BIN(15));
      DCL RAND ENTRY(FIXED BIN(31), FLOAT DEC);
      DCL TIME BUILTIN;
      DCL R1 FIXED BIN(31);
      DCL W CHAR(120) VAR;
      DCL C FIXED BIN(15);
      DCL I FIXED BIN(15);
      DCL CDS FIXED BIN(15);
      DCL DISPL PIC 'ZZZZZ9';
      DCL STAKE FLOAT DEC;
      DCL R3 FLOAT DEC;
      DCL CARD CHAR(19) INIT('   Q29T36A57K48J   ');
      DCL CTS(19) FIXED BIN(15);
      DCL DECK CHAR(104) VARYING;
      DCL MYHAND CHAR(7) VARYING;
      DCL URHAND CHAR(6) VARYING;
      DCL ANHAND CHAR(6) VARYING;
      DCL URBET FLOAT DEC;
      DCL INT_BET FIXED DEC(10);
      DCL HANDIS FLOAT DEC;
      DCL UTONOW FLOAT DEC;
      DCL METONOW FLOAT DEC;
      DCL TWOTONOW FLOAT DEC;
      DCL URACE CHAR(1);
      DCL ACE_A CHAR(1);
      DCL MYACE CHAR(1);
      DCL ACES CHAR(1);
      DCL NEWCARD CHAR(1);
      DCL HAND2_A CHAR(1);
      DCL HAND2_B CHAR(1);
      DCL ACECT FIXED BIN(15);
      W='  ';
      CALL HTPUT(W);
      W='Welcome to TSO BLACKJACK.';
      CALL HTPUT(W);
   M1ASK:
      W='Do you need the rules? (reply Y or N)';
      CALL HTPUT(W);
      CALL HTGET(W);
      IF W = 'Y' THEN GOTO M1INS;
      IF W = 'y' THEN GOTO M1INS;
      IF W = 'N' THEN GOTO M1X1T;
      IF W = 'n' THEN GOTO M1X1T;
      IF W = 'Q' THEN GOTO LEAVE;
      IF W = 'q' THEN GOTO LEAVE;
      W='W H A T ? ?';
      CALL HTPUT(W);
      GOTO M1ASK;
   M1INS:
      W='  ';
      CALL HTPUT(W);
      W='T H E   R U L E S';
      CALL HTPUT(W);
      W='We play with a double deck, to reduce shuffling.';
      CALL HTPUT(W);
      W='This is a gentlemen''s game. No one wins ties.';
      CALL HTPUT(W);
      W='Your BLACKJACK pays double.';
      CALL HTPUT(W);
      W='5 cards, 21 or under pays double.';
      CALL HTPUT(W);
      W='Three sevens pay double!';
      CALL HTPUT(W);
      W='Any combination of 6, 7 and 8 pay double!';
      CALL HTPUT(W);
      W='Dealer BLACKJACK wins automatically.';
      CALL HTPUT(W);
      W='BLACKJACK is defined as 21 in two (2) cards.';
      CALL HTPUT(W);
      W='ACE (A) is one (1) or eleven (11), at your option.';
      CALL HTPUT(W);
      W='You start with a stake of $100, and you may bet any or all.';
      CALL HTPUT(W);
      W='However, you may not bet less than $1.';
      CALL HTPUT(W);
      W='The game is over when : 1. You quit or,';
      CALL HTPUT(W);
      W='                        2. You go broke.';
      CALL HTPUT(W);
      W='You cannot bet more than your remaining stake.';
      CALL HTPUT(W);
      W='You lose if you go over 21.';
      CALL HTPUT(W);
      W='Dealer must hit 16 or less, must stick 17 or over.';
      CALL HTPUT(W);
      W='Call for a new deck - enter S.';
      CALL HTPUT(W);
      W='To stop playing     - enter Q.';
      CALL HTPUT(W);
      W='To get another card - enter H.';
      CALL HTPUT(W);
      W='To stick            - enter C/R.';
      CALL HTPUT(W);
      W='NOTE : C/R means CARRIAGE RETURN only (null line).';
      CALL HTPUT(W);
      W='I will re-shuffle after every BLACKJACK.';
      CALL HTPUT(W);
      W='I will re-shuffle after all the ACES have been played.';
      CALL HTPUT(W);
      W='T H A T '' S   T H E   R U L E S';
      CALL HTPUT(W);
      W='  ';
      CALL HTPUT(W);
   M1X1T:
      TME = TIME;
      R1 = SUBSTR(TME,4);
      STAKE = 100.00;
      W='Mix ''em up now.';
      CALL HTPUT(W);
      CALL MIXER;
   NEWHAND:
      IF STAKE < 1 THEN GOTO BROKE;
      DISPL = STAKE;
      W='Your stake is now' || DISPL;
      CALL HTPUT(W);
      W='Place your bet.';
      CALL HTPUT(W);
      CALL HTGET(W);
      IF W = 'Q' THEN GOTO QUIT;
      IF W = 'q' THEN GOTO QUIT;
      IF W = 'S' THEN DO; CALL MIXER;
                          GOTO NEWHAND; END;
      IF W = 's' THEN DO; CALL MIXER;
                          GOTO NEWHAND; END;
      CALL CHECK(W,I);
      IF I = 0 THEN DO; W='W H A T ? ?';
                        CALL HTPUT(W);
                        GOTO NEWHAND; END;
      INT_BET = W;
      URBET = INT_BET;
      INT_BET = 9;
      IF URBET > STAKE THEN DO; W='You can''t bet that much.';
                                CALL HTPUT(W);
                                URBET = 0;
                                GOTO NEWHAND; END;
      IF URBET < 1.0 THEN DO; W='At least $1.00, BIG SPENDER!';
                              CALL HTPUT(W);
                              URBET = 0;
                              GOTO NEWHAND; END;
      MYHAND = '      ';
      URHAND = '      ';
      URACE = 'U';
      MYACE = 'M';
      MYHAND = '';
      URHAND = '';
      HANDIS = 0;
      NEWCARD = SUBSTR(DECK,C,1);
      C = C + 1;
      CALL COUNTEM;
      URHAND = URHAND || NEWCARD;
      UTONOW = HANDIS;
      IF ACES = 'A' THEN DO; URACE = 'A';
                             ACES = 'U'; END;
      HANDIS = 0;
      IF C > 103 THEN CALL MIXER;
      NEWCARD = SUBSTR(DECK,C,1);
      C = C + 1;
      CALL COUNTEM;
      MYHAND = MYHAND || NEWCARD;
      METONOW = HANDIS;
      IF ACES = 'A' THEN DO; MYACE = 'A';
                             ACES = 'M'; END;
      IF C > 103 THEN CALL MIXER;
      NEWCARD = SUBSTR(DECK,C,1);
      C = C + 1;
      HANDIS = UTONOW;
      CALL COUNTEM;
      URHAND = URHAND || NEWCARD;
      UTONOW = HANDIS;
      IF ACES = 'A' THEN DO; URACE = 'A';
                             ACES = 'U'; END;
      IF C > 103 THEN CALL MIXER;
      W='Your hand is ' || URHAND;
      CALL HTPUT(W);
      NEWCARD = SUBSTR(DECK,C,1);
      C = C + 1;
      HANDIS = METONOW;
      CALL COUNTEM;
      MYHAND = MYHAND || NEWCARD;
      METONOW = HANDIS;
      IF ACES = 'A' THEN DO; MYACE = 'A';
                             ACES = 'M'; END;
      IF C > 103 THEN CALL MIXER;
      W='Dealer shows (-)' || NEWCARD;
      CALL HTPUT(W);
      IF MYACE = 'A' THEN DO; IF METONOW = 11.0 THEN GOTO MYBJ; END;
      IF UTONOW = 11.0 THEN DO; IF URACE = 'A' THEN GOTO URBJ;
                                ELSE GOTO DUBLDOWN; END;
      IF SUBSTR(URHAND,1,1) = SUBSTR(URHAND,2,1) THEN GOTO SPLIT;
   NEXTPLAY:
      W='Your play, hit or stick?';
      CALL HTPUT(W);
      CALL HTGET(W);
      IF I = 0 THEN GOTO IPLAY;
      IF W = 'H' THEN GOTO HIT;
      IF W = 'h' THEN GOTO HIT;
      IF W = 'Q' THEN GOTO QUIT;
      IF W = 'q' THEN GOTO QUIT;
      IF W = 'S' THEN DO; CALL MIXER;
                          GOTO NEXTPLAY; END;
      IF W = 's' THEN DO; CALL MIXER;
                          GOTO NEXTPLAY; END;
      W='W H A T ? ?';
      CALL HTPUT(W);
      GOTO NEXTPLAY;
   IPLAY:
      IF INT_BET = 1 THEN GOTO SPL1T;
      IF METONOW > 21.0 THEN GOTO MAYBEPAY;
      IF METONOW > 16.0 THEN GOTO THECALL;
      IF MYACE = 'M' THEN GOTO IHIT;
      IF MYACE = 'W' THEN GOTO IHIT;
      METONOW = METONOW + 10.0;
      MYACE = 'W';
      IF METONOW < 22.0 THEN GOTO IPLAY;
      MYACE = 'M';
      METONOW = METONOW - 10.0;
   IHIT:
      NEWCARD = SUBSTR(DECK,C,1);
      C = C + 1;
      IF C > 103 THEN CALL MIXER;
      HANDIS = METONOW;
      CALL COUNTEM;
      MYHAND = MYHAND || NEWCARD;
      W='Dealer now shows ' || MYHAND;
      CALL HTPUT(W);
      METONOW = HANDIS;
      IF ACES = 'A' THEN DO; MYACE = 'W';
                             METONOW = METONOW + 10.0;
                             ACES = 'M'; END;
      IF METONOW > 21.0 THEN GOTO MAYBEPAY;
                        ELSE GOTO IPLAY;
   MAYBEPAY:
      IF MYACE = 'M' THEN GOTO PAYHIM;
      IF MYACE = 'W' THEN MYACE = 'M';
                 ELSE GOTO PAYHIM;
      METONOW = METONOW - 10.0;
      GOTO IPLAY;
  QUIT:
      DISPL = STAKE;
      W='You started with $100, you now have' || DISPL;
      CALL HTPUT(W);
      STAKE = STAKE - 100.00;
      IF STAKE > 0 THEN W='You''re a winner!';
                   ELSE W='Sorry about that!';
      CALL HTPUT(W);
  LEAVE:
      W='That''s all folks. Bye-Bye, old chap.';
      CALL HTPUT(W);
      RETURN;
   THECALL:
      IF URACE = 'U' THEN GOTO CALL1;
      UTONOW = UTONOW + 10.0;
      URACE = 'U';
      IF UTONOW < 22.0 THEN GOTO CALL1;
      UTONOW = UTONOW - 10.0;
   CALL1:
      DISPL = UTONOW;
      W='You    =' || DISPL || ' with ' || URHAND;
      CALL HTPUT(W);
      DISPL = METONOW;
      W='Dealer =' || DISPL || ' with ' || MYHAND;
      CALL HTPUT(W);
      IF METONOW > UTONOW THEN GOTO YOULOSE;
      IF UTONOW > METONOW THEN GOTO PAYHIM;
      W='Tie hand, no winner.';
      CALL HTPUT(W);
      IF INT_BET = 2 THEN GOTO MORE_PAY;
      GOTO NEWHAND;
   DOUBLE5:
      W='You have 5 cards under 21.';
      CALL HTPUT(W);
   PAY2X:
      W='I pay double - BOO HOO!';
      CALL HTPUT(W);
      STAKE = STAKE + URBET;
   PAYHIM:
      STAKE = STAKE + URBET;
      W='I pay.';
      CALL HTPUT(W);
      IF INT_BET = 2 THEN GOTO MORE_PAY;
      IF INT_BET = 1 THEN DO; INT_BET = 0;
                              GOTO  SPLAT; END;
      URBET = 0;
      GOTO NEWHAND;
   BUSTED:
      W='Sorry, you lose! You''re over 21 with ' || URHAND;
      IF INT_BET = 2 THEN DO; CALL HTPUT(W);
                              INT_BET = 0;
                              UTONOW = TWOTONOW;
                              URHAND = '      ';
                              URHAND = ANHAND;
                              STAKE = STAKE - URBET;
                              GOTO IPLAY; END;
   BUSTER:
      CALL HTPUT(W);
      STAKE = STAKE - URBET;
      IF INT_BET = 1 THEN DO; INT_BET = 0;
                              GOTO  SPLAT; END;
      IF INT_BET = 2 THEN GOTO MORE_PAY;
      URBET = 0;
      GOTO NEWHAND;
   BROKE:
      W='Too bad, you just went broke.';
      CALL HTPUT(W);
      GOTO QUIT;
   YOULOSE:
      W='You lose this one.';
      GOTO BUSTER;
   DUBLDOWN:
      W='You have 11 in two cards.';
      CALL HTPUT(W);
      W='You may double your bet on one more card.';
      CALL HTPUT(W);
      W='Enter Y if you wish to try it, else enter N if not.';
      CALL HTPUT(W);
      CALL HTGET(W);
      IF W = 'Q' THEN GOTO QUIT;
      IF W = 'q' THEN GOTO QUIT;
      IF W = 'Y' THEN GOTO ONECARD;
      IF W = 'y' THEN GOTO ONECARD;
      IF W = 'N' THEN GOTO NEXTPLAY;
      IF W = 'n' THEN GOTO NEXTPLAY;
      W='Wrong answer, let''s try it again.';
      CALL HTPUT(W);
      GOTO DUBLDOWN;
   HIT:
      NEWCARD = SUBSTR(DECK,C,1);
      C = C + 1;
      IF C > 103 THEN CALL MIXER;
      HANDIS = UTONOW;
      CALL COUNTEM;
      URHAND = URHAND || NEWCARD;
      W='You now show ' || URHAND;
      CALL HTPUT(W);
      UTONOW = HANDIS;
      IF ACES = 'A' THEN DO; URACE = 'A';
                             ACES = 'U'; END;
      IF UTONOW > 21.0 THEN GOTO BUSTED;
      NEWCARD = SUBSTR(URHAND,5,1);
      IF UTONOW = 21.0 THEN GOTO GOT21;
   H1T:
      IF NEWCARD = ' ' THEN GOTO NEXTPLAY;
                       ELSE GOTO DOUBLE5;
   GOT21:
      IF SUBSTR(URHAND,1,1) ¬= '7' THEN GOTO TRY6AND8;
      IF SUBSTR(URHAND,2,1) ¬= '7' THEN GOTO TRY6OR8;
      IF SUBSTR(URHAND,3,1) ¬= '7' THEN GOTO H1T;
      IF SUBSTR(URHAND,4,1) ¬= ' ' THEN GOTO H1T;
                                   ELSE GOTO PAY2X;
   ONECARD:
      URBET = URBET * 2.0;
      IF URBET > STAKE THEN DO;
                       W='Sorry, you can''t double up, not enuff $$.';
                       CALL HTPUT(W);
                       URBET = URBET / 2.0;
                       GOTO NEXTPLAY; END;
      NEWCARD = SUBSTR(DECK,C,1);
      C = C + 1;
      IF C > 103 THEN CALL MIXER;
      HANDIS = UTONOW;
      CALL COUNTEM;
      URHAND = URHAND || NEWCARD;
      W='You now show ' || URHAND;
      CALL HTPUT(W);
      UTONOW = HANDIS;
      GOTO IPLAY;
   URBJ:
      W='You have BLACKJACK!';
      CALL HTPUT(W);
      CALL MIXER;
      GOTO PAY2X;
   MYBJ:
      W='Dealer has BLACKJACK. Shows ' || MYHAND;
      CALL HTPUT(W);
      CALL MIXER;
      GOTO YOULOSE;
   SPLIT:
      HANDIS = URBET * 2;
      IF HANDIS > STAKE THEN GOTO NO_SPLIT;
      W='You have doubles, with ' || URHAND;
      CALL HTPUT(W);
      W='If you wish you may split them (playing them as two hands).';
      CALL HTPUT(W);
      W='Enter Y, otherwise enter N.';
      CALL HTPUT(W);
      CALL HTGET(W);
      IF W = 'Q' THEN GOTO QUIT;
      IF W = 'q' THEN GOTO QUIT;
      IF W = 'N' THEN GOTO NEXTPLAY;
      IF W = 'n' THEN GOTO NEXTPLAY;
      IF W = 'Y' THEN GOTO SPLIT_TING;
      IF W = 'y' THEN GOTO SPLIT_TING;
      W = 'W H A T ? ?';
      CALL HTPUT(W);
      GOTO SPLIT;
   SPLIT_TING:
      IF URACE ¬= 'A' THEN GOTO SPL1T_T1NG;
      URACE = 'U';
      IF SUBSTR(URHAND,1,1) = 'A' THEN URACE = 'A';
   SPL1T_T1NG:
      HAND2_A = SUBSTR(URHAND,2,1);
      HANDIS = 0;
      NEWCARD = SUBSTR(URHAND,1,1);
      CALL COUNTEM;
      NEWCARD = SUBSTR(DECK,C,1);
      C = C + 1;
      CALL COUNTEM;
      UTONOW = HANDIS;
      IF ACES = 'A' THEN DO; URACE = 'A';
                             ACES = 'U'; END;
      IF C > 103 THEN CALL MIXER;
      SUBSTR(URHAND,2,1) = NEWCARD;
      HAND2_B = SUBSTR(DECK,C,1);
      C = C + 1;
      IF C > 103 THEN CALL MIXER;
      INT_BET = 1;
      W='Your first hand shows ' || URHAND;
      CALL HTPUT(W);
      GOTO NEXTPLAY;
   SPL1T:
      INT_BET = 2;
   SPLAT:
      ANHAND = URHAND;
      URHAND = '      ';
      URHAND = '';
      TWOTONOW = UTONOW;
      HANDIS = 0;
      NEWCARD = HAND2_A;
      URHAND = URHAND || HAND2_A;
      CALL COUNTEM;
      NEWCARD = HAND2_B;
      URHAND = URHAND || HAND2_B;
      CALL COUNTEM;
      UTONOW = HANDIS;
      W='Your second hand shows ' || URHAND;
      CALL HTPUT(W);
      ACE_A = URACE;
      URACE = 'U';
      IF HAND2_A = 'A' THEN DO; URACE = 'A';
                                ACES = 'U'; END;
      IF HAND2_B = 'A' THEN DO; URACE = 'A';
                                ACES = 'U'; END;
      GOTO NEXTPLAY;
   NO_SPLIT:
      W='You don''t have enuff $ for doubles!';
      CALL HTPUT(W);
      GOTO NEXTPLAY;
   MORE_PAY:
      INT_BET = 0;
      UTONOW = TWOTONOW;
      URHAND = '      ';
      URHAND = ANHAND;
      URACE = ACE_A;
      IF METONOW > 21.0 THEN GOTO PAYHIM;
      IF SUBSTR(URHAND,5,1) = ' ' THEN GOTO THECALL;
                                  ELSE GOTO IPLAY;
   TRY6AND8:
      IF SUBSTR(URHAND,1,1)  = '6' THEN GOTO GOT6_1;
      IF SUBSTR(URHAND,1,1) ¬= '8' THEN GOTO H1T;
      IF SUBSTR(URHAND,2,1)  = '7' THEN GOTO GOT87;
      IF SUBSTR(URHAND,2,1) ¬= '6' THEN GOTO H1T;
   GOT86:
      IF SUBSTR(URHAND,3,1)  = '7' THEN GOTO PAY2X;
                                   ELSE GOTO H1T;
   GOT6_1:
      IF SUBSTR(URHAND,2,1)  = '8' THEN GOTO GOT86;
      IF SUBSTR(URHAND,2,1) ¬= '7' THEN GOTO H1T;
   GOT67:
      IF SUBSTR(URHAND,3,1)  = '8' THEN GOTO PAY2X;
                                   ELSE GOTO H1T;
   GOT87:
      IF SUBSTR(URHAND,3,1)  = '6' THEN GOTO PAY2X;
                                   ELSE GOTO H1T;
   TRY6OR8:
      IF SUBSTR(URHAND,2,1)  = '8' THEN GOTO GOT87;
      IF SUBSTR(URHAND,2,1)  = '6' THEN GOTO GOT67;
                                   ELSE GOTO H1T;
0  COUNTEM: PROC;
   RECOUNT:
      IF NEWCARD = '2' THEN GOTO ADD2;
      IF NEWCARD = '4' THEN GOTO ADD4;
      IF NEWCARD = '6' THEN GOTO ADD6;
      IF NEWCARD = '8' THEN GOTO ADD8;
      IF NEWCARD = 'T' THEN GOTO ADD10;
      IF NEWCARD = 'J' THEN GOTO ADD10;
      IF NEWCARD = 'Q' THEN GOTO ADD10;
      IF NEWCARD = 'K' THEN GOTO ADD10;
      IF NEWCARD = '3' THEN GOTO ADD3;
      IF NEWCARD = '5' THEN GOTO ADD5;
      IF NEWCARD = '7' THEN GOTO ADD7;
      IF NEWCARD = '9' THEN GOTO ADD9;
      IF NEWCARD = 'A' THEN DO; ACES = 'A';
                                HANDIS = HANDIS + 1.0;
                                ACECT = ACECT + 1;
                                IF ACECT > 7 THEN CALL MIXER;
                                RETURN; END;
      W='OOPS, deck has been dropped.';
      CALL HTPUT(W);
      CALL MIXER;
      NEWCARD = SUBSTR(DECK,C,1);
      C = C + 1;
      GOTO RECOUNT;
   ADD9: HANDIS = HANDIS + 2.0;
   ADD7: HANDIS = HANDIS + 2.0;
   ADD5: HANDIS = HANDIS + 2.0;
   ADD3: HANDIS = HANDIS + 1.0;  GOTO ADD2;
   ADD10: HANDIS = HANDIS + 2.0;
   ADD8: HANDIS = HANDIS + 2.0;
   ADD6: HANDIS = HANDIS + 2.0;
   ADD4: HANDIS = HANDIS + 2.0;
   ADD2: HANDIS = HANDIS + 2.0;
      RETURN;
   END COUNTEM;
0  MIXER: PROC;
      CTS = 0;
      DECK = '';
      CDS = 0;
   MIXERS:
      CALL RAND(R1,R3);
      C = FLOOR(18 * R3 + 1.5);
      IF CTS(C) > 7 THEN GOTO MIXERS;
      IF C > 16 THEN GOTO MIXERS;
      IF C <  4 THEN GOTO MIXERS;
      CTS(C) = CTS(C) + 1;
      DECK = DECK || SUBSTR(CARD,C,1);
      CDS = CDS + 1;
      IF CDS < 104 THEN GOTO MIXERS;
      C = 1;
      W='S H U F F L E';
      CALL HTPUT(W);
      ACECT = 0;
      RETURN;
   END MIXER;
0  HTPUT: PROC(S);
      DCL S CHAR(120) VAR;
      DCL RC FIXED BIN(15);
      DCL TPUT ENTRY(CHAR(120) VAR, FIXED BIN(15));
   WR:
      CALL TPUT(S,RC);
      IF RC = 8 THEN GOTO WR;
      IF RC¬= 0 THEN CALL PLIDUMP;
      RETURN;
   END HTPUT;
0  HTGET: PROC(Y);
      DCL Y CHAR(120) VAR;
      DCL RC FIXED BIN(15);
      DCL TGET ENTRY (CHAR(120) VAR, FIXED BIN(15));
   READ1T:
      Y = ' ';
      CALL TGET(Y,RC);
      IF RC = 8 THEN GOTO READ1T;
      IF RC¬= 0 THEN CALL PLIDUMP;
      I = LENGTH(Y);
      RETURN;
   END HTGET;
 END BLAKJAK;
