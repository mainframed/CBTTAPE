++PTF(HG00102)
  /* MODIFY 'SET CLOCK COMPARATOR' TO ESTABLISH AN
     OPTIONAL CPU AFFINITY FOR TQES ASSOCIATED WITH
     DIE ROUTINES */.
++VER(Z037) PRE(UZ80700 UZ08819).
++ZAP(IEAVRTI0).
 NAME IEA0TI00
 EXPAND IEA0TI00(256)
*                            USING IEA0TI00+X'6A',R9
*                            USING PSA,R0
*                            USING TQE,R11
*                            ORG   ZAPPED
VER 0AA4 4770,9B0E           BNZ   NOQUE
*                   QUE      EQU   *
VER 0AA8 58C0,0208           L     R12,PSAPCCAV
*                   RET      EQU   *
*                            ORG   PATCH
VER 0EF0 0000,0000,0000,0000 DC    XL12'00'
*                            ORG   QUE
REP 0AA8 47F0,9E86           B     PATCH
*                            ORG   PATCH
* THE 'SET CLOCK COMPARATOR' ENTRY POINT OF THE
* TIMER SUPERVISOR MODULE IS INVOKED BY TQE ENQUE AND DEQUE
* SERVICES WHEN A TQE IS ADDED OR REMOVED FROM THE REAL TIME
* QUEUE. THIS ZAP IS ENTERED WHEN THAT ROUTINE HAS DETERMINED
* THAT THE FIRST TQE IS NOT BEING TIMED OR THAT
* THE CURRENT CPU IS NOT TIMING ANYTHING.
* UNDER THIS APPROACH, A TQE CAN BE SIMULTANEOUSLY TIMED ON
* BOTH CPUS IN AN MP OR AP CONFIGURATION, BUT IT IS NOT
* ALWAYS DOUBLY TIMED. THE GUARANTEE THAT CPUS ARE
* EACH TIMING SOMETHING APPEARS TO BE A RELIABILITY FEATURE
* TO RECOVER TIMING SHOULD ONE CLOCK COMPARATOR SUDDENLY STOP
* GENERATING INTERRUPTS.
* THERE ARE TWO POSSIBLE
* DISPOSITIONS OF THE TQE:
*   1) A BRANCH TO 'RET' WILL RETURN TO THE NORMAL LOGIC AND
*      WILL CAUSE THE CLOCK COMPARATOR ON THIS CPU TO BE SET
*      TO THE TQEVAL VALUE IN THE TQE POINTED TO BY R11.
*   2) A BRANCH TO NOQUE WILL BYPASS PROCESSING FOR ANY TQE
*      CAUSING THE CLOCK COMPARATOR FOR THIS CPU TO REMAIN
*      UNCHANGED.
* THIS IDENTICAL CODE CAN BE INVOKED ON THE OTHER CPU IN AN MP
* OR AP ENVIRONMENT BY ISSUING A RPSGNL MACRO AS IS DONE BELOW.
* HENSE, OPTION 2) DOES NOT NECESSARILY LEAVE THE TQE 'HANGING'
* AS LONG AS THE OTHER CPU IS NOTIFIED TO PICK IT UP.
* THERE IS A LITTLE KLUGE IN THIS CODE FOR WHICH APOLOGIES ARE
* DUE. TO AVOID USING RESERVED BITS IN THE TQE, WE USE THE LOW
* ORDER 8 BITS OF THE TOD TIME STAMP IN 'TQEVAL'. SINCE THE
* STCK INSTRUCTION ON ALL 370 COMPUTERS LEAVE THE LOW ORDER 12
* BITS ZERO, THESE BITS ARE ALL USUALLY OFF. IF THEY ARE ALMOST
* ALL ON (SEE BELOW), THEN THIS IS TREATED AS AN INDICATION OF
* CPU AFFINITY. NOTE THAT NO JOB IS IMPACTED ADVERSLY BY
* INADVERTENTLY BEING CAUGHT BY THIS TRAP.
REP 0EF0 58C0,0208           L     R12,PSAPCCAV       PERFORM ZAPPED INSTRUCTION
REP 0EF4 9180,B058           TM    TQEFLGS3,TQEDIE    IS THIS A DIE
REP 0EF8 4780,9A42           BZ    RET                NO, THEN NO CHANGE
REP 0EFC 91FE,B017           TM    TQETOD8,X'FE'      KLUGE: TEST UNUSUAL TIME S
REP 0F00 47E0,9A42           BNO   RET                IF NOT FUNNY, THEN NO CHAN
REP 0F04 1BEE                SR    R14,R14            R14=0 PROVISIONALLY
REP 0F06 9101,B017           TM    TQETOD8,X'01'      CHECK CPU0/CPU1 AFFINITY
REP 0F0A 4780,9EA8           BZ    *+8                IF CPU0 AFFINITY, R14 STAY
REP 0F0E 41E0,0001           LA    R14,1              ELSE R14=1
REP 0F12 49E0,0204           CH    R14,PSACPUPA       IS CURRENT CPU THE CHOSEN
REP 0F16 4780,9A42           BE    RET                YES, RETURN
REP 0F1A 9180,B00F           TM    TQEFLGS2,TQECOMP   IS IT BEING TIMED ON THAT
REP 0F1E 4780,9EC0           BZ    SIGNAL             NO, GOT TO WAKE IT UP
*                                 GET HERE CAUSE THE COMPARATOR
*                                 ON THIS CPU IS IDLE, BUT THE
*                                 TOP TQE HAS AFFINITY TO THE
*                                 OTHER FELLOW. CANT JUST QUIT
*                                 CAUSE RECOVERY DEPENDS ON
*                                 US TIMING SOMETHING, SO GO TO
*                                 THE NEXT TQE IN THE QUEUE AND
*                                 PROCESS IT.
REP 0F22 58B0,B004           L     R11,TQEFLNK        TRY NEXT TQE
REP 0F26 47F0,9E86           B     PATCH              GO BACK AND TEST
*                   SIGNAL   EQU   *
REP 0F2A 5810,0010           L     R1,CVTPTR
REP 0F2E 5811,02FC           L     R1,CVTPCCAT-CVT(R1)
*                            USING PCCAVT,R1
REP 0F32 89E0,0002           SLL   R14,2              SHIFT CPU ID
REP 0F36 581E,1000           L     R1,PCCAT00P(R14)   FIND TARGET PCCA
*                            USING PCCA,R1
REP 0F3A 1211                LTR   R1,R1              DOES THE CPU EXIST?
REP 0F3C 4780,9A42           BZ    RET                NO, THEN CAN'T USE IT
REP 0F40 9180,1082           TM    PCCACCE,PCCANUCC   IS THE CLOCK GOOD ON THAT
REP 0F44 4710,9A42           BO    RET                NO, THEN TIME ON THIS ONE
*                            DROP  R1
*                            RPSGNL RQCHECK,CPU=(1)   SIGNAL OTHER CPU TO QUE TC
REP 0F48 4100,0020           LA    0,32(0,0)                X'20' - RQCHECK FUNC
REP 0F4C 8900,0018           SLL   0,24(0)                  SHIFTED INTO HIGH OR
REP 0F50 58E0,0010           L     14,CVTPTR(0,0)           CVT ADDRESS
REP 0F54 58F0,E2F8           L     15,CVTIPCRP-CVT(0,14)    IEAVERP ENTRY POINT
REP 0F58 05EF                BALR  14,15                    ENTER IEAVERP AND ES
REP 0F5A 12FF                LTR   R15,R15            SIGNAL SUCCESSFUL?
REP 0F5C 4770,9A42           BNZ   RET                NO  BETTER QUE IT ON THIS
REP 0F60 47F0,9B0E           B     NOQUE
* DECK PRODUCED BY THE ASMTOZAP UTILITY 78/01/04 093723
