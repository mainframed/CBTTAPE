         TITLE 'MAPINIT - SCAN VOLUME VTOC'
***********************************************************************
*
*  ALL COMMENTS ARE INTERPRETATIONS BY EITHER THE DISASSEMBLER
*  OR GUY ALBERTELLI.
*
***********************************************************************
*
*  FOLLOWING ZAPS HAVE BEEN INTEGRATED IN SOURCE:
*     ZAP1 -  SPACE FOR MULTIPLE VOLUMES
*     ZAP8 -  SET UCBNAME IN OUTPUT LISTING
*
***********************************************************************
*
*  FOLLOWING ENHANCEMENTS HAVE BEEN ADDED:
*   16JUN92  -USE DEVTYPE MACRO INSTEAD OF TABLE TO GET DEVICE
*             CONSTANTS.
*   17JUN92  -USE CVAFDSM MACRO TO GET FREE SPACE FOR INDEX-VTOC
*             PACKS
*            -REMOVED NOPR INSTRUCTIONS
*            -CONVERTED 'BC  N,' TO EXTENDED BRANCHES
*   18JUN92  -ADDED ELEMENT TO MAPDEV TABLE TO LIST ALTERNATE CYLS
*             SO THAT THE DEVTYPE CALCULATIONS ARE CORRECT.
*   02JUL92  -ADD DYNALLOC SO THAT DDCARDS DO NOT HAVE TO BE PRESENT
*   13JUL92  -CORRECT BRANCH IN F1 DSCB PROCESSING
*   04AUG92  -CORRECT CHAINING OF DDNS FOR CASE WHERE NO DD CARDS
*             EXIST AND ALL IS DONE VIA DYNAMIC ALLOCATION. CODE LEFT
*             DDNS BLOCK THAT WAS ALL ZEROS ON CHAIN.
*            -CHANGE FUNCTION OF MAPDEV AND ALSO CALL IT IN DYNAMIC
*             ALLOCATION TO GET DEVICE NAME OF NEWLY ALLOCATED DEVICE
*   20AUG92  -ATTEMPT TO SPEED UP DSCB ACCESS BY USING CVAF MACROS
*             TO READ IN GROUPS OF DSCBS AT ONE TIME. THE ORIGINAL CODE
*             RESULTED IN 1 DISK REVOLUTION PER DSCB.
*   07OCT92  -CORRECT PROBLEM WITH RETAINING EOD INDICATION FROM CVAF
*             ACCESS. THIS PROBLEM CAUSED MAPINIT TO OCCASIONALLY
*             LOOP FOREVER READING VTOCS.
*            -CORRECT CREATION OF F5 DSCBS WHEN USING INDEXED VTOC.
*
***********************************************************************
MAPINIT  CSECT
         ENTRY MAPER
         USING WORKAREA,R11                                     20AUG92
         USING EXTREFS,R6
         USING *,R12
MAPER    EQU   *
         B    A000020
         DC   AL1(A000020-*)
         DC   C'MAPINIT  &SYSDATE &SYSTIME'
A000020  LA    R1,2856(,R11)
         L     R15,ADATER37
         BALR  R14,R15                     STD LINKAGE
         LA    R15,2140(,R11)
         LA    R1,2856(,R11)
         MVC   117(5,R15),1(R1)
         MVC   96(11,R15),13(R1)
         MVC   112(4,R15),7(R1)
         LA    R3,2648(,R11)
         L     R1,AMAPKEY
         TM    2941(R11),X'20'
         LM    R15,R0,2648(R11)            RESTORE REGS
         BZ    A000078
         L     R2,2896(,R11)
A000060  L     R3,4(,R2)
         LTR   R3,R3
         BZ    A0000A8
         LM    R15,R0,0(R3)                RESTORE REGS
         STM   R15,R0,2648(R11)            SAVE REGS
A000078  CL    R15,0(R1)
         BNE   A000088
         CL    R0,4(R1)
         BE    A000098
A000088  CLI   0(R1),X'FF'
         BE    A0000D0
         LA    R1,16(R1)
         B     A000078
A000098  OC    2938(6,R11),8(R1)
         TM    2941(R11),X'20'
         BZ    A0000F0
A0000A8  L     R2,0(,R2)
         LTR   R2,R2
         BZ    A0000C0
         L     R1,AMAPKEY
         B     A000060
A0000C0  NI    2941(R11),X'DF'
         CLC   2938(6,R11),1504(R11)
         BNE   A0000F0
A0000D0  LA    R7,6
         BAL   R14,IMAP04B0                PERFORM
         MVC   1862(8,R11),2648(R11)
         MVI   1852(R11),X'60'
         BAL   R14,IMAP0328                PERFORM
         B     IMAP0088
A0000F0  LA    R15,2140(,R11)
         MVC   3(6,R15),1624(R11)
         XC    964(12,R11),964(R11)
         XC    3668(44,R11),3668(R11)
         XC    3712(44,R11),3712(R11)
         XC    3768(40,R11),3768(R11)
         XC    3808(40,R11),3808(R11)
         XC    3644(24,R11),3644(R11)
         STD   R4,2568(,R11)
         LA    R1,1552(,R11)
         ST    R1,2900(,R11)
         LA    R1,956(,R11)
         ST    R1,956(,R11)
         L     R5,608(,R11)
         XC    0(176,R5),0(R5)
         CLI   2752(R11),C' '
         BE    A000190
         MVC   0(44,R5),2752(R11)
         TM    2942(R11),X'80'
         BO    A000170
         CLI   1096(R11),C' '
         BNE   A000190
         TM    2938(R11),X'04'
         BO    A0009A8
A000170  LA    R1,808(,R11)
         SVC   26                          LOCATE, ETC
         LTR   R15,R15
         BNZ   A000B40
         L     R3,820(,R11)
         MVC   1096(6,R11),6(R3)
         MVC   2752(44,R11),0(R5)
A000190  TM    2938(R11),X'04'
         BO    A0009A8
*
*   LOOP THROUGH DDNAME BLOCKS AND LOCATE REQUESTED VOLSER
*
A000198  L     R2,2888(,R11)            GET HEAD OF DDNS
         LTR   R2,R2                    ANY THERE?              04AUG92
         BZ    A0001A1                  NOPE, USE DYNAMIC ALLOC 04AUG92
A0001A0  CLC   16(6,R2),1096(R11)       LOCATE VOL IN CHAIN OF DDNS
         BE    A0001C0                  FOUND
         L     R2,0(,R2)                GO TO NEXT DDN BLOCK
         LTR   R2,R2
         BNZ   A0001A0
A0001A1  DS    0H                                               04AUG92
*                                                               02JUL92
**       SINCE THE REQUESTED VOLSER WAS NOT PRESENT IN THE      02JUL92
**       KNOWN DD CARDS, ALLOCATE A NEW DDCARD AND CREATE       02JUL92
**       THE APPROPRIATE BLOCK.                                 02JUL92
*                                                               02JUL92
         GETMAIN R,LV=WRKLEN,SP=1                               02JUL92
         LR    R7,R1                                            02JUL92
         USING WRK,R7                                           02JUL92
         XC    WRK(WRKLEN),WRK  CLEAR NEW AREA                  02JUL92
         MVC   TXT1(TXTLEN),RTXT1 SET REAL TEXT UNIT DATA       02JUL92
         MVC   TXT1+6(6),1096(R11)   SET REAL VOLSER            02JUL92
         LA    R1,DYRB          SETUP                           02JUL92
         ST    R1,PLIST           PLIST POINTER                 02JUL92
         OI    PLIST,X'80'      SET END OF LIST INDICATOR       02JUL92
         LA    R1,TXT1          SETUP                           02JUL92
         ST    R1,TXTUP            TEXT                         02JUL92
         LA    R1,TXT2                UNIT                      02JUL92
         ST    R1,TXTUP+4                POINTER                02JUL92
         LA    R1,TXT3                      LIST                02JUL92
         ST    R1,TXTUP+8                                       02JUL92
         LA    R1,TXT4                                          02JUL92
         ST    R1,TXTUP+12                                      02JUL92
         OI    TXTUP+12,X'80'   SET END OF LIST INDICATOR       02JUL92
         LA    R15,DYRB                                         02JUL92
         USING S99RB,R15                                        02JUL92
         LA    R1,TXTUP                                         02JUL92
         ST    R1,S99TXTPP                                      02JUL92
         MVI   S99VERB,S99VRBAL SET TO DSN ALLOCATION           02JUL92
         MVI   S99FLAG1,S99NOMNT  MARK NOT TO MOUNT             02JUL92
         MVI   S99RBLN,20         SET LENGTH OF BLK             02JUL92
         DROP  R15                                              02JUL92
         LA    R1,PLIST                                         02JUL92
         DYNALLOC ,                                             02JUL92
         LTR   R15,R15          ANY ERROR                       02JUL92
         BNZ   A000B98          ISSUE ERROR MESSAGE             02JUL92
         MVC   DDNBLK+8(8),TXT4+6   MOVE IN DDNAME              02JUL92
*LOOKUP DDN IN TIOT                                             02JUL92
         L     R15,16               GET CVT ADDRESS             02JUL92
         L     R15,0(,R15)          GET TCBWORDS ADDRESS        02JUL92
         L     R15,0(,R15)          GET MY TCB ADDRESS          02JUL92
         L     R15,12(,R15)         GET TIOT ADDRESS            02JUL92
         LA    R15,24(,R15)         GET DEVICE ENTRY PORTION    02JUL92
A1       SR    R0,R0                                            02JUL92
         IC    R0,0(,R15)           GET LENGTH OF ENTRY         02JUL92
         LTR   R0,R0                END OF TIOT???              02JUL92
         BZ    A3                                               02JUL92
         CLI   4(R15),C' '          DDNAME BLANK                02JUL92
         BE    A2                                               02JUL92
         CLC   4(8,R15),DDNBLK+8    MATCH DDNAME                02JUL92
         BE    A4                                               02JUL92
A2       AR    R15,R0               BUMP TO NEXT TIOT           02JUL92
         B     A1                                               02JUL92
A3       DS    0H                   ALLOCATED BUT NOT FOUND     02JUL92
         B     A000B98                                          02JUL92
*FILL IN BLOCK                                                  02JUL92
A4       DS    0H                                               02JUL92
         L     R2,16(,R15)          GET UCB ADDRESS             02JUL92
         N     R2,=A(X'00FFFFFF')   CLEAN TO 3 BYTES            02JUL92
         ST    R2,DDNBLK+4          SAVE UCB ADDRESS            02JUL92
         MVC   DDNBLK+16(6),28(R2)  SET VOLSER                  02JUL92
         MVC   DDNBLK+24(4),16(R2)  SET DEVICE TYPE             02JUL92
*                                                               04AUG92
**       CALL MAPDEV TO GET DEVICE NAME                         04AUG92
*                                                               04AUG92
         L     R1,DDNBLK+24         GET DEVICE TYPE VALUD       04AUG92
         L     R15,AMAPDEV          GET ADDRESS                 04AUG92
         BALR  R14,R15              GO TO IT                    04AUG92
         USING MAPDEVD,R1           SETUP ADDRESSABILITY        04AUG92
         MVC   DDNBLK+32(15),MDDEVNAM MOVE IN DEVICE NAME       04AUG92
         DROP  R1                                               04AUG92
         MVI   DDNBLK+32+15,C' '    AND LAST BLANK              04AUG92
*                                                               02JUL92
**       CHAIN TO DDNS BLOCKS (2888(,R11))                      02JUL92
*                                                               02JUL92
         MVC   DDNBLK(4),2888(R11)  GET OLD CHAIN ADDRESS       02JUL92
         ST    R7,2888(,R11)        SAVE NEW BLOCK ADDRESS      02JUL92
         DROP  R7                                               02JUL92
         LR    R2,R7                PREPARE TO REJOIN CODE      02JUL92
*
*   DDNAME BLOCK FOUND, SET DDNAME AND PROCESS
*
A0001C0  LA    R7,380(,R11)             -|  SET DDNAME
         LD    R0,8(,R2)                 |      EVERYWHERE
         STD   R0,40(,R7)                |          NEEDED
         LA    R7,136(,R11)              |
         STD   R0,40(,R7)                |
         LA    R7,556(,R11)              |
         STD   R0,40(,R7)                |
         LA    R7,468(,R11)              |
         STD   R0,40(,R7)               -|
         L     R14,4(,R2)               GET UCB ADDRESS
         ST    R14,1136(,R11)           SAVE ADDRESS
         L     R14,24(,R2)              GET UCBTYP WORD
         ST    R14,1092(,R11)           SAVE IT
         STC   R14,2957(,R11)           SAVE JUST DEVICE CODE
         LD    R0,32(,R2)               GET DEVICE NAME (FROM CATDEV)
         STD   R0,3592(,R11)            SAVE IT FOR LATER
         CLI   1094(R11),X'20'          CHECK FOR DASD DEVICE TYPE
         BNE   A000BA0
         MVI   BFGFLAG,0                CLEAR ALL FLAGS         20AUG92
*                                                               04AUG92
**       CALL MAPDEV TO GET DEVICE CONSTANTS BLOCK              04AUG92
*                                                               04AUG92
         LR    R1,R14                    GET DEVICE CODE        04AUG92
         L     R15,AMAPDEV               GET ADDRESS            04AUG92
         BALR  R14,R15                   GO TO IT               04AUG92
         LR    R2,R1                     PUT BACK FOR LATER CODE04AUG92
         SPACE 2                                                04AUG92
A000230  ST    R2,1072(,R11)            SAVE MAPDEV ENTRY ADDRESS
***********************************************************************
*  START OF NEW CODE FOR DEVTYPE USAGE                          16JUN92
* ORIG   MVC   1076(12,R11),16(R2)      MOVE IN DATA FROM MAPDEV
         LA    R0,2284(,R11)            GET ADDRESS OF WORKAREA 16JUN92
         DEVTYPE 596(R11),((0),24),DEVTAB                       16JUN92
         LTR   R15,R15                  ANY ERROR               16JUN92
         BNZ   A000BA8                  ISSUE UNKNOWN DEVICE    16JUN92
         LH    R1,2284+4+4+2(,R11)      GET WORD 2 BYTES 2-3    16JUN92
         STH   R1,1076(,R11)            SAVE TRACKS PER CYL     16JUN92
         STH   R1,1078(,R11)                                    16JUN92
         STH   R1,1084(,R11)                                    16JUN92
         MVC   1080(4,R11),=AL2(0,1)    SET HH CONSTANTS        16JUN92
         LH    R1,2284+4+4(,R11)        GET WORD 2 BYTES 0-1    16JUN92
         SH    R1,28(,R2)               LESS ALTERNATE CYLS     18JUN92
         MH    R1,2284+4+4+2(,R11)      TIME TRK/CYL            16JUN92
         STCM  R1,B'1111',1086(R11)     SAVE MAX REL-TRACK      16JUN92
*   END  OF NEW CODE FOR DEVTYPE USAGE                          16JUN92
***********************************************************************
         ST    R7,1596(,R11)
         MVI   1596(R11),X'80'
         LA    R1,1596(,R11)
         SVC   64                          RDJFCB
         TM    2938(R11),X'E0'
         BNZ   A000260
         TM    2943(R11),X'80'
         BZ    A000268
A000260  NI    2939(R11),X'BF'
A000268  NI    2942(R11),X'EF'
         MVI   1618(R11),X'FF'
*        LA    R15,2140(R11)            *** REPLACED VIA ZAP8
         LA    R15,2140(,R11)           *** PATCH FROM X270 -|
         L     R1,1136(,R11)            GET ADDRESS OF UCB   | ZAP8
         MVC   11(3,R15),13(R1)         MOVE IN UCB NAME    -|
**            R5 -> JFCB
A000274  MVC   3(6,R15),118(R5)         MOVE IN VOLSER FROM JFCB
         MVC   1112(6,R11),118(R5)
         MVI   2284(R11),C'0'
         MVC   2285(132,R11),1624(R11)
         MVI   87(R5),X'08'             SET "SHARED DATASET"
         MVI   52(R5),X'08'             SET "DO NOT WRITE JFCB"
         TM    2939(R11),X'40'
         BO    A000A50
         TM    2943(R11),X'40'
         BO    A000988
A0002A8  MVI   0(R5),X'04'              SET VTOC
         MVC   1(43,R5),0(R5)              DATASET NAME
         LA    R15,2284(,R11)
         MVC   1446(6,R11),118(R5)
         MVC   23(37,R15),1416(R11)
         MVC   3584(6,R11),118(R5)      SAVE VOLSER FROM JFCB
         ST    R7,1596(,R11)
         MVI   1596(R11),X'80'
         LA    R1,1596(,R11)
         SVC   22                          OPEN TYPE J
         LA    R1,136(,R11)
         ST    R1,1596(,R11)
         TM    2939(R11),X'04'
         BO    A0002F8
         TM    2940(R11),X'20'
         BO    A0002F8
         MVI   1596(R11),X'80'
         B     A000300
A0002F8  MVI   1596(R11),X'83'
A000300  LA    R1,1596(,R11)
         SVC   22                          OPEN TYPE J
         TM    48(R7),X'10'
         BZ    A000BB0
         TM    2938(R11),X'C0'
         BZ    A000330
         LA    R4,32
         BAL   R14,IMAP0100                PERFORM
         B     A000BB8
         LR    R9,R3
         S     R9,1040(,R11)
A000330  MVC   3220(28,R11),888(R11)
         LA    R2,3216(,R11)
         BAL   R14,IMAP05D8             PERFORM - SPC BLK 'VOL LABEL'
         TM    2937(R11),X'40'
         BO    A000378
         LA    R9,1104(,R11)
         LA    R8,1112(,R11)
         LA    R3,1136(,R11)
         LA    R1,792(,R11)
         MVI   1(R1),X'06'
         NI    2(R1),X'37'
         OI    2(R1),X'08'
         ST    R9,4(,R1)
         ST    R8,8(,R1)
         ST    R3,12(,R1)
         SVC   56                          ENQ/RESERVE
         OI    2941(R11),X'10'
*
*  HANDLE FORMAT 4 DSCB (SELF DESCRIBING RECORD)
*
A000378  L     R3,2932(,R11)
         LR    R9,R3
*        BAL   R14,IMAP0770                PERFORM - READ NEXT DSCB
*        B     A000B80                  ERROR EXIT
         BAL   R14,RDSCBNXT         READ NEXT (FIRST) DSCB      20AUG92
         LTR   R15,R15              ANY ERROR?                  20AUG92
         BNZ   A000B80              YES, ISSUE MESSAGE          20AUG92
         CLI   44(R9),C'4'              CHECK FOR FORMAT 4 DSCB
         BNE   A000BC0
         MVI   3371(R11),X'01'
         TM    2938(R11),X'04'
         BO    A000A08
         TM    2938(R11),X'02'
         BO    A000558
         TM    2943(R11),X'80'
         BO    A000558
*                                                               17JUN92
*  IS THIS "ACTIVE INDEX VTOC PACK" ??                          17JUN92
*                                                               17JUN92
         NI    BFGFLAG,255-BFIDXVT      CLEAR FLAG              20AUG92
         TM    58(R9),X'81'             ARE BOTH BITS ON        17JUN92
         BNO   B0001                    NO - SO NO REAL VTOC IDX17JUN92
         OI    BFGFLAG,BFIDXVT          FLAG ACTIVE INDEX       17JUN92
         B     A0003C8                  CONTINUE                17JUN92
B0001    DS    0H                                               17JUN92
*
*  IS "DOS" BIT ON - CONTAMINATED PACK
*
         TM    58(R9),X'80'
         BZ    A0003C8
         LA    R7,76
         BAL   R14,IMAP04B0                PERFORM - BUILD ERROR MSG
         MVI   1852(R11),X'60'
         BAL   R14,IMAP0328                PERFORM - OUTPUT LINE
         OI    2942(R11),X'01'
*
*  CREATE SPACE BLOCK FOR VTOC EXTENTS
*
A0003C8  MVC   3220(8,R11),107(R9)
         LA    R2,105(,R9)
         L     R15,AF13CNVT
         BALR  R14,R15                     STD LINKAGE
         ST    R0,3228(,R11)
         ST    R0,3292(,R11)
         LD    R0,3248(,R11)
         STD   R0,3240(,R11)
         IC    R14,106(,R9)
         STC   R14,3235(,R11)
         L     R14,952(,R11)
         ST    R14,3236(,R11)
         TM    2938(R11),X'C0'
         BZ    A000418
         LA    R4,32
         BAL   R14,IMAP0100                PERFORM
         B     A000B68
         LR    R9,R3
         S     R9,1040(,R11)
A000418  LA    R2,3216(,R11)
         BAL   R14,IMAP05D8                PERFORM - ADD SPACE BLK CHN
         MVI   3339(R11),X'01'        INDICATE 1 F4 DSCB READ
*
*  CREATE DSN BLOCK FOR FIRST F5 DSCB
*
         LA    R4,152
         BAL   R14,IMAP0100                PERFORM
         B     A000B68
         ST    R3,2976(,R11)          SET POINTER TO FIRST F5 DSCB
         ST    R3,2992(,R11)          SET POINTER TO LAST F5 DSCB
         LR    R10,R3
*
*  HANDLE FORMAT 5 DSCB'S - MAP FREE SPACE
*
*        BAL   R14,IMAP0770                PERFORM - READ NEXT DSCB
*        B     A000B8C
         BAL   R14,RDSCBNXT         READ NEXT (FIRST) DSCB      20AUG92
         LTR   R15,R15              ANY ERROR?                  20AUG92
         BNZ   A000B8C              YES, ISSUE MESSAGE          20AUG92
         CLI   44(R10),C'5'             CHECK FOR FORMAT 5 DSCB
         BNE   A000BD4
         MVI   3343(R11),X'01'          INDICATE 1 F5 DSCB READ
*                                                               17JUN92
*  A FORMAT 5 DSCB ALWAYS EXISTS, EVEN IF VTOC IS INDEXED.      17JUN92
*  NOW CHECK FOR ACTIVE INDEX, AND IF SO THEN PROCESS IT.       17JUN92
*                                                               17JUN92
         TM    BFGFLAG,BFIDXVT          IS VTOC INDEX ACTIVE    17JUN92
         BZ    A000480                  GO AND HANDLE OLD STYLE 17JUN92
         MVI   EXTNO,KF5+1              SET SIZE OF TABLE       17JUN92
         XC    EXTS(5),EXTS             START WITH A ZERO       07OCT92
B0002    DS    0H                       TOP OF LOOP - F5 BUILD  07OCT92
         LA    R4,INCVPL                                        20AUG92
         USING CVPL,R4                                          20AUG92
         MVC   CVLBL,=C'CVPL'           SET PLIST ID            17JUN92
         MVC   CVLTH,=AL2(CVPLNGTH)     SET PLIST LENGTH        17JUN92
         LA    R2,468(,R11)             POINT AT DCB            17JUN92
         L     R2,44(,R2)               GET DEB ADDRESS FROM DCB17JUN92
         CVAFDSM MF=(E,INCVPL),                                 20AUG92X
               DEB=(R2),                                        17JUN92X
               ACCESS=MAPDATA,                                  17JUN92X
               COUNT=NO,                                        17JUN92X
               MAP=VOLUME,                                      17JUN92X
               EXTENTS=EXTABL                                   17JUN92
         TM    CVFL1,CV1IVT             IS INDEX ACTIVE         17JUN92
         BZ    B0004                                            17JUN92
         LTR   R15,R15                  ANY ERROR               17JUN92
         BZ    B0003                    NO SO DO                17JUN92
         CH    R15,=H'4'                ERROR RETURN            17JUN92
         BNE   B0004                                            17JUN92
         CLI   CVSTAT,STAT032           END OF DATA             17JUN92
         DROP  R4                                               20AUG92
         BNE   B0004                                            17JUN92
B0003    DS    0H                                               17JUN92
         XC    0(140,R3),0(R3)          CLEAR FAKE DSCB         17JUN92
         MVC   DS5KEYID-DSCB(,R3),=X'05050505' SET KEY          17JUN92
         MVC   DS5AVEXT-DSCB(L'DS5AVEXT+L'DS5EXTAV,R3),EXTS     17JUN92
         MVI   DS5FMTID-DSCB(R3),C'5'                           17JUN92
         MVC   DS5MAVET-DSCB(,R3),EXTS+L'DS5AVEXT+L'DS5EXTAV    17JUN92
         LR    R10,R3                   SET DSCB PTR            17JUN92
         L     R15,AF5SPANA             GET ANALYSIS RTN        17JUN92
         BALR  R14,R15                                          17JUN92
         LA    R2,1                    --|  INCREMENT           07OCT92
         AL    R2,3372(,R11)             |   F5 DSCB PROCESSED  07OCT92
         ST    R2,3372(,R11)             |     COUNT            07OCT92
         ST    R2,3340(,R11)           --|  AND F5 READ COUNT   07OCT92
         NC  EXTS+L'EXTS-L'DS5AVEXT(L'DS5AVEXT),EXTS+L'EXTS-L'DS5AVEXT
         BZ    A000548                  ALL DONE SO EXIT        07OCT92
         MVC   EXTS(5),DS5MAVET-DSCB+L'DS5MAVET-L'DS5AVEXT(R3)  17JUN92
*                        MOVE IN LAST EXT FROM PREV F5 DSCB     17JUN92
         LA    R4,152                   SIZE OF BLOCK TO GET    07OCT92
         BAL   R14,IMAP0100                PERFORM - GET SPACE  07OCT92
         B     A000B68                  +0 - NO SPACE LEFT      07OCT92
         ST    R3,148(,R10)             CHAIN NEW BLOCK TO OLD  07OCT92
         LR    R10,R3                   SET POINTER             07OCT92
         B     B0002                    PROCESS NEXT SET OF EXTS07OCT92
B0004    DS    0H                       ERRORS                  17JUN92
         LA    R7,74*2                  GIVE MESSAGE NUMBER     17JUN92
         B     A000B58                  ISSUE MESSAGE AND ABORT 17JUN92
*
*  HANDLE VALID CHAIN OF F5 DSCB'S, RECORD FREE SPACE
*
A000458  LA    R4,152
         BAL   R14,IMAP0100                PERFORM - GET DSN SPACE
         B     A000B68
         ST    R3,148(,R10)
         LA    R2,135(,R10)
         LR    R4,R10
         LR    R10,R3
*        BAL   R14,IMAP078B                PERFORM - GET NEXT F5 DSCB
         BAL   R14,RDSCBDIR         GET NEXT F5 DSCB            20AUG92
         CLI   44(R10),C'5'
         BNE   A000C48
A000480  LA    R2,1                    --|  INCREMENT
         AL    R2,3372(,R11)             |      F5 DSCB PROCESSED
         ST    R2,3372(,R11)           --|           COUNT
         TM    2940(R11),X'20'
         BZ    A0004A8
         XC    4(131,R10),4(R10)
         MVI   44(R10),C'5'
         B     A0004B0
A0004A8  L     R15,AF5SPANA             BUILD SPACE BLKS FOR F5 DSCB
         BALR  R14,R15                     STD LINKAGE
A0004B0  CLC   135(5,R10),1504(R11)
         BNE   A000458
A0004C0  L     R9,2932(,R11)
         CLC   100(5,R9),1504(R11)
         BE    A000548
         LA    R4,152
         BAL   R14,IMAP0100                PERFORM
         B     A000B68
         ST    R3,2980(,R11)
         LR    R8,R3
         LA    R2,100(,R9)
         B     A000508
A0004F0  LA    R4,152
         BAL   R14,IMAP0100                PERFORM
         B     A000B68
         ST    R3,148(,R8)
         LA    R2,135(,R8)
         LR    R4,R8
         LR    R8,R3
*000508  BAL   R14,IMAP078B                PERFORM
A000508  BAL   R14,RDSCBDIR         GET NEXT F6 DSCB            20AUG92
         CLI   44(R8),C'6'
         BE    A000520
         TM    2939(R11),X'20'
         BZ    A000C2C
         B     A000C60
A000520  OI    2939(R11),X'20'
         L     R15,AF6SPANA
         BALR  R14,R15                     STD LINKAGE
         LA    R2,1
         AL    R2,3376(,R11)
         ST    R2,3376(,R11)
         CLC   135(5,R8),1504(R11)
         BNE   A0004F0
A000548  TM    2941(R11),X'08'
         BO    A000A40
         TM    2940(R11),X'40'
         BO    A0007E8
A000558  TM    2943(R11),X'80'
         BZ    A000570
         L     R3,2920(,R11)
         LR    R9,R3
         B     A000580
*
*  GET DSN+ BLOCK FOR F1 DSCB AND STUFF
*
A000570  LA    R4,200
         BAL   R14,IMAP0100                PERFORM
         B     A0007E8
         LR    R9,R3
*000580  BAL   R14,IMAP0770                PERFORM - READ NEXT DSCB
*        B     A0007E8
A000580  BAL   R14,RDSCBNXT         READ NEXT (FIRST) DSCB      20AUG92
         LTR   R15,R15              ANY ERROR?                  20AUG92
         BNZ   A0007E8              YES, ISSUE MESSAGE          20AUG92
         BAL   R14,A0007B0                 PERFORM - INCR DSCB TYPE CT
         TM    2941(R11),X'04'
         BZ    A0005A0
         L     R15,AVALIDAT
         BALR  R14,R15                     STD LINKAGE
A0005A0  CLI   44(R9),C'1'              TEST FOR FORMAT 1 DSCB
         BE    A0005D0
         TM    2939(R11),X'04'
         BZ    A000580
         TM    2939(R11),X'02'
         BO    A000580
         CLI   44(R9),X'00'
         BNE   A000580
         ST    R9,2964(,R11)
         OI    2939(R11),X'02'
         B     A000558
A0005D0  NI    2939(R11),X'FE'          HANDLE FORMAT 1 DSCB
         LA    R1,1                     ---|
         AL    R1,3284(,R11)               | INCREMENT DATASET CNT
         ST    R1,3284(,R11)            ---|
         TM    2938(R11),X'02'
         B     A0005F0
         TM    82(R9),X'02'             PO FORMAT ?
         BZ    A000580
A0005F0  L     R2,2900(,R11)
         LA    R3,2748(,R11)
         TM    2943(R11),X'80'
         BO    A000720
*
*  CHAIN BLOCK BY DSN ALPHABETICALLY
*
A000600  CLC   0(44,R9),0(R2)
         BL    A000618
         LR    R3,R2
         L     R2,152(R2)
         B     A000600
A000618  ST    R2,152(,R9)
         ST    R9,152(R3)
*
         TM    2943(R11),X'80'
         BZ    A000670
         MVC   168(6,R9),1096(R11)
         LD    R0,3592(,R11)            GET DEVICE NAME (FROM CATDEV)
         STD   R0,176(,R9)              SAVE IT IN DSN BLOCK
         LD    R0,1624(,R11)
         STD   R0,160(,R9)
         LA    R0,8
         LA    R14,0(,R9)
         LA    R15,160(,R9)
         LA    R1,1
A000650  CLI   0(R14),X'4B'
         BE    A000670
         CLI   0(R14),C' '
         BE    A000670
         IC    R3,0(R14)
         STC   R3,0(R15)
         ALR   R14,R1
         ALR   R15,R1
         BCT   R0,A000650
A000670  CLC   135(5,R9),1504(R11)      DOES F2 OR F3 CHAIN EXIST
         BE    A000558                  NO - ALL DONE
*
*  READ IN ASSOCIATED F2 OR F3 DSCB
*
A000680  LA    R4,152
         BAL   R14,IMAP0100                PERFORM
         B     A0007E8
         LR    R10,R3
         LA    R2,135(,R9)
*        BAL   R14,IMAP078B                PERFORM
         BAL   R14,RDSCBDIR         GET EITHER F2 OR F3 DSCB    20AUG92
         CLI   44(R10),C'3'
         BE    A0006F8
         CLI   44(R10),C'2'
         BNE   A000BE8
         LR    R8,R10
         LA    R2,1
         AL    R2,3360(,R11)
         ST    R2,3360(,R11)
         ST    R8,148(,R9)
         CLC   135(5,R8),1504(R11)
         BE    A000558
         LA    R4,152
         BAL   R14,IMAP0100                PERFORM
         B     A0007E8
         LR    R10,R3
         LA    R2,135(,R8)
*        BAL   R14,IMAP078B                PERFORM
         BAL   R14,RDSCBDIR         GET REAL F3 DSCB            20AUG92
         CLI   44(R10),C'3'
         BNE   A000C10
         ST    R10,148(,R8)
         B     A0006FC
A0006F8  ST    R10,148(,R9)             CHAIN TO F1 (OR PREV F3) BLK
A0006FC  LA    R2,1                     ---|
         AL    R2,3364(,R11)               | INCR COUNT OF F3 BLKS
         ST    R2,3364(,R11)            ---|
         OI    2939(R11),X'01'
         CLC   135(5,R10),1504(R11)     ANY MORE F2/F3 BLOCKS
         BE    A000558                  NO - DONE
         LR    R9,R10                   YES - MAKE CURRENT PREVIOUS
         B     A000680                  DO IT AGAIN
A000720  CLC   0(44,R9),0(R2)
         BE    A000740
         BL    A000770
A000730  LR    R3,R2
         L     R2,152(R2)
         B     A000720
A000740  CLC   184(6,R2),3584(R11)
         BNE   A000730
         MVC   44(96,R2),44(R9)
         LR    R9,R2
         OI    174(R9),X'40'            SET "GOOD" DATASET
         MVC   168(6,R9),3584(R11)      SET VOLSER
         MVC   176(6,R9),3592(R11)      SET DEVICE NAME (FROM CATDEV)
         MVC   192(6,R9),3592(R11)      SET DEVICE NAME (FROM CATDEV)
         B     A000670
A000770  TM    2943(R11),X'20'
         BO    A000558                                          13JUL92
         STM   R2,R3,152(R9)               SAVE REGS
         LA    R4,200
         BAL   R14,IMAP0100                PERFORM
         B     A0007E8
         MVC   0(140,R3),0(R9)
         LR    R1,R9
         LR    R9,R3
         OI    174(R9),X'60'            SET "NOT CATALOGED"
         MVC   184(6,R9),3584(R11)      SET VOLSER
         MVC   192(6,R9),3592(R11)      SET DEVICE NAME (FROM CATDEV)
         LM    R2,R3,152(R1)               RESTORE REGS
         STD   R4,152(R1)
         B     A000618
*
*  INCREMENT COUNT OF DSCBS READ BY DSCB TYPE
*
A0007B0  CLI   44(R9),C'6'
         BNH   A0007C8
         LA    R0,1                     --|
         AL    R0,3348(,R11)              | INCREMENT UNKNOWN COUNT
         ST    R0,3348(,R11)            --|
         BR    R14                         EXIT
A0007C8  IC    R15,44(,R9)
         LA    R0,7
         NR    R15,R0
         ALR   R15,R15
         ALR   R15,R15
         LA    R0,1                     --|
         AL    R0,3320(R15,R11)           | INCREMENT COUNT OF TYPE
         ST    R0,3320(R15,R11)         --|
         BR    R14                         EXIT
*
**       END OF DSCBS REACHED, END OF PROCESSING
*
A0007E8  EQU   *
         TM    2939(R11),X'04'
         BO    A000808
         BAL   R14,IMAP0A48                PERFORM
         BAL   R15,IMAP0560                PERFORM
         TM    2941(R11),X'10'
         BZ    A000808
         BAL   R14,IMAP0A88                PERFORM
A000808  TM    2943(R11),X'80'
         BO    A000870
         TM    2938(R11),X'04'
         BO    A000970
         TM    2941(R11),X'08'
         BO    A000970
A000820  L     R15,AMAPEDIT
         BALR  R14,R15                     STD LINKAGE
         TM    2938(R11),X'02'
         BO    A000970
         TM    2943(R11),X'80'
         BO    A000970
         TM    2941(R11),X'04'
         BZ    A000848
         L     R15,AVAL2AND
         BALR  R14,R15                     STD LINKAGE
A000848  TM    2939(R11),X'04'
         BZ    A000970
         XC    2938(6,R11),2938(R11)
         LD    R0,A000C70
         STD   R0,2648(,R11)
         LA    R14,MAPER
         L     R15,AMAPCORE
         BR    R15
A000870  TM    2938(R11),X'04'
         BZ    A0008A0
         L     R2,3616(,R11)
         LTR   R2,R2
         BZ    A00089C
A000888  TM    22(R2),X'80'
         BZ    A0008C0
         L     R2,0(,R2)
         LTR   R2,R2
         BNZ   A000888
A00089C  NI    2938(R11),X'FB'
*
**       CYCLE TO NEXT VOLUME TO PROCESS
A0008A0  L     R2,2888(,R11)            GET HEAD OF DDNS CHAIN
         LTR   R2,R2                    ANY THERE?              04AUG92
         BZ    A0008D8                  NOPE, EXIT              04AUG92
A0008A4  TM    22(R2),X'80'             HAS THIS ONE BEEN PROCESSED?
         BZ    A0008C0                  NO, GO AND PROCESS IT
         L     R2,0(,R2)                CHAIN TO NEXT
         LTR   R2,R2                    ANY NEXT ??
         BNZ   A0008A4                  LOOP WITH NEXT DDNS
         B     A0008D8                  NO MORE TO DO SO EXIT
*
**       MARK NEW VOLUME AS PROCESSED AND GO TO IT
*
A0008C0  OI    22(R2),X'80'             MARK AS PROCESSED
         MVC   1096(6,R11),16(R2)       MOVE NEW VOLSER
         MVC   2752(44,R11),1624(R11)
***      B     A000198                  -|
***      NOPR  R0                        |REPLACED BY ZAP1
***      NOPR  R0                       -|
         EX    R0,A0009B4               -|REPLACEMENT OF ZAP1
         B     A000198                  -|
         EJECT
*
**       ALL VOLUMES PROCESSED FOR THIS REQUEST CARD, RESET PROCESSED
**       INDICATOR AND GO GET A NEW REQUEST CARD
*
A0008D8  L     R2,2888(,R11)            GET HEAD OF DDNS CHAIN
         LTR   R2,R2                    ANY THERE?              04AUG92
         BZ    A0008F4                  NOPE, EXIT              04AUG92
A0008E0  NI    22(R2),X'7F'             RESET PROCESSED INDICATOR
         L     R2,0(,R2)                GET NEXT CHAIN
         LTR   R2,R2                    ANY NEXT ??
         BNZ   A0008E0                  YES, SO PROCESS IT
A0008F4  DS    0H                                               04AUG92
*
**       ???????
*
         L     R9,2900(,R11)
A0008F8  CLC   0(44,R9),1552(R11)
         BE    A000958
         TM    174(R9),X'40'
         BZ    A000918
         L     R9,152(,R9)
         B     A0008F8
A000918  L     R2,2888(,R11)
         LTR   R2,R2                    ANY THERE?              04AUG92
         BZ    A000921                  NOPE, EXIT              04AUG92
A000920  CLC   16(6,R2),184(R9)
         BE    A000948
         L     R2,0(,R2)
         LTR   R2,R2
         BNZ   A000920
A000921  DS    0H                                               04AUG92
         OI    174(R9),X'10'
         L     R9,152(,R9)
         B     A0008F8
A000948  OI    174(R9),X'08'
         L     R9,152(,R9)
         B     A0008F8
A000958  LA    R15,2140(,R11)
         MVC   3(6,R15),3600(R11)
         B     A000820
A000968  L     R15,AMAPEDIT
         BALR  R14,R15                     STD LINKAGE
*
**       MAIN EXIT FROM MAPINIT BACK TO IEHMAP
**       THIS EXIT IS TAKEN WHEN ALL PROCESSING IS DONE FOR THIS CARD
*
A000970  TM    2942(R11),X'01'          HAS AN ERROR OCCURED
         BZ    IMAP0088                 NO - JUST EXIT
         LA    R7,80                    INDICATE ERROR W/ MSG 40
         LA    R14,IMAP0088
         B     IMAP0490
         SPACE 2
A000988  TM    2939(R11),X'04'
         BO    A000998
         TM    2940(R11),X'20'
         BZ    A0002A8
A000998  LA    R7,2
         LA    R14,IMAP0088
         B     IMAP0490
A0009A8  MVC   2800(44,R11),2752(R11)
         MVC   2752(44,R11),1624(R11)
A0009B4  MVC   2752(7,R11),1120(R11)
         NI    2939(R11),X'BB'
         NI    2941(R11),X'FB'
         CLI   1096(R11),C' '
         BNE   A0009F8
         L     R2,3616(,R11)
         LTR   R2,R2
         BZ    A0009E8
         MVC   1096(6,R11),16(R2)
         OI    22(R2),X'80'
         B     A0009F8
A0009E8  L     R1,1140(,R11)
         MVC   1096(6,R11),28(R1)
A0009F8  MVC   3600(6,R11),1096(R11)
         B     A000198
A000A08  L     R2,608(,R11)
         TM    2941(R11),X'10'
         BZ    A000A18
         BAL   R14,IMAP0A88                PERFORM
A000A18  BAL   R14,IMAP0A48                PERFORM
         L     R15,AMAPCATL
         MVC   0(44,R2),2752(R11)
         BALR  R14,R15                     STD LINKAGE
         TM    2943(R11),X'80'
         BZ    A0007E8
         LTR   R15,R15
         BNZ   A000970
         B     A0007E8
A000A40  L     R15,AMAPCCHH
         LA    R14,A0007E8
         BR    R15
A000A50  TM    2941(R11),X'10'
         BZ    A000A60
         BAL   R14,IMAP0A88                PERFORM
         BAL   R14,IMAP0A48                PERFORM
A000A60  L     R2,608(,R11)
         MVC   0(44,R2),2752(R11)
         LA    R1,840(,R11)
         SVC   27                          OBTAIN
         LTR   R15,R15
         BNZ   A000B2C
         L     R9,2920(,R11)
         XC    0(200,R9),0(R9)
         MVC   0(44,R9),2752(R11)
         L     R15,820(,R11)
         MVC   44(96,R9),0(R15)
         MVC   143(5,R9),96(R15)
         LA    R15,2140(,R11)
         MVC   3(6,R15),118(R2)
         LA    R7,20
         ST    R7,1620(,R11)
         OI    1620(R11),X'80'
         L     R10,2928(,R11)
         CLC   135(5,R9),1504(R11)
         BE    A000968
         MVC   2952(5,R11),135(R9)
         LA    R1,824(,R11)
         SVC   27                          OBTAIN
         LTR   R15,R15
         BNZ   A000B2C
         ST    R10,148(,R9)
         L     R15,820(,R11)
         MVC   0(140,R10),0(R15)
         MVC   143(5,R10),2952(R11)
         CLI   44(R10),C'3'
         BE    A000968
         L     R8,2924(,R11)
         MVC   0(140,R8),0(R10)
         MVC   143(5,R8),2952(R11)
         ST    R8,148(,R9)
         CLC   135(5,R8),1504(R11)
         BE    A000968
         MVC   2952(5,R11),135(R8)
         LA    R1,824(,R11)
         SVC   27                          OBTAIN
         LTR   R15,R15
         BNZ   A000B2C
         L     R15,820(,R11)
         MVC   0(140,R10),0(R15)
         MVC   143(5,R10),2952(R11)
         B     A000968
A000B2C  SRL   R15,2
         LA    R7,23(R15)
         SLL   R7,1
         BAL   R14,IMAP0490                PERFORM
         B     A000B68
A000B40  SRL   R15,2
         LA    R7,16(R15)
         SLL   R7,1
         BAL   R14,IMAP0490                PERFORM
         B     IMAP0088
A000B58  NI    2939(R11),X'FB'
         BAL   R14,IMAP0490                PERFORM
A000B68  BAL   R14,IMAP0A48                PERFORM
         TM    2941(R11),X'10'
         BZ    IMAP0088
         BAL   R14,IMAP0A88                PERFORM
         B     IMAP0088
A000B80  LA    R7,58
         BAL   R14,IMAP0490                PERFORM
         B     A000B68
A000B8C  LA    R7,60
         BAL   R14,IMAP0490                PERFORM
         B     A000B68
A000B98  LA    R7,18
         B     A000B58
A000BA0  LA    R7,20
         B     A000B58
A000BA8  LA    R7,22
         B     A000B58
A000BB0  LA    R7,24
         B     A000B58
A000BB8  NI    2939(R11),X'FB'
         B     A000B68
A000BC0  LA    R7,26
         BAL   R14,IMAP0490                PERFORM
         LR    R2,R9
         BAL   R14,IMAP08C0                PERFORM
         B     A000B68
A000BD4  LA    R7,28
         BAL   R14,IMAP0490                PERFORM
         LR    R2,R10
         BAL   R14,IMAP08C0                PERFORM
         B     A000B68
A000BE8  LA    R7,8
         TM    2939(R11),X'01'
         BO    A000C1E
         BAL   R14,IMAP0490                PERFORM
         LR    R2,R9
A000C00  BAL   R14,IMAP08C0                PERFORM
         LR    R2,R10
         BAL   R14,IMAP08C0                PERFORM
         B     A000558
A000C10  LA    R7,10
         BAL   R14,IMAP0490                PERFORM
         LR    R2,R8
         B     A000C00
A000C1E  LA    R7,66
         BAL   R14,IMAP0490                PERFORM
         LR    R2,R9
         B     A000C00
A000C2C  LA    R7,12
         BAL   R14,IMAP0490                PERFORM
         LR    R2,R9
A000C38  BAL   R14,IMAP08C0                PERFORM
         LR    R2,R8
         BAL   R14,IMAP08C0                PERFORM
         B     A000548
A000C48  LA    R7,78
         BAL   R14,IMAP0490                PERFORM
         LR    R2,R4
         BAL   R14,IMAP08C0                PERFORM
         LR    R2,R10
         BAL   R14,IMAP08C0                PERFORM
         B     A0004C0
A000C60  LA    R7,62
         BAL   R14,IMAP0490                PERFORM
         LR    R2,R4
         B     A000C38
         DC    H'0001'
A000C70  DS    0D
         DC    C'TRACKS  '
RTXT1    DC    AL2(DALVLSER,1,6),CL6' '                         02JUL92
         DC    AL2(DALUNIT,1,8),CL8'SYSALLDA' UNIT=SYSALLDA     02JUL92
         DC    AL2(DALSTATS,1,1),X'01'        DISP=OLD          02JUL92
         DC    AL2(DALRTDDN,1,8),CL8' '       RETURN DDNAME     02JUL92
TXTLEN   EQU   *-RTXT1                                          02JUL92
         EJECT                                                  20AUG92
         COPY  MAPINITA                                         20AUG92
         EJECT                                                  20AUG92
         REQU
         COPY  EXTREFS
         COPY  WORKAREA                                         17JUN92
WRK      DSECT                                                  02JUL92
DDNBLK   DS    0F,XL48          SPACE FOR IEHMAP DDNAME BLK     02JUL92
PLIST    DS    F                                                02JUL92
DYRB     DS    XL(S99RBEND-S99RB)                               02JUL92
TXTUP    DS    4F                                               02JUL92
TXT1     DS    AL2(DALVLSER,1,6),CL6' '                         02JUL92
TXT2     DS    AL2(DALUNIT,1,8),CL8'SYSALLDA' UNIT=SYSALLDA     02JUL92
TXT3     DS    AL2(DALSTATS,1,1),X'01'        DISP=OLD          02JUL92
TXT4     DS    AL2(DALRTDDN,1,8),CL8' '       RETURN DDNAME     02JUL92
WRKLEN   EQU   *-WRK                                            02JUL92
         PRINT NOGEN                                            02JUL92
         IEFZB4D0                                               02JUL92
         IEFZB4D2                                               02JUL92
         END
